@{
    ViewData["Title"] = "Nuevo Pedido de Servicio";
}

<div class="card d-none" id="efec-cargando">
    <div class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center overlay dark" style="z-index: 9999; background: rgba(0,0,0,0.5);">
        <i class="fas fa-3x fa-sync-alt fa-spin text-white"></i>
    </div>
</div>

<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-11">

            <div class="card shadow mb-4 border-left-info">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-tools"></i> Generar Pedido de Servicio</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label>Fecha Emisión</label>
                            <input type="date" id="dtp_FechaEmision" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="font-weight-bold text-danger">Fecha Necesaria (*)</label>
                            <input type="date" id="dtp_FechaNecesaria" class="form-control" value="@DateTime.Now.AddDays(2).ToString("yyyy-MM-dd")">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label>Centro de Costo (Solicitante) (*)</label>
                            <select id="cbx_CentroCosto" class="form-control select2-busqueda"></select>
                        </div>
                        <div class="col-md-8 mb-3">
                            <label>Observación General</label>
                            <input type="text" id="txt_Observacion" class="form-control" placeholder="Ej: Servicio de mantenimiento correctivo...">
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow mb-4">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Servicios Solicitados</h5>
                    <button type="button" class="btn btn-warning font-weight-bold text-dark" onclick="abrirModalReq()">
                        <i class="bi bi-search"></i> BUSCAR REQUERIMIENTOS APROBADOS
                    </button>
                </div>
                <div class="card-body bg-light">

                    <div class="table-responsive mt-3">
                        <table id="tbl_Detalle" class="table table-bordered table-hover text-center bg-white shadow-sm">
                            <thead class="thead-dark">
                                <tr>
                                    <th style="width: 50px;">Item</th>
                                    <th>Descripción Servicio</th>
                                    <th style="width: 80px;">U.M.</th>
                                    <th style="width: 100px;">Cant.</th>
                                    <th>Observación Item</th>
                                    <th style="width: 60px;"></th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="text-right mb-5">
                <a href="/PedServicio/Index" class="btn btn-danger btn-lg mr-2"><i class="bi bi-x-circle"></i> Cancelar</a>
                <button id="btn_GuardarTodo" class="btn btn-info btn-lg"><i class="bi bi-save"></i> REGISTRAR PEDIDO</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalReq" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title text-dark font-weight-bold">Seleccionar Requerimientos de Servicio</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-striped table-bordered text-center">
                        <thead class="thead-light">
                            <tr>
                                <th style="width: 50px;">Sel.</th>
                                <th>N° Requerimiento</th>
                                <th>Fecha</th>
                                <th>Solicitante</th>
                                <th>Observación</th>
                            </tr>
                        </thead>
                        <tbody id="tblReqBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary font-weight-bold" onclick="cargarServiciosDeReq()">
                    <i class="bi bi-download"></i> Cargar Servicios
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    var LISTA_DETALLE = [];

    $(document).ready(function () {
        $('.select2-busqueda').select2({ theme: 'bootstrap4', width: '100%', placeholder: '-- Seleccione --' });
        fct_InitCombos();

        // Guardar
        $("#btn_GuardarTodo").click(function () {
            if (LISTA_DETALLE.length === 0) return Swal.fire("Error", "Debe agregar servicios desde los requerimientos.", "error");
            if (!$("#cbx_CentroCosto").val()) return toastr.warning("El Centro de Costo es obligatorio.");
            if (!$("#dtp_FechaNecesaria").val()) return toastr.warning("La fecha necesaria es obligatoria.");

            let cabecera = {
                FechaEmision: $("#dtp_FechaEmision").val(),
                FechaNecesaria: $("#dtp_FechaNecesaria").val(),
                CentroCostoId: parseInt($("#cbx_CentroCosto").val()),
                Observacion: $("#txt_Observacion").val()
            };

            Swal.fire({
                title: "¿Registrar Pedido?",
                text: "Se generará el pedido de servicio.",
                icon: "question",
                showCancelButton: true,
                confirmButtonText: "Sí, Registrar"
            }).then((result) => {
                if (result.isConfirmed) {
                    ShowSpinner();
                    $.ajax({
                        url: "/PedServicio/GuardarPedido",
                        type: "POST",
                        data: {
                            cabecera: cabecera,
                            detallesJson: JSON.stringify(LISTA_DETALLE)
                        },
                        success: function (res) {
                            if (res.status) {
                                Swal.fire("¡Registrado!", res.message, "success").then(() => {
                                    window.location.href = "/PedServicio/Index";
                                });
                            } else {
                                Swal.fire("Error", res.message, "error");
                            }
                            HideSpinner();
                        },
                        error: function () {
                            toastr.error("Error de conexión.");
                            HideSpinner();
                        }
                    });
                }
            });
        });
    });

    // --- LÓGICA MODAL ---
    function abrirModalReq() {
        $('#tblReqBody').html('<tr><td colspan="5">Cargando...</td></tr>');
        $('#modalReq').modal('show');

        // URL apunta a PedServicio
        $.get('/PedServicio/GetRequerimientosAprobados', function(res) {
            if(res.status) {
                let html = '';
                if(res.data.length === 0) {
                    html = '<tr><td colspan="5" class="text-muted">No hay requerimientos aprobados.</td></tr>';
                } else {
                    res.data.forEach(r => {
                        html += `
                        <tr>
                            <td><input type="checkbox" class="chk-req" value="${r.id}"></td>
                            <td class="font-weight-bold">${r.numero}</td>
                            <td>${r.fecha}</td>
                            <td>${r.solicitante}</td>
                            <td class="text-left small">${r.observacion || '-'}</td>
                        </tr>`;
                    });
                }
                $('#tblReqBody').html(html);
            }
        });
    }

    function cargarServiciosDeReq() {
        let ids = [];
        $('.chk-req:checked').each(function() {
            ids.push(parseInt($(this).val()));
        });

        if(ids.length === 0) return toastr.warning("Seleccione al menos un requerimiento.");

        ShowSpinner();

        $.ajax({
            url: '/PedServicio/GetDetallesBatch', // API PedServicio
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(ids),
            success: function(res) {
                if(res.status) {
                    res.data.forEach(d => {
                        LISTA_DETALLE.push({
                            Item: (LISTA_DETALLE.length + 1).toString().padStart(3, '0'),
                            ProductoId: d.productoId,
                            Descripcion: d.descripcion, // El nombre del servicio
                            UnidadMedida: d.unidadMedida,
                            CantidadSolicitada: d.cantidad,
                            ObservacionItem: d.observacionItem,
                            ReferenciaId: d.referenciaId
                        });
                    });

                    fct_RenderDetalle();
                    $('#modalReq').modal('hide');
                    toastr.success("Servicios agregados.");
                } else {
                    toastr.error(res.message);
                }
                HideSpinner();
            },
            error: function() { HideSpinner(); toastr.error("Error al cargar detalles."); }
        });
    }

    // --- RENDER TABLA ---
    function fct_RenderDetalle() {
        let html = "";
        LISTA_DETALLE.forEach((d, index) => {
            html += `<tr>
                <td class="align-middle font-weight-bold">${d.Item}</td>
                <td class="align-middle text-left">${d.Descripcion}</td>
                <td class="align-middle">${d.UnidadMedida}</td>
                <td class="align-middle font-weight-bold" style="font-size: 1.1rem;">${d.CantidadSolicitada.toFixed(2)}</td>
                <td class="align-middle text-left small text-muted">${d.ObservacionItem || '-'}</td>
                <td class="align-middle">
                    <button class="btn btn-sm btn-outline-danger border-0" onclick="fct_EliminarDetalle(${index})" title="Quitar">
                        <i class="bi bi-trash-fill"></i>
                    </button>
                </td>
            </tr>`;
        });

        if(LISTA_DETALLE.length === 0) html = '<tr><td colspan="6" class="text-center py-3 text-muted">Haga clic en "Buscar Requerimientos" para agregar servicios.</td></tr>';

        $("#tbl_Detalle tbody").html(html);
    }

    function fct_EliminarDetalle(index) {
        LISTA_DETALLE.splice(index, 1);
        LISTA_DETALLE.forEach((d, i) => d.Item = (i + 1).toString().padStart(3, '0'));
        fct_RenderDetalle();
    }

    function fct_InitCombos() {
        // Cargar Centros de Costo (Apunta a PedCompraController o puedes duplicar el método en PedServicioController)
        // Como es un combo genérico, usaremos la ruta que sabemos que existe:
        $.getJSON('/PedServicio/GetCentrosCosto', function (res) {
            let h = '<option value="">-- SELECCIONE --</option>';
            if(res.status) res.data.forEach(x => h += `<option value="${x.id}">${x.codigo} - ${x.nombre}</option>`);
            $('#cbx_CentroCosto').html(h);
        });
    }

    function ShowSpinner() { $('#efec-cargando').removeClass('d-none'); }
    function HideSpinner() { $('#efec-cargando').addClass('d-none'); }

</script>