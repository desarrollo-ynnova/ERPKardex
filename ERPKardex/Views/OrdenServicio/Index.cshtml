@{
    ViewData["Title"] = "Órdenes de Servicio";
}

<div class="container-fluid py-4">
    <div class="card shadow">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Bandeja de Órdenes de Servicio</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover table-bordered" id="tbl_Ordenes" width="100%">
                    <thead class="thead-light text-center">
                        <tr>
                            <th>Número</th>
                            <th>F. Emisión</th>
                            <th>Proveedor</th>
                            <th>Moneda</th>
                            <th>Total</th>
                            <th>Estado</th>
                            <th>Estado Pago</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalDetalle" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white py-2">
                <h6 class="modal-title">Detalle del Servicio</h6>
                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body p-0">
                <table class="table table-sm table-striped mb-0 text-center">
                    <thead class="bg-light">
                        <tr>
                            <th>Item</th>
                            <th>Descripción</th>
                            <th>Lugar</th>
                            <th>Cant.</th>
                            <th>Precio</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="tblBodyDetalle"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        var windowHeight = $('body > div.wrapper > div.content-wrapper').height() / 2;
        //CONFIGURACION POR DEFECTO DATATABLES
        $.extend($.fn.dataTable.defaults, {
            dom: "<'row align-items-center'<'col-sm-8 justify-content-start'f><'col-sm-4 c1 d-flex justify-content-end'>>" + "<'row align-items-center'<'col-sm-6'l><'col-sm-6 my-3 justify-content-start d-flex'B>" + "<'col-sm-6'i><'col-sm-6 mb-3 d-flex justify-content-end'p>" + "rt" + "<'col-sm-6'i><'col-sm-6 mt-1 d-flex justify-content-end'p>",
            // dom: "<'row pb-1'<'col-sm-9 d-flex'B><'col-sm-3 c1 d-flex justify-content-end'>>" + "<'row'<'col-sm-4'l><'col-sm-8 justify-content-start'f>>" + "<'row'<'col-sm-6'i><'col-sm-6 d-flex justify-content-end'p>>" + "rt" + "<'row'<'col-sm-6'i><'col-sm-6 mt-1 d-flex justify-content-end'p>>",
            // dom: "<'row pb-1'<'col-sm-9'B><'col-sm-3 c1 d-flex justify-content-end'>>" + "<'row'<'col-sm-10'l><'col-sm-2'f>>" + "<'row'<'col-sm-6'i><'col-sm-6'p>>" + "rt" + "<'row'<'col-sm-6'i><'col-sm-6'p>>",
            // dom: "<'row pb-1'<'col-sm-10'B><'col-sm-2 c1 d-flex justify-content-end'>>" + "<'row'<'col-sm-11'l><'col-sm-1'f>>" + "<'row'<'col-sm-10'i><'col-sm-2'p>>" + "rt" + "<'row'<'col-sm-10'i><'col-sm-2'p>>",
            paging: true,
            select: true,
            scroller: false,
            deferRender: true,
            scrollY: windowHeight,
            scrollX: true,
            fixedHeader: true,
            ordering: true,
            destroy: true,
            responsive: true,
            autoWidth: false,
            processing: true,
            filter: true,
            orderMulti: true,
            stateSave: false,
            serverSide: false,
            language: {
                processing: "Procesando...",
                sSearch: "Buscar:",
                lengthMenu: "Mostrar _MENU_ registros",
                info: "Mostrando del _START_ al _END_ de un total de _TOTAL_ registros",
                infoEmpty: "Sin registros encontrados.",
                infoFiltered: "(Total de _MAX_ registros filtrados)",
                loadingRecords: "Cargando...",
                zeroRecords: "No se encontraron registros",
                emptyTable: "No hay datos disponibles en la tabla",
                paginate: {
                    previous: "Anterior",
                    next: "Siguiente",
                    first: "Primero",
                    last: "Último",
                },
                aria: {
                    sortAscending: ": Activar para ordenar la columna de manera ascendente",
                    sortDescending: ": Activar para ordenar la columna de manera descendente"
                },
                select: {
                    rows: {
                        _: "%d filas seleccionadas",
                        0: "Haz clic en una fila para seleccionarla",
                        1: "1 fila seleccionada"
                    }
                },
                buttons: {
                    copyTitle: 'Copiado en el portapapeles',
                    copyKeys: 'Presiona <i>ctrl</i> o <i>\u2318</i> + <i>C</i> para copiar los datos de la tabla a tu portapapeles. <br><br>Para cancelar, haga clic en este mensaje o presione Esc.',
                    copySuccess: {
                        _: '%d registros copiados correctamente',
                        1: '1 registro copiado correctamente'
                    }
                }
            },
            lengthMenu: [[100, 200, 500, -1], [100, 200, 500, 'Todos']],
        });

        cargarOrdenes();
    });

    function cargarOrdenes() {
        $('#tbl_Ordenes').DataTable({
            buttons: [
                {
                    extend: 'copy',
                    text: '<i class="bi bi-back"></i>',
                    titleAttr: 'Copiar en portapapeles',
                    className: 'btn btn-primary',
                },
                {
                    extend: 'excel',
                    text: '<i class="bi bi-file-earmark-excel"></i>',
                    titleAttr: 'Exportar a Excel',
                    className: 'btn btn-success',
                    filename: 'Órdenes de Servicio ' + moment().format('DD-MM-YYYY HH_mm'),
                    footer: true,
                    exportOptions:
                    {
                        stripHtml: true,
                        columns: ':not(:last-child)'
                    },
                },
                {
                    extend: 'pdf',
                    text: '<i class="bi bi-file-earmark-pdf"></i>',
                    titleAttr: 'Exportar a PDF',
                    className: 'btn btn-danger',
                    filename: 'Órdenes de Servicio ' + moment().format('DD-MM-YYYY HH_mm'),
                    exportOptions:
                    {
                        stripHtml: true,
                        columns: ':not(:last-child)'
                    },
                    orientation: 'landscape',
                    pageSize: 'LEGAL',
                },
                {
                    extend: 'print',
                    text: '<i class="bi bi-printer-fill"></i>',
                    titleAttr: 'Imprimir',
                    className: 'btn btn-info',
                    exportOptions:
                    {
                        stripHtml: true,
                        columns: ':not(:last-child)'
                    },
                },
                {
                    extend: 'colvis',
                    text: '<i class="bi bi-ui-checks"></i>',
                    titleAttr: 'Seleccionar',
                    className: 'btn btn-warning',
                    columns: ':not(.noVis)',
                },
                {
                    text: ' <i class= "bi bi-plus-circle" style="margin-right: 5px;"></i>Nueva OS',
                    className: 'btn bg-info m-1',
                    titleAttr: 'Nuevo',
                    action: function (e, dt, node, config) {
                        window.location.href = '/OrdenServicio/Registrar';
                    },
                },
            ],
            ajax: { url: '/OrdenServicio/GetOrdenesData', type: 'GET' },
            columns: [
                { data: 'numero', className: 'font-weight-bold' },
                { data: 'fecha' },
                {
                    data: 'proveedor',
                    render: function(data, type, row) {
                        return `<div style="line-height:1.2"><small class="text-muted">${row.ruc}</small><br>${data}</div>`;
                    }
                },
                { data: 'moneda' },
                {
                    data: 'total', className: 'text-right',
                    render: $.fn.dataTable.render.number(',', '.', 2, '')
                },
                {
                    data: 'estado', className: 'text-center',
                    render: function(data) {
                        let color = data === 'Generado' ? 'warning' : (data === 'Aprobado' ? 'success' : 'danger');
                        return `<span class="badge badge-${color}">${data}</span>`;
                    }
                },
                {
                    data: 'estadoPago',
                    className: 'text-center',
                    title: 'Estado Pago', // Título de la columna
                    render: function(data) {
                        // Validación por si viene nulo en registros viejos
                        if (!data) return '<span class="badge badge-secondary">Pendiente</span>';

                        let color = 'secondary'; // Default (Gris)

                        // Lógica de Colores
                        switch(data) {
                            case 'Pagado Total':
                                color = 'success'; // Verde
                                break;
                            case 'Pagado Parcial':
                                color = 'warning'; // Amarillo
                                break;
                            case 'Vencido':
                                color = 'danger';  // Rojo
                                break;
                            case 'Pendiente Pago':
                                color = 'secondary'; // Gris
                                break;
                            default:
                                color = 'light border'; // Fallback
                        }

                        return `<span class="badge badge-${color}">${data}</span>`;
                    }
                },
                {
                    data: 'id', className: 'text-center',
                    render: function(data, type, row) {
                        let btns = `<button class="btn btn-sm btn-info mr-1" onclick="verDetalle(${data})" title="Ver"><i class="fas fa-eye"></i></button>`;

                        if(row.estado === 'Generado') {
                            btns += `<button class="btn btn-sm btn-success mr-1" onclick="aprobar(${data})" title="Aprobar"><i class="fas fa-check"></i></button>`;
                            btns += `<button class="btn btn-sm btn-danger" onclick="anular(${data})" title="Anular"><i class="fas fa-times"></i></button>`;
                        }
                        return btns;
                    }
                }
            ],
            order: [[0, "desc"]],
            lengthMenu: [[100, 200, 500, -1], [100, 200, 500, 'Todos']],
            initComplete: function (data, row, cell, start, end, display) {
                $('.dt-buttons button').addClass('m-1');
                $('.dt-button-collection').appendTo('.dt-buttons');
                $('.btn.btn-success').removeClass('dt-button btn-secondary buttons-excel buttons-html5');
                $('.btn.btn-danger').removeClass('dt-button btn-secondary buttons-pdf buttons-html5');
                $('.btn.btn-primary').removeClass('dt-button btn-secondary buttons-copy buttons-html5');
                $('.btn.btn-info').removeClass('dt-button btn-secondary buttons-print');
                $('.btn.btn-warning').removeClass('dt-button btn-secondary buttons-collection buttons-colvis');
                //Botón Nuevo
                $('button[title="Nuevo"]').attr('id', 'btn_Nuevo');
                $('#btn_Nuevo').removeClass('dt-button');
                $('#btn_Nuevo').appendTo('div.col-sm-4.c1.d-flex.justify-content-end');
            },
        });
    }

    function verDetalle(id) {
        $.get('/OrdenServicio/GetDetalleOrden?id=' + id, function(res) {
            let html = '';
            res.data.forEach(d => {
                html += `<tr>
                    <td>${d.item}</td>
                    <td class="text-left"><small>${d.producto}</small></td>
                    <td class="text-left"><small>${d.lugar}</small></td>
                    <td>${d.cantidad} ${d.unidadMedida}</td>
                    <td>${d.precioUnitario.toFixed(2)}</td>
                    <td>${d.total.toFixed(2)}</td>
                </tr>`;
            });
            $('#tblBodyDetalle').html(html);
            $('#modalDetalle').modal('show');
        });
    }

    function aprobar(id) {
        Swal.fire({
            title: "¿Aprobar OS?",
            text: "Se actualizará el saldo de los pedidos.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Sí, Aprobar",
            confirmButtonColor: "#28a745",
            reverseButtons: true,
            cancelButtonColor: "#d33",
            cancelButtonText: "Cancelar",
        }).then((result) => {
            if (result.isConfirmed) {
                $.post('/OrdenServicio/AprobarOrden', { id: id }, function(res) {
                    if(res.status) { Swal.fire("Aprobado", res.message, "success"); cargarOrdenes(); }
                    else { Swal.fire("Error", res.message, "error"); }
                });
            }
        });
    }

    function anular(id) {
        Swal.fire({
            title: "¿Anular OS?",
            icon: "error",
            showCancelButton: true,
            confirmButtonText: "Sí, Anular",
            confirmButtonColor: "#dc3545",
            reverseButtons: true,
            cancelButtonText: "Cancelar",
        }).then((result) => {
            if (result.isConfirmed) {
                $.post('/OrdenServicio/RechazarOrden', { id: id }, function(res) {
                    if(res.status) { Swal.fire("Anulado", res.message, "success"); cargarOrdenes(); }
                    else { Swal.fire("Error", res.message, "error"); }
                });
            }
        });
    }
</script>