﻿@{
ViewData["Title"] = "Iniciar sesión";
Layout = null;
}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"] - YnnovaComprobantes</title>
    <script type="importmap"></script>
    <!-- AdminLTE -->
    <link rel="stylesheet" href="/css/adminlte.min.css">
    <link rel="stylesheet" href="/css/all.min.css">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">

    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="/plugins/sweetalert2/sweetalert2.css">
    <!-- Toastr -->
    <link rel="stylesheet" href="/plugins/toastr/toastr.min.css">
    <!-- Select2 -->
    <link rel="stylesheet" href="/plugins/select2/css/select2.min.css">
    <!-- Tempusdominus Bootstrap 4 -->
    <link rel="stylesheet" href="/plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css">
    <!-- Google Font: Source Sans Pro -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700">
    <!-- Datatables -->
    <link rel="stylesheet" href="/plugins/datatables-test/datatables.min.css">
    <!-- Select2 Bootstrap 4-->
    <link rel="stylesheet" href="/plugins/select2-bootstrap4-theme/select2-bootstrap4.css" />

    <!-- Scripts -->
    <!-- jQuery -->
    <script src="/js/jquery.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="/js/bootstrap.bundle.min.js"></script>
    <!-- AdminLTE JS -->
    <script src="/js/adminlte.min.js"></script>

    <!-- Moment.js (para formateo de fechas) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <!-- SweetAlert2 -->
    <script src="/plugins/sweetalert2/sweetalert2.all.min.js"></script>
    <!-- Toastr -->
    <script src="/plugins/toastr/toastr.min.js"></script>
    <!-- Select2 -->
    <script src="/plugins/select2/js/select2.full.min.js"></script>
    <!-- InputMask -->
    <script src="/plugins/inputmask/jquery.inputmask.min.js"></script>
    <!-- Tempusdominus Bootstrap 4 -->
    <script src="/plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js"></script>

    <!-- Datatables -->
    <script src="/plugins/datatables-test/datatables.min.js"></script>
    <script>
        toastr.options = {
            "closeButton": true,
            "debug": false,
            "newestOnTop": true,
            "progressBar": true,
            "positionClass": "toast-top-right",
            "preventDuplicates": false,
            "onclick": null,
            "showDuration": "300",
            "hideDuration": "1000",
            "timeOut": "5000",
            "extendedTimeOut": "1000",
            "showEasing": "swing",
            "hideEasing": "linear",
            "showMethod": "fadeIn",
            "hideMethod": "fadeOut"
        };
    </script>
</head>
<body class="login-page">
    <div class="login-box">
        <div class="login-logo">
            <p class="display-3 font-weight-bold text-primary text-center">
                YnnovaTech
            </p>
        </div>
        <!-- /.login-logo -->
        <div class="card">
            <div class="card-body login-card-body">
                <p class="login-box-msg">Inicia sesión para acceder al sistema</p>
                <form>
                    <div class="input-group mb-3 form-input">
                        <input id="txt_DNI" type="text" class="form-control" placeholder="DNI">
                        <div class="input-group-append">
                            <div class="input-group-text">
                            </div>
                        </div>
                    </div>
                    <div class="input-group mb-3 form-input">
                        <input id="txt_Password" type="password" class="form-control" placeholder="Contraseña">
                        <div class="input-group-append">
                            <div class="input-group-text">
                                <span class="fas fa-lock"></span>
                            </div>
                        </div>
                    </div>
                    @* <div class="row">
                            <div class="col-8">
                                <div class="icheck-primary">
                                    <input type="checkbox" id="remember">
                                    <label for="remember">
                                        Recordarme
                                    </label>
                                </div>
                            </div>
                        </div> *@
                </form>
                <div class="text-center mb-3">
                    <button id="btn_Login" type="button" class="btn btn-block btn-primary">
                        Iniciar sesión
                    </button>
                </div>
            </div>
            <!-- /.login-card-body -->
        </div>
    </div>
    <!-- /.login-box -->
    <script>
        // Toastr configuration
        toastr.options = {
            "closeButton": true,
            "debug": false,
            "newestOnTop": true,
            "progressBar": true,
            "positionClass": "toast-top-right",
            "preventDuplicates": false,
            "onclick": null,
            "showDuration": "300",
            "hideDuration": "1000",
            "timeOut": "5000",
            "extendedTimeOut": "1000",
            "showEasing": "swing",
            "hideEasing": "linear",
            "showMethod": "fadeIn",
            "hideMethod": "fadeOut"
        };

        $(document).ready(function () {

            // 1. Validación de DNI (solo dígitos y límite de 8)
            $('#txt_DNI').on('keypress', function (e) {
                // Obtenemos el código de la tecla presionada
                var charCode = (e.which) ? e.which : e.keyCode;

                // Permitir solo dígitos (48-57) y teclas de control
                if (charCode > 31 && (charCode < 48 || charCode > 57)) {
                    e.preventDefault();
                    return false;
                }

                // Limitar la longitud a 8 dígitos (antes de que se añada el nuevo dígito)
                if ($(this).val().length >= 8) {
                    // Si es un dígito, prevenir la entrada
                    if (charCode > 47 && charCode < 58) {
                        e.preventDefault();
                        return false;
                    }
                }
            });

            // 2. Soporte para la tecla Enter
            // Asumiendo que el campo de texto (DNI/Password) tiene la clase .form-input
            $('.form-input').on('keypress', function(e) {
                if (e.which === 13) {
                    // Simula el clic en el botón de Login
                    $('#btn_Login').click();
                }
            });

            // 3. Efectos de enfoque (focus)
            $('.form-input').on('focus', function() {
                $(this).closest('.input-wrapper').addClass('focused');
            }).on('blur', function() {
                $(this).closest('.input-wrapper').removeClass('focused');
            });

            // 4. Lógica principal de Login
            $('#btn_Login').on('click', function () {
                const dni = $('#txt_DNI').val().trim();
                const password = $('#txt_Password').val().trim();

                // Validar campos vacíos
                if (dni === '' || password === '') {
                    toastr.warning('Debe ingresar sus credenciales de acceso', 'MENSAJE DE SISTEMA');
                    return;
                }

                if (dni.length !== 8) {
                    toastr.warning('El DNI debe tener exactamente 8 dígitos', 'MENSAJE DE SISTEMA');
                    return;
                }

                // Mostrar estado de carga / deshabilitar botón
                const btn = $(this);
                btn.prop('disabled', true);

                let formData = new FormData();
                formData.append("dni", dni);
                formData.append("password", password);

                $.ajax({
                    url: "/Home/IniciarSesion",
                    type: "POST",
                    processData: false,
                    contentType: false,
                    data: formData,
                    success: function (response) {
                        if (response.status === true) {
                            toastr.success(response.message, "MENSAJE DE SISTEMA");
                            window.location.href = "/Home/";
                        } else {
                            toastr.warning(response.message, 'MENSAJE DE SISTEMA');
                            return;
                        }
                    },
                    error: function (xhr, Status, error) {
                        toastr.error("Error en el servidor", "MENSAJE DE SISTEMA");
                        console.error('Error en la solicitud Ajax. Status:', Status, 'Error:', error, 'XHR:', xhr);
                    }
                }).always(function() {
                    // Re-habilitar el botón de login en caso de éxito o error
                    btn.prop('disabled', false);
                });
            });
        });
    </script>
</body>
</html>