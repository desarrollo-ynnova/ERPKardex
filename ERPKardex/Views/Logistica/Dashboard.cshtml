@{
    ViewData["Title"] = "Tablero de Control Logístico";
}

<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

<div class="container-fluid py-3">

    <div class="card shadow mb-4 border-bottom-primary">
        <div class="card-body py-2">
            <div class="row align-items-end">
                <div class="col-md-3">
                    <label class="small font-weight-bold mb-1">Empresa</label>
                    <select id="cbxEmpresaDash" class="form-control form-control-sm">
                        <option value="0">-- CONSOLIDADO --</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="small font-weight-bold mb-1">Desde</label>
                    <input type="date" id="txtFInicio" class="form-control form-control-sm">
                </div>
                <div class="col-md-3">
                    <label class="small font-weight-bold mb-1">Hasta</label>
                    <input type="date" id="txtFFin" class="form-control form-control-sm">
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary btn-sm btn-block shadow-sm font-weight-bold" onclick="fct_CargarDashboard()">
                        <i class="fas fa-sync-alt mr-2"></i> ACTUALIZAR DATOS
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Gasto Ejecutado (S/)</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="lbl_Total">0.00</div>
                        </div>
                        <div class="col-auto"><i class="fas fa-chart-line fa-2x text-gray-300"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Total Órdenes</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="lbl_CountOC">0</div>
                        </div>
                        <div class="col-auto"><i class="fas fa-file-invoice fa-2x text-gray-300"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Total Requerimientos</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="lbl_CountReq">0</div>
                        </div>
                        <div class="col-auto"><i class="fas fa-clipboard-list fa-2x text-gray-300"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Total Pagado (S/)</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="lbl_Pagado">0.00</div>
                        </div>
                        <div class="col-auto"><i class="fas fa-hand-holding-usd fa-2x text-gray-300"></i></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-3">
            <div class="card shadow mb-4">
                <div class="card-header py-2"><h6 class="m-0 font-weight-bold text-warning small">Req. Compra</h6></div>
                <div class="card-body p-2"><div id="chartPieRC" style="height: 200px;"></div></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow mb-4">
                <div class="card-header py-2"><h6 class="m-0 font-weight-bold text-warning small">Req. Servicio</h6></div>
                <div class="card-body p-2"><div id="chartPieRS" style="height: 200px;"></div></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow mb-4">
                <div class="card-header py-2"><h6 class="m-0 font-weight-bold text-info small">Orden Compra (Estado)</h6></div>
                <div class="card-body p-2"><div id="chartPieOC" style="height: 200px;"></div></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow mb-4">
                <div class="card-header py-2"><h6 class="m-0 font-weight-bold text-info small">Orden Servicio (Estado)</h6></div>
                <div class="card-body p-2"><div id="chartPieOS" style="height: 200px;"></div></div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card shadow mb-4">
                <div class="card-header py-2 bg-white"><h6 class="m-0 font-weight-bold text-success">Estado Pagos: Compras</h6></div>
                <div class="card-body"><div id="chartPagoOC" style="height: 220px;"></div></div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow mb-4">
                <div class="card-header py-2 bg-white"><h6 class="m-0 font-weight-bold text-success">Estado Pagos: Servicios</h6></div>
                <div class="card-body"><div id="chartPagoOS" style="height: 220px;"></div></div>
            </div>
        </div>
    </div>

    <div class="row mt-2">
        <div class="col-md-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-white">
                    <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-chart-bar mr-2"></i> Evolución COMPRAS: Gastado vs Ejecutado</h6>
                </div>
                <div class="card-body">
                    <div id="chartEvolucionCompra" style="height: 350px;"></div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-white">
                    <h6 class="m-0 font-weight-bold text-success"><i class="fas fa-chart-bar mr-2"></i> Evolución SERVICIOS: Gastado vs Ejecutado</h6>
                </div>
                <div class="card-body">
                    <div id="chartEvolucionServicio" style="height: 350px;"></div>
                </div>
            </div>
        </div>
    </div>

</div>

@section Scripts {
    <script>
        const formatter = new Intl.NumberFormat('es-PE', { style: 'currency', currency: 'PEN' });

        $(document).ready(function () {
            // Cargar Empresas
            $.get('/Activo/GetEmpresasCombo', function (res) {
                if (res.status) {
                    res.data.forEach(e => $('#cbxEmpresaDash').append(`<option value="${e.id}">${e.nombre}</option>`));
                }
            });

            // Fechas Default
            let date = new Date();
            let currentYear = date.getFullYear();
            let inicio = new Date(currentYear, 0, 1);
            let fin = new Date(currentYear, 11, 31);
            inicio.setMinutes(inicio.getMinutes() - inicio.getTimezoneOffset());
            fin.setMinutes(fin.getMinutes() - fin.getTimezoneOffset());

            $('#txtFInicio').val(inicio.toISOString().split('T')[0]);
            $('#txtFFin').val(fin.toISOString().split('T')[0]);

            fct_CargarDashboard();
        });

        function fct_CargarDashboard() {
            let empresa = $('#cbxEmpresaDash').val();
            let inicio = $('#txtFInicio').val();
            let fin = $('#txtFFin').val();

            Swal.fire({ title: 'Procesando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            $.get(`/Logistica/GetDashboardData?empresaId=${empresa}&fechaInicio=${inicio}&fechaFin=${fin}`, function (res) {
                Swal.close();
                if (res.status) {
                    // KPIs
                    $('#lbl_Total').text(formatter.format(res.kpis.montoTotal));
                    $('#lbl_CountOC').text(res.kpis.countOC);
                    $('#lbl_CountReq').text(res.kpis.countReq);
                    $('#lbl_Pagado').text(formatter.format(res.kpis.montoPagado));

                    // Tortas
                    initDonut('chartPieRC', res.charts.pieRC, 'Req. Compra');
                    initDonut('chartPieRS', res.charts.pieRS, 'Req. Servicio');
                    initDonut('chartPieOC', res.charts.pieOC, 'Estado OC');
                    initDonut('chartPieOS', res.charts.pieOS, 'Estado OS');

                    // Tortas Financieras
                    let colorPagos = { 'Pagado Total': '#1cc88a', 'Pagado Parcial': '#f6c23e', 'Vencido': '#e74a3b', 'Pendiente Pago': '#858796' };
                    initDonut('chartPagoOC', res.charts.piePagoOC, 'Pagos OC', colorPagos);
                    initDonut('chartPagoOS', res.charts.piePagoOS, 'Pagos OS', colorPagos);

                    // EVOLUCIÓN
                    initEvolutionChart('chartEvolucionCompra', res.charts.evolucionCategories, res.charts.seriesCompra.ejecutado, res.charts.seriesCompra.pagado, 'Compras', '#4e73df');
                    initEvolutionChart('chartEvolucionServicio', res.charts.evolucionCategories, res.charts.seriesServicio.ejecutado, res.charts.seriesServicio.pagado, 'Servicios', '#1cc88a');
                }
            });
        }

        function initDonut(id, data, title, colorMap = null) {
            let chart = echarts.init(document.getElementById(id));
            if(colorMap) {
                data.forEach(d => { if(colorMap[d.name]) d.itemStyle = { color: colorMap[d.name] }; });
            }
            let option = {
                title: { text: title, left: 'center', show: false },
                tooltip: { trigger: 'item', formatter: '{b}: {c} ({d}%)' },
                legend: { show: false },
                series: [{
                    type: 'pie', radius: ['40%', '70%'],
                    data: data,
                    label: { show: true, formatter: '{c}', position: 'inside', color: '#fff', fontSize: 10 },
                    itemStyle: { borderRadius: 3, borderColor: '#fff', borderWidth: 1 }
                }]
            };
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }

        // --- FUNCIÓN MODIFICADA PARA BARRAS UNIFORMES ---
        function initEvolutionChart(id, categories, dataEjecutado, dataPagado, nombreSerie, colorBase) {
            let chart = echarts.init(document.getElementById(id));
            let option = {
                title: { show: false },
                toolbox: {
                    show: true,
                    feature: {
                        magicType: { show: true, type: ['line', 'bar'], title: { line: 'Líneas', bar: 'Barras' } },
                        saveAsImage: { show: true, title: 'Descargar' }
                    },
                    right: 10
                },
                tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                legend: { top: 0 },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'category', data: categories },
                yAxis: { type: 'value' },
                series: [
                    {
                        name: 'Monto Gastado',
                        type: 'bar', // Barra 1
                        data: dataEjecutado,
                        itemStyle: { color: colorBase },
                        barMaxWidth: 30
                    },
                    {
                        name: 'Monto Ejecutado',
                        type: 'bar', // Barra 2 (CAMBIADO DE LINE A BAR)
                        data: dataPagado,
                        itemStyle: { color: '#f6c23e' },
                        barMaxWidth: 30
                    }
                ]
            };
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }
    </script>
}