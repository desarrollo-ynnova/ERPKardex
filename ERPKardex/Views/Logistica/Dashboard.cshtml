@{
    ViewData["Title"] = "Tablero de Control Logístico";
}

<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

<div class="container-fluid py-3">

    <div class="card shadow mb-4 border-bottom-primary">
        <div class="card-body py-2">
            <div class="row align-items-end">
                <div class="col-md-3">
                    <label class="small font-weight-bold mb-1">Empresa</label>
                    <select id="cbxEmpresaDash" class="form-control form-control-sm">
                        <option value="0">-- CONSOLIDADO --</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="small font-weight-bold mb-1">Desde</label>
                    <input type="date" id="txtFInicio" class="form-control form-control-sm">
                </div>
                <div class="col-md-3">
                    <label class="small font-weight-bold mb-1">Hasta</label>
                    <input type="date" id="txtFFin" class="form-control form-control-sm">
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary btn-sm btn-block shadow-sm font-weight-bold" onclick="fct_CargarDashboard()">
                        <i class="fas fa-sync-alt mr-2"></i> ACTUALIZAR DATOS
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Gasto Ejecutado (S/)</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="lbl_Total">0.00</div>
                        </div>
                        <div class="col-auto"><i class="fas fa-chart-line fa-2x text-gray-300"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Total Órdenes</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="lbl_CountOC">0</div>
                        </div>
                        <div class="col-auto"><i class="fas fa-file-invoice fa-2x text-gray-300"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Total Requerimientos</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="lbl_CountReq">0</div>
                        </div>
                        <div class="col-auto"><i class="fas fa-clipboard-list fa-2x text-gray-300"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Total Pagado (S/)</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="lbl_Pagado">0.00</div>
                        </div>
                        <div class="col-auto"><i class="fas fa-hand-holding-usd fa-2x text-gray-300"></i></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="d-sm-flex align-items-center justify-content-between mb-2">
        <h1 class="h6 mb-0 text-gray-800 border-left-warning pl-2 font-weight-bold">Gestión de Requerimientos (Atención)</h1>
    </div>
    <div class="row">
        <div class="col-md-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-white"><h6 class="m-0 font-weight-bold text-warning">Req. Compra (Por Estado)</h6></div>
                <div class="card-body"><div id="chartPieRC" style="height: 250px;"></div></div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-white"><h6 class="m-0 font-weight-bold text-warning">Req. Servicio (Por Estado)</h6></div>
                <div class="card-body"><div id="chartPieRS" style="height: 250px;"></div></div>
            </div>
        </div>
    </div>

    <div class="d-sm-flex align-items-center justify-content-between mb-2 mt-2">
        <h1 class="h6 mb-0 text-gray-800 border-left-info pl-2 font-weight-bold">Estado Operativo de Órdenes</h1>
    </div>
    <div class="row">
        <div class="col-md-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-white"><h6 class="m-0 font-weight-bold text-info">Órdenes Compra (Trámite)</h6></div>
                <div class="card-body"><div id="chartPieOC" style="height: 250px;"></div></div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-white"><h6 class="m-0 font-weight-bold text-info">Órdenes Servicio (Trámite)</h6></div>
                <div class="card-body"><div id="chartPieOS" style="height: 250px;"></div></div>
            </div>
        </div>
    </div>

    <div class="d-sm-flex align-items-center justify-content-between mb-2 mt-2">
        <h1 class="h6 mb-0 text-gray-800 border-left-success pl-2 font-weight-bold">Estado Financiero (Deudas)</h1>
    </div>
    <div class="row">
        <div class="col-md-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-white"><h6 class="m-0 font-weight-bold text-success">Pagos: Órdenes Compra</h6></div>
                <div class="card-body"><div id="chartPagoOC" style="height: 250px;"></div></div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-white"><h6 class="m-0 font-weight-bold text-success">Pagos: Órdenes Servicio</h6></div>
                <div class="card-body"><div id="chartPagoOS" style="height: 250px;"></div></div>
            </div>
        </div>
    </div>

    <div class="row mt-2">
        <div class="col-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-white">
                    <h6 class="m-0 font-weight-bold text-dark"><i class="fas fa-chart-area mr-2"></i> Evolución Mensual del Gasto</h6>
                </div>
                <div class="card-body">
                    <div id="chartEvolucion" style="height: 350px;"></div>
                </div>
            </div>
        </div>
    </div>

</div>

@section Scripts {
    <script>
        const formatter = new Intl.NumberFormat('es-PE', { style: 'currency', currency: 'PEN' });

        $(document).ready(function () {
            $.get('/Activo/GetEmpresasCombo', function (res) {
                if (res.status) {
                    res.data.forEach(e => $('#cbxEmpresaDash').append(`<option value="${e.id}">${e.nombre}</option>`));
                }
            });

            // Fechas Default: Todo el Año Actual (1 Ene - 31 Dic)
            let date = new Date();
            let currentYear = date.getFullYear();

            // Primer día del año (Mes 0 = Enero)
            let inicio = new Date(currentYear, 0, 1);

            // Último día del año (Mes 11 = Diciembre, Día 31)
            let fin = new Date(currentYear, 11, 31);

            // AJUSTE DE ZONA HORARIA:
            // Esto evita que al convertir a ISO se reste el horario (ej: UTC-5 Perú)
            // y te marque el día anterior.
            inicio.setMinutes(inicio.getMinutes() - inicio.getTimezoneOffset());
            fin.setMinutes(fin.getMinutes() - fin.getTimezoneOffset());

            $('#txtFInicio').val(inicio.toISOString().split('T')[0]);
            $('#txtFFin').val(fin.toISOString().split('T')[0]);

            fct_CargarDashboard();
        });

        function fct_CargarDashboard() {
            let empresa = $('#cbxEmpresaDash').val();
            let inicio = $('#txtFInicio').val();
            let fin = $('#txtFFin').val();

            Swal.fire({ title: 'Procesando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            $.get(`/Logistica/GetDashboardData?empresaId=${empresa}&fechaInicio=${inicio}&fechaFin=${fin}`, function (res) {
                Swal.close();
                if (res.status) {
                    // KPIs
                    $('#lbl_Total').text(formatter.format(res.kpis.montoTotal));
                    $('#lbl_CountOC').text(res.kpis.countOC);
                    $('#lbl_CountReq').text(res.kpis.countReq);
                    $('#lbl_Pagado').text(formatter.format(res.kpis.montoPagado));

                    // 1. REQUERIMIENTOS
                    initDonut('chartPieRC', res.charts.pieRC, 'Req. Compra');
                    initDonut('chartPieRS', res.charts.pieRS, 'Req. Servicio');

                    // 2. ÓRDENES OPERATIVAS (Restaurado)
                    initDonut('chartPieOC', res.charts.pieOC, 'Estado OC');
                    initDonut('chartPieOS', res.charts.pieOS, 'Estado OS');

                    // 3. ÓRDENES FINANCIERAS (Pagos)
                    let colorPagos = { 'PAGADO': '#1cc88a', 'PENDIENTE': '#f6c23e', 'VENCIDO': '#e74a3b' };
                    initDonut('chartPagoOC', res.charts.piePagoOC, 'Pagos OC', colorPagos);
                    initDonut('chartPagoOS', res.charts.piePagoOS, 'Pagos OS', colorPagos);

                    // 4. EVOLUCIÓN
                    initEvolutionChart('chartEvolucion', res.charts.evolucion);
                }
            });
        }

        function initDonut(id, data, title, colorMap = null) {
            let chart = echarts.init(document.getElementById(id));
            if(colorMap) {
                data.forEach(d => { if(colorMap[d.name]) d.itemStyle = { color: colorMap[d.name] }; });
            }
            let option = {
                title: { text: title, left: 'center', show: false },
                tooltip: { trigger: 'item', formatter: '{b}: {c} ({d}%)' },
                legend: { bottom: '0%', icon: 'circle' },
                toolbox: { show: true, feature: { saveAsImage: { show: true, title: 'Guardar' } }, right: 10 },
                series: [{
                    type: 'pie',
                    radius: ['40%', '70%'],
                    data: data,
                    label: { show: true, formatter: '{c}', position: 'inside', color: '#fff', fontWeight: 'bold' },
                    itemStyle: { borderRadius: 5, borderColor: '#fff', borderWidth: 2 },
                    emphasis: { label: { show: true, fontSize: '14', fontWeight: 'bold' } }
                }]
            };
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }

        function initEvolutionChart(id, data) {
            let chart = echarts.init(document.getElementById(id));
            let option = {
                title: { text: 'Evolución de Gasto (Mensual)', left: 'center', top: 10, textStyle: { color: '#333', fontSize: 16 } },
                toolbox: {
                    show: true,
                    feature: {
                        magicType: { show: true, type: ['line', 'bar'], title: { line: 'Ver Líneas', bar: 'Ver Barras' } },
                        saveAsImage: { show: true, title: 'Guardar Imagen', pixelRatio: 2 }
                    },
                    right: 20
                },
                tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                legend: { top: 40 },
                grid: { left: '3%', right: '4%', bottom: '3%', top: 80, containLabel: true },
                xAxis: { type: 'category', data: data.categories },
                yAxis: { type: 'value' },
                series: [
                    { name: 'Compras (Bienes)', type: 'bar', stack: 'total', data: data.compras, itemStyle: { color: '#4e73df' }, barMaxWidth: 50 },
                    { name: 'Servicios', type: 'bar', stack: 'total', data: data.servicios, itemStyle: { color: '#1cc88a' }, barMaxWidth: 50 }
                ]
            };
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }
    </script>
}