@{
    ViewData["Title"] = "Tablero de Control Logístico";
}

<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

<div class="container-fluid py-3">

    <div class="card shadow mb-4 border-bottom-primary">
        <div class="card-body py-2">
            <div class="row align-items-end">
                <div class="col-md-3">
                    <label class="small font-weight-bold mb-1">Empresa</label>
                    <select id="cbxEmpresaDash" class="form-control form-control-sm">
                        <option value="0">-- CONSOLIDADO --</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="small font-weight-bold mb-1">Moneda</label>
                    <select id="cbxMonedaDash" class="form-control form-control-sm font-weight-bold text-primary">
                        <option value="1">SOLES (S/.)</option>
                        <option value="2">DÓLARES ($)</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="small font-weight-bold mb-1">Desde</label>
                    <input type="date" id="txtFInicio" class="form-control form-control-sm">
                </div>
                <div class="col-md-2">
                    <label class="small font-weight-bold mb-1">Hasta</label>
                    <input type="date" id="txtFFin" class="form-control form-control-sm">
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary btn-sm btn-block shadow-sm font-weight-bold" onclick="fct_CargarDashboard()">
                        <i class="fas fa-sync-alt mr-2"></i> ACTUALIZAR
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Gasto Comprometido (Aprobado)</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="lbl_Total">0.00</div>
                        </div>
                        <div class="col-auto"><i class="fas fa-chart-line fa-2x text-gray-300"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Total Órdenes Generadas</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="lbl_CountOC">0</div>
                        </div>
                        <div class="col-auto"><i class="fas fa-file-invoice fa-2x text-gray-300"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Total Requerimientos</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="lbl_CountReq">0</div>
                        </div>
                        <div class="col-auto"><i class="fas fa-clipboard-list fa-2x text-gray-300"></i></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-white">
                    <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-shopping-cart mr-2"></i> Evolución Gastos: COMPRAS</h6>
                </div>
                <div class="card-body">
                    <div id="chartEvolucionCompra" style="height: 300px;"></div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-white">
                    <h6 class="m-0 font-weight-bold text-success"><i class="fas fa-tools mr-2"></i> Evolución Gastos: SERVICIOS</h6>
                </div>
                <div class="card-body">
                    <div id="chartEvolucionServicio" style="height: 300px;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-3">
            <div class="card shadow mb-4">
                <div class="card-header py-2"><h6 class="m-0 font-weight-bold text-secondary small">Req. Compra</h6></div>
                <div class="card-body p-2"><div id="chartPieRC" style="height: 200px;"></div></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow mb-4">
                <div class="card-header py-2"><h6 class="m-0 font-weight-bold text-secondary small">Req. Servicio</h6></div>
                <div class="card-body p-2"><div id="chartPieRS" style="height: 200px;"></div></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow mb-4">
                <div class="card-header py-2"><h6 class="m-0 font-weight-bold text-info small">Orden Compra (Estado)</h6></div>
                <div class="card-body p-2"><div id="chartPieOC" style="height: 200px;"></div></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow mb-4">
                <div class="card-header py-2"><h6 class="m-0 font-weight-bold text-info small">Orden Servicio (Estado)</h6></div>
                <div class="card-body p-2"><div id="chartPieOS" style="height: 200px;"></div></div>
            </div>
        </div>
    </div>

</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Cargar Empresas
            $.get('/Activo/GetEmpresas', function (res) {
                if (res.status) {
                    res.data.forEach(e => $('#cbxEmpresaDash').append(`<option value="${e.id}">${e.nombre}</option>`));
                }
            });
            // Fechas Default
            let date = new Date();
            let currentYear = date.getFullYear();
            let inicio = new Date(currentYear, 0, 1);
            let fin = new Date(currentYear, 11, 31);
            inicio.setMinutes(inicio.getMinutes() - inicio.getTimezoneOffset());
            fin.setMinutes(fin.getMinutes() - fin.getTimezoneOffset());

            $('#txtFInicio').val(inicio.toISOString().split('T')[0]);
            $('#txtFFin').val(fin.toISOString().split('T')[0]);

            fct_CargarDashboard();
        });

        function fct_CargarDashboard() {
            let empresa = $('#cbxEmpresaDash').val();
            let moneda = $('#cbxMonedaDash').val();
            let inicio = $('#txtFInicio').val();
            let fin = $('#txtFFin').val();

            let simbolo = (moneda == '2') ? '$' : 'S/.';
            let codigoIso = (moneda == '2') ? 'USD' : 'PEN';
            const formatMoney = new Intl.NumberFormat('es-PE', { style: 'currency', currency: codigoIso });

            Swal.fire({ title: 'Procesando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            $.get(`/Logistica/GetDashboardData?empresaId=${empresa}&monedaId=${moneda}&fechaInicio=${inicio}&fechaFin=${fin}`, function (res) {
                Swal.close();
                if (res.status) {
                    // KPIs
                    $('#lbl_Total').text(formatMoney.format(res.kpis.montoTotal));
                    $('#lbl_CountOC').text(res.kpis.countOC);
                    $('#lbl_CountReq').text(res.kpis.countReq);

                    // Tortas Operativas
                    initDonut('chartPieRC', res.charts.pieRC);
                    initDonut('chartPieRS', res.charts.pieRS);
                    initDonut('chartPieOC', res.charts.pieOC);
                    initDonut('chartPieOS', res.charts.pieOS);

                    // Evolución Gastos (Solo una serie)
                    initEvolutionChart('chartEvolucionCompra', res.charts.evolucionCategories, res.charts.seriesCompra, '#4e73df', simbolo);
                    initEvolutionChart('chartEvolucionServicio', res.charts.evolucionCategories, res.charts.seriesServicio, '#1cc88a', simbolo);
                }
            });
        }

        function initDonut(id, data) {
            let chart = echarts.init(document.getElementById(id));
            let option = {
                title: { show: false },
                tooltip: { trigger: 'item', formatter: '{b}: {c} ({d}%)' },
                legend: { show: true, bottom: '0%', left: 'center', itemWidth: 10, itemHeight: 10 },
                series: [{
                    type: 'pie', radius: ['40%', '65%'], center: ['50%', '45%'],
                    data: data,
                    label: { show: true, formatter: '{c}', position: 'inside', fontSize: 10, color: '#fff' },
                    itemStyle: { borderRadius: 3, borderColor: '#fff', borderWidth: 1 }
                }]
            };
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }

        function initEvolutionChart(id, categories, dataEjecutado, colorBase, simbolo) {
            let chart = echarts.init(document.getElementById(id));
            const numFmt = new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            let option = {
                title: { show: false },
                toolbox: { show: true, feature: { saveAsImage: { show: true } }, right: 10 },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    valueFormatter: (value) => simbolo + ' ' + numFmt.format(value)
                },
                legend: { top: 0 },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'category', data: categories },
                yAxis: { type: 'value' },
                series: [
                    {
                        name: 'Gasto Aprobado', type: 'bar', data: dataEjecutado, itemStyle: { color: colorBase }, barMaxWidth: 40,
                        label: { show: true, position: 'top', formatter: (p) => p.value > 0 ? numFmt.format(p.value) : '', fontSize: 10, color: '#666' }
                    }
                ]
            };
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }
    </script>
}