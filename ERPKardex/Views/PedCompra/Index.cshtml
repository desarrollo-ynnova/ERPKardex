@{
    ViewData["Title"] = "Bandeja de Pedidos de Compra";
}

<div class="card d-none" id="efec-cargando">
    <div class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center overlay dark" style="z-index: 9999; background: rgba(0,0,0,0.5);">
        <i class="fas fa-3x fa-sync-alt fa-spin text-white"></i>
    </div>
</div>

<div class="container-fluid p-4">
    <div class="card shadow mb-4">
        <div class="card-header py-3 bg-white">
            <h5 class="m-0 font-weight-bold text-primary"><i class="bi bi-basket"></i> Gestión de Pedidos de Compra</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table id="tbl_PedCompras" class="table table-bordered table-striped hover display nowrap w-100">
                    <thead class="bg-dark text-white">
                        <tr>
                            <th class="text-center">NÚMERO</th>
                            <th class="text-center">F. EMISIÓN</th>
                            <th class="text-center">F. NECESARIA</th>
                            <th class="text-center">CC (RESUMEN)</th>
                            <th class="text-center">EMPRESA</th>
                            <th class="text-center">SOLICITANTE</th>
                            <th class="text-center">ESTADO</th>
                            <th class="text-center">ACCIONES</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalDetallePedido" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="bi bi-list-check"></i> Detalle del Pedido</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-sm table-bordered table-hover text-center">
                        <thead class="thead-light">
                            <tr>
                                <th style="width: 50px;">Item</th>
                                <th>Descripción</th>
                                <th style="width: 100px;">C. Costo</th>
                                <th>Lugar</th>
                                <th style="width: 80px;">U.M.</th>
                                <th style="width: 80px;">Cant.</th>
                                <th style="width: 80px;">Cant. Atendida</th>
                                <th style="width: 100px;">Estado</th>
                                <th>Ref. Origen</th>
                            </tr>
                        </thead>
                        <tbody id="tbody_DetallePedido"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script>
    var dtPedidos;

    $(document).ready(function () {
        var windowHeight = $('body > div.wrapper > div.content-wrapper').height() / 2;
        //CONFIGURACION POR DEFECTO DATATABLES
        $.extend($.fn.dataTable.defaults, {
            dom: "<'row align-items-center'<'col-sm-8 justify-content-start'f><'col-sm-4 c1 d-flex justify-content-end'>>" + "<'row align-items-center'<'col-sm-6'l><'col-sm-6 my-3 justify-content-start d-flex'B>" + "<'col-sm-6'i><'col-sm-6 mb-3 d-flex justify-content-end'p>" + "rt" + "<'col-sm-6'i><'col-sm-6 mt-1 d-flex justify-content-end'p>",
            // dom: "<'row pb-1'<'col-sm-9 d-flex'B><'col-sm-3 c1 d-flex justify-content-end'>>" + "<'row'<'col-sm-4'l><'col-sm-8 justify-content-start'f>>" + "<'row'<'col-sm-6'i><'col-sm-6 d-flex justify-content-end'p>>" + "rt" + "<'row'<'col-sm-6'i><'col-sm-6 mt-1 d-flex justify-content-end'p>>",
            // dom: "<'row pb-1'<'col-sm-9'B><'col-sm-3 c1 d-flex justify-content-end'>>" + "<'row'<'col-sm-10'l><'col-sm-2'f>>" + "<'row'<'col-sm-6'i><'col-sm-6'p>>" + "rt" + "<'row'<'col-sm-6'i><'col-sm-6'p>>",
            // dom: "<'row pb-1'<'col-sm-10'B><'col-sm-2 c1 d-flex justify-content-end'>>" + "<'row'<'col-sm-11'l><'col-sm-1'f>>" + "<'row'<'col-sm-10'i><'col-sm-2'p>>" + "rt" + "<'row'<'col-sm-10'i><'col-sm-2'p>>",
            paging: true,
            select: true,
            scroller: false,
            deferRender: true,
            scrollY: windowHeight,
            scrollX: true,
            fixedHeader: true,
            ordering: true,
            destroy: true,
            responsive: true,
            autoWidth: false,
            processing: true,
            filter: true,
            orderMulti: true,
            stateSave: false,
            serverSide: false,
            language: {
                processing: "Procesando...",
                sSearch: "Buscar:",
                lengthMenu: "Mostrar _MENU_ registros",
                info: "Mostrando del _START_ al _END_ de un total de _TOTAL_ registros",
                infoEmpty: "Sin registros encontrados.",
                infoFiltered: "(Total de _MAX_ registros filtrados)",
                loadingRecords: "Cargando...",
                zeroRecords: "No se encontraron registros",
                emptyTable: "No hay datos disponibles en la tabla",
                paginate: {
                    previous: "Anterior",
                    next: "Siguiente",
                    first: "Primero",
                    last: "Último",
                },
                aria: {
                    sortAscending: ": Activar para ordenar la columna de manera ascendente",
                    sortDescending: ": Activar para ordenar la columna de manera descendente"
                },
                select: {
                    rows: {
                        _: "%d filas seleccionadas",
                        0: "Haz clic en una fila para seleccionarla",
                        1: "1 fila seleccionada"
                    }
                },
                buttons: {
                    copyTitle: 'Copiado en el portapapeles',
                    copyKeys: 'Presiona <i>ctrl</i> o <i>\u2318</i> + <i>C</i> para copiar los datos de la tabla a tu portapapeles. <br><br>Para cancelar, haga clic en este mensaje o presione Esc.',
                    copySuccess: {
                        _: '%d registros copiados correctamente',
                        1: '1 registro copiado correctamente'
                    }
                }
            },
            lengthMenu: [[100, 200, 500, -1], [100, 200, 500, 'Todos']],
        });

        // Inicializamos la tabla
        fct_IniciarTablaPedCompras('#tbl_PedCompras');
    });

    function fct_IniciarTablaPedCompras(IdTabla) {
        dtPedidos = $(IdTabla).DataTable({
            // Botones estándar
            buttons: [
                {
                    extend: 'copy',
                    text: '<i class="bi bi-back"></i>',
                    titleAttr: 'Copiar en portapapeles',
                    className: 'btn btn-primary',
                },
                {
                    extend: 'excel',
                    text: '<i class="bi bi-file-earmark-excel"></i>',
                    titleAttr: 'Exportar a Excel',
                    className: 'btn btn-success',
                    filename: 'Pedidos servicios ' + moment().format('DD-MM-YYYY HH_mm'),
                    footer: true,
                    exportOptions:
                    {
                        stripHtml: true,
                        columns: ':not(:last-child)'
                    },
                },
                {
                    extend: 'pdf',
                    text: '<i class="bi bi-file-earmark-pdf"></i>',
                    titleAttr: 'Exportar a PDF',
                    className: 'btn btn-danger',
                    filename: 'Pedidos servicios ' + moment().format('DD-MM-YYYY HH_mm'),
                    exportOptions:
                    {
                        stripHtml: true,
                        columns: ':not(:last-child)'
                    },
                    orientation: 'landscape',
                    pageSize: 'LEGAL',
                },
                {
                    extend: 'print',
                    text: '<i class="bi bi-printer-fill"></i>',
                    titleAttr: 'Imprimir',
                    className: 'btn btn-info',
                    exportOptions:
                    {
                        stripHtml: true,
                        columns: ':not(:last-child)'
                    },
                },
                {
                    extend: 'colvis',
                    text: '<i class="bi bi-ui-checks"></i>',
                    titleAttr: 'Seleccionar',
                    className: 'btn btn-warning',
                    columns: ':not(.noVis)',
                },
                {
                    text: '<i class="bi bi-plus-circle mr-1" style="margin-right: 5px;"></i> Nuevo Pedido',
                    titleAttr: 'Nuevo',
                    className: 'btn btn-success',
                    action: function (e, dt, node, config) {
                        window.location.href = '/PedCompra/Registrar';
                    }
                },
            ],
            ajax: {
                url: "/PedCompra/GetPedidosCompraData",
                type: "GET",
                datatype: "json",
                dataSrc: function (json) {
                    if (json.status === false) {
                        toastr.error(json.message);
                        return [];
                    }
                    return json.data;
                },
                error: function () { toastr.error('Error al cargar la tabla.'); }
            },
            columns: [
                { data: "numero", className: "align-middle font-weight-bold" },
                {
                    data: "fechaEmision", className: "text-center align-middle",
                },
                {
                    data: "fechaNecesaria", className: "text-center align-middle",
                },
                {
                    data: "centroCosto",
                    className: "align-middle text-info font-weight-bold text-center",
                    render: function(data) {
                        // Si hay varios, se mostrarán separados por coma
                        return `<small style="font-size: 0.9em;">${data}</small>`;
                    }
                },
                { data: "empresa", className: "align-middle" },
                { data: "solicitante", className: "align-middle" },
                {
                    data: "estado", className: "text-center align-middle",
                    render: function (data) {
                        let badgeClass = "badge-secondary"; // Color por defecto (Gris)

                        if (data === "Generado") {
                            badgeClass = "badge-info"; // Azul
                        }
                        else if (data === "Atendido Parcial") {
                            badgeClass = "badge-warning text-dark"; // Amarillo
                        }
                        else if (data === "Atendido Total") {
                            badgeClass = "badge-success"; // Verde
                        }
                        else if (data === "Anulado") {
                            badgeClass = "badge-danger"; // Rojo
                        }

                        return `<span class="badge ${badgeClass} px-2 py-1">${data}</span>`;
                    },
                },
                {
                    data: null, orderable: false, className: 'text-center align-middle',
                    render: function (data, type, row) {
                        // Botones de acción
                        return `
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-info" onclick="fct_VerPedido(${row.id})" title="Ver Detalle"><i class="bi bi-eye"></i></button>
                        </div>`;
                    }
                }
            ],
            order: [[0, 'desc']], // Ordenar por Numero descendente
            lengthMenu: [[100, 200, 500, -1], [100, 200, 500, 'Todos']],
            initComplete: function (data, row, cell, start, end, display) {
                $('.dt-buttons button').addClass('m-1');
                $('.dt-button-collection').appendTo('.dt-buttons');
                $('.btn.btn-success').removeClass('dt-button btn-secondary buttons-excel buttons-html5');
                $('.btn.btn-danger').removeClass('dt-button btn-secondary buttons-pdf buttons-html5');
                $('.btn.btn-primary').removeClass('dt-button btn-secondary buttons-copy buttons-html5');
                $('.btn.btn-info').removeClass('dt-button btn-secondary buttons-print');
                $('.btn.btn-warning').removeClass('dt-button btn-secondary buttons-collection buttons-colvis');
                //Botón Nuevo
                $('button[title="Nuevo"]').attr('id', 'btn_Nuevo');
                $('#btn_Nuevo').removeClass('dt-button');
                $('#btn_Nuevo').appendTo('div.col-sm-4.c1.d-flex.justify-content-end');
            },
        });
    }

    // --- FUNCIÓN PARA CARGAR DETALLE EN MODAL ---
    function fct_VerPedido(id) {
        ShowSpinner();
        $('#tbody_DetallePedido').html('<tr><td colspan="8">Cargando...</td></tr>');

        $.ajax({
            url: '/PedCompra/GetDetallePedido?id=' + id,
            type: 'GET',
            success: function (res) {
                HideSpinner();
                if (res.status) {
                    let html = '';
                    if(res.data && res.data.length > 0){
                        res.data.forEach(d => {
                            let badgeClass = 'badge-secondary';
                            let estadoTexto = d.estado || 'No definido'; // Fallback por seguridad

                            if (estadoTexto === 'Pendiente') badgeClass = 'badge-warning';
                            else if (estadoTexto === 'Atendido Parcial') badgeClass = 'badge-info';
                            else if (estadoTexto === 'Atendido Total') badgeClass = 'badge-success';

                            html += `<tr>
                                <td class="font-weight-bold">${d.item}</td>
                                <td class="text-left">
                                    ${d.descripcionLibre}<br>
                                    <small class="text-muted"><i>${d.observacionItem || ''}</i></small>
                                </td>
                                <td class="text-primary font-weight-bold">${d.centroCosto}</td>
                                <td class="font-weight-bold">${d.lugar}</td>
                                <td>${d.unidadMedida}</td>
                                <td class="font-weight-bold">${d.cantidadAprobada.toFixed(2)}</td>
                                <td class="font-weight-bold">${d.cantidadAtendida.toFixed(2)}</td>
                                <td class="align-middle text-center">
                                    <span class="badge ${badgeClass} p-2">${estadoTexto}</span>
                                </td>
                                <td><span class="badge badge-light border">${d.ref}</span></td>
                            </tr>`;
                        });
                    } else {
                        html = '<tr><td colspan="9">Sin detalles registrados.</td></tr>';
                    }
                    $('#tbody_DetallePedido').html(html);
                    $('#modalDetallePedido').modal('show');
                } else {
                    toastr.error(res.message);
                }
            },
            error: function () {
                HideSpinner();
                toastr.error("Error de conexión al obtener detalles.");
            }
        });
    }

    function ShowSpinner() { $('#efec-cargando').removeClass('d-none'); }
    function HideSpinner() { $('#efec-cargando').addClass('d-none'); }
</script>