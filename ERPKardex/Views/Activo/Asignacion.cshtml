@{
    ViewData["Title"] = "Movimiento de Activo";
    int activoId = int.Parse(Context.Request.Query["id"]);
}

<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="callout callout-info">
                <h5><i class="fas fa-info-circle"></i> Activo Seleccionado</h5>
                <p class="mb-0 font-weight-bold text-lg" id="lbl_Activo">Cargando...</p>
                <small id="lbl_InfoActual">...</small>
            </div>

            <div class="card card-warning card-outline">
                <div class="card-header">
                    <h3 class="card-title">Registrar Movimiento</h3>
                </div>
                <div class="card-body">

                    <div class="form-group text-center">
                        <div class="btn-group btn-group-toggle" data-toggle="buttons">
                            <label class="btn btn-outline-primary active" id="lbl_OpcionEntrega">
                                <input type="radio" name="tipoMov" value="ENTREGA" checked>
                                <i class="fas fa-user-check"></i> ENTREGAR A USUARIO
                            </label>
                            <label class="btn btn-outline-danger" id="lbl_OpcionDevolucion">
                                <input type="radio" name="tipoMov" value="DEVOLUCION">
                                <i class="fas fa-undo"></i> DEVOLUCIÓN A STOCK
                            </label>
                        </div>
                    </div>
                    <hr>

                    <div id="div_Entrega">
                        <div class="form-group">
                            <label>Personal Receptor</label>
                            <select id="cbx_Personal" class="form-control select2-busqueda"></select>
                        </div>
                    </div>

                    <div id="div_Devolucion" class="d-none">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> El activo regresará al Stock y quedará sin responsable asignado.
                        </div>
                        <div class="form-group">
                            <label>Condición de Retorno</label>
                            <select id="cbx_CondicionRetorno" class="form-control">
                                <option value="OPERATIVO">OPERATIVO (Buen estado)</option>
                                <option value="MALOGRADO">MALOGRADO (Dañado)</option>
                                <option value="EN REPARACION">NECESITA REPARACIÓN</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Nueva Ubicación Física</label>
                        <input type="text" id="txt_Ubicacion" class="form-control" placeholder="Ej: Oficina 302 / Almacén Central">
                    </div>

                    <div class="form-group">
                        <label>Observaciones</label>
                        <textarea id="txt_Observacion" class="form-control" rows="3"></textarea>
                    </div>

                </div>
                <div class="card-footer text-right">
                    <a href="/Activo/Index" class="btn btn-default">Volver</a>
                    <button type="button" class="btn btn-primary" onclick="fct_Procesar()">
                        <i class="fas fa-check"></i> Procesar Movimiento
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const ID_ACTIVO = @activoId;

        $(document).ready(function () {
            $('.select2-busqueda').select2({ theme: 'bootstrap4' });

            // Cargar datos iniciales
            $.get('/Activo/GetDatosAsignacion?activoId=' + ID_ACTIVO, function(res) {
                if(res.status) {
                    let a = res.activo;
                    let cur = res.actual;
                    $('#lbl_Activo').text(`${a.codigoInterno} - SERIE: ${a.serie}`);
                    $('#lbl_InfoActual').html(`Responsable Actual: <b>${cur.responsable}</b> <br> Ubicación: ${cur.ubicacion}`);

                    // Pre-llenar condición si es devolución
                    $('#cbx_CondicionRetorno').val(a.condicion);
                } else {
                    toastr.error(res.message);
                }
            });

            // Cargar personal
            $.get('/Activo/GetPersonalCombo', function(res) {
                if(res.status) {
                    let h = '<option value="">-- SELECCIONE --</option>';
                    res.data.forEach(p => h += `<option value="${p.id}">${p.nombresCompletos}</option>`);
                    $('#cbx_Personal').html(h);
                }
            });

            // Lógica de Toggle
            $('input[name="tipoMov"]').change(function() {
                if(this.value === 'ENTREGA') {
                    $('#div_Entrega').removeClass('d-none');
                    $('#div_Devolucion').addClass('d-none');
                } else {
                    $('#div_Entrega').addClass('d-none');
                    $('#div_Devolucion').removeClass('d-none');
                }
            });
        });

        function fct_Procesar() {
            let modo = $('input[name="tipoMov"]:checked').val();
            let url = '', data = {};

            if(modo === 'ENTREGA') {
                let pid = $('#cbx_Personal').val();
                if(!pid) return toastr.warning("Seleccione al personal receptor");

                url = '/Activo/GuardarAsignacion';
                data = {
                    activoId: ID_ACTIVO,
                    personalId: pid,
                    ubicacion: $('#txt_Ubicacion').val(),
                    observacion: $('#txt_Observacion').val()
                };
            } else {
                url = '/Activo/GuardarDevolucion';
                data = {
                    activoId: ID_ACTIVO,
                    condicionRetorno: $('#cbx_CondicionRetorno').val(),
                    ubicacion: $('#txt_Ubicacion').val(), // Generalmente Almacén
                    observacion: $('#txt_Observacion').val()
                };
            }

            Swal.fire({
                title: '¿Confirmar Movimiento?',
                text: 'Se generará el acta correspondiente.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, procesar'
            }).then((r) => {
                if(r.isConfirmed) {
                    $.post(url, data, function(res) {
                        if(res.status) {
                            Swal.fire({
                                title: '¡Éxito!',
                                text: 'Movimiento registrado. ¿Desea imprimir el acta?',
                                icon: 'success',
                                showCancelButton: true,
                                confirmButtonText: 'Imprimir Acta',
                                cancelButtonText: 'Ir al Listado'
                            }).then((x) => {
                                if(x.isConfirmed) {
                                    window.open('/Activo/ActaImpresion?id=' + res.idAsignacion, '_blank');
                                }
                                window.location.href = '/Activo/Index';
                            });
                        } else {
                            toastr.error(res.message);
                        }
                    });
                }
            });
        }
    </script>
}