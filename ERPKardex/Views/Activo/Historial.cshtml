@{
    ViewData["Title"] = "Historial del Activo";
    bool esVehiculo = ViewBag.TipoModulo == "VEHICULOS";
}

<div class="container-fluid py-4">
    <div class="card shadow mb-4 border-bottom-primary">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h4 class="font-weight-bold text-primary mb-1" id="lbl_Descripcion">Cargando...</h4>
                    <div class="h5">
                        <span class="badge badge-dark mr-2" id="lbl_Codigo">---</span>
                        <span class="badge badge-secondary" id="lbl_Serie">VIN/SERIE: ---</span>
                    </div>
                </div>
                <div class="col-md-4 text-right">
                    @if (esVehiculo)
                    {
                        <div class="p-2 bg-light rounded border">
                            <small class="text-muted d-block">KILOMETRAJE ACTUAL</small>
                            <h3 class="font-weight-bold text-dark mb-0"><span id="lbl_KmActual">0</span> KM</h3>
                        </div>
                    }
                    <div class="mt-2">
                        <span id="lbl_Situacion" class="badge badge-info p-2">...</span>
                        <span id="lbl_Condicion" class="badge badge-success p-2">...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow">
        <div class="card-header p-0">
            @if (esVehiculo)
            {
                <ul class="nav nav-tabs card-header-tabs ml-0" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active font-weight-bold" data-toggle="tab" href="#tab_kardex" role="tab">
                            <i class="fas fa-history mr-1"></i> Kardex de Asignaciones
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link font-weight-bold" data-toggle="tab" href="#tab_docs" role="tab" onclick="fct_CargarDocs()">
                            <i class="fas fa-folder-open mr-1"></i> Legajo Documentario
                        </a>
                    </li>
                </ul>
            }
            else
            {
                <div class="p-3 font-weight-bold text-primary">
                    <i class="fas fa-history mr-1"></i> Historial de Movimientos
                </div>
            }
        </div>

        <div class="card-body">
            <div class="tab-content">

                <div class="tab-pane fade show active" id="tab_kardex" role="tabpanel">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="tbl_Historial" width="100%">
                            <thead class="thead-light">
                                <tr>
                                    <th>FECHA</th>
                                    <th>MOVIMIENTO</th>
                                    <th>RESPONSABLE / ASIGNADO A</th>
                                    <th>UBICACIÓN</th>
                                    @if (esVehiculo)
                                    {
                                        <th class="text-right">LECTURA (KM)</th>
                                    }
                                    <th>OBSERVACIÓN</th>
                                    <th class="text-center">ACTA</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                @if (esVehiculo)
                {
                    <div class="tab-pane fade" id="tab_docs" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="text-primary m-0">Documentos Digitalizados (SOAT, Revisiones, Seguros)</h6>
                            <button class="btn btn-sm btn-primary" onclick="fct_AbrirModalDocs()"><i class="fas fa-upload"></i> Nuevo Documento</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-bordered" id="tbl_Documentos">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>TIPO</th>
                                        <th>N° DOCUMENTO</th>
                                        <th>VENCIMIENTO</th>
                                        <th>ESTADO</th>
                                        <th class="text-center">VER</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="5" class="text-center">Cargando documentos...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                }

            </div>
        </div>
        <div class="card-footer text-right">
            <a href="/Activo/Index?tipo=@ViewBag.TipoModulo" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
        </div>
    </div>
</div>

<div class="modal fade" id="modalDocs" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" id="modalDocsContent"></div>
    </div>
</div>

@section Scripts {
    <script>
        var ACTIVO_ID = @(ViewBag.ActivoId ?? 0);
        var ES_VEHICULO = @(esVehiculo.ToString().ToLower());

        $(document).ready(function () {
            if (ACTIVO_ID > 0) {
                fct_CargarHistorial();
            } else {
                alert("ID de activo no válido");
                window.history.back();
            }
        });

        function fct_CargarHistorial() {
            $.get('/Activo/GetHistorial?activoId=' + ACTIVO_ID, function (res) {
                if (res.status) {
                    // 1. Llenar Cabecera
                    let info = res.activoInfo;
                    if(info) {
                        $('#lbl_Descripcion').text(info.descripcion);
                        $('#lbl_Codigo').text(info.codigo);
                        $('#lbl_Serie').text('SERIE/VIN: ' + info.serie);
                        $('#lbl_Condicion').text(info.condicion);
                        $('#lbl_Situacion').text(info.situacion);

                        if(ES_VEHICULO) {
                            $('#lbl_KmActual').text(new Intl.NumberFormat().format(info.kmActual));
                        }
                    }

                    // 2. Llenar Tabla Historial
                    let html = '';
                    res.data.forEach(item => {
                        let badgeTipo = item.tipo === 'ENTREGA' ? 'badge-primary' : 'badge-warning';
                        let btnActa = item.rutaActa
                            ? `<a href="/${item.rutaActa}" target="_blank" class="btn btn-sm btn-danger"><i class="fas fa-file-pdf"></i> PDF</a>`
                            : `<span class="text-muted small">Pendiente</span>`;

                        // Columna KM (condicional)
                        let tdKm = '';
                        if(ES_VEHICULO) {
                            tdKm = `<td class="text-right font-weight-bold">${new Intl.NumberFormat().format(item.kilometraje)}</td>`;
                        }

                        html += `
                            <tr>
                                <td>${item.fecha}</td>
                                <td><span class="badge ${badgeTipo}">${item.tipo}</span> <br> <small>${item.codigoActa}</small></td>
                                <td>${item.responsable}</td>
                                <td>${item.ubicacion}</td>
                                ${tdKm}
                                <td>${item.observacion}</td>
                                <td class="text-center">${btnActa}</td>
                            </tr>
                        `;
                    });

                    if(res.data.length === 0) html = '<tr><td colspan="7" class="text-center">Sin movimientos registrados.</td></tr>';
                    $('#tbl_Historial tbody').html(html);
                }
            });
        }

        function fct_CargarDocs() {
            if(!ES_VEHICULO) return;

            $.get('/Activo/GetDocumentosActivo?activoId=' + ACTIVO_ID, function(res) {
                if(res.status) {
                    let html = '';
                    res.data.forEach(d => {
                        let colorVenc = d.estadoVenc === 'VENCIDO' ? 'text-danger font-weight-bold' : 'text-success';
                        let btnVer = d.rutaArchivo
                            ? `<a href="/${d.rutaArchivo}" target="_blank" class="btn btn-sm btn-info"><i class="fas fa-eye"></i></a>`
                            : '<span class="text-muted">-</span>';

                        html += `
                            <tr>
                                <td>${d.tipo}</td>
                                <td>${d.nro}</td>
                                <td class="${colorVenc}">${d.vence}</td>
                                <td>${d.estadoVenc}</td>
                                <td class="text-center">${btnVer}</td>
                            </tr>
                        `;
                    });
                    if(res.data.length === 0) html = '<tr><td colspan="5" class="text-center">No hay documentos cargados.</td></tr>';
                    $('#tbl_Documentos tbody').html(html);
                }
            });
        }

        function fct_AbrirModalDocs() {
            $('#modalDocsContent').load('/Activo/GestionDocumental?id=' + ACTIVO_ID, function() {
                $('#modalDocs').modal('show');
            });
        }
    </script>
}