@{
    ViewData["Title"] = "Gestión de Movimientos de Flota";
}

<div class="container py-4">
    <div class="card shadow border-0">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0"><i class="fas fa-exchange-alt mr-2"></i> Control de Asignaciones y Devoluciones</h5>
        </div>
        <div class="card-body">

            <div class="row mb-4">
                <div class="col-md-12">
                    <label class="font-weight-bold">Seleccione la operación a realizar:</label>
                    <div class="btn-group btn-group-toggle w-100" data-toggle="buttons">
                        <label class="btn btn-outline-primary active" onclick="fct_CambioTipo('ENTREGA')">
                            <input type="radio" name="optTipo" value="ENTREGA" checked>
                            <i class="fas fa-key"></i> ENTREGA (ASIGNACIÓN)
                        </label>
                        <label class="btn btn-outline-danger" onclick="fct_CambioTipo('DEVOLUCION')">
                            <input type="radio" name="optTipo" value="DEVOLUCION">
                            <i class="fas fa-undo"></i> DEVOLUCIÓN / INGRESO A STOCK
                        </label>
                    </div>
                </div>
            </div>

            <div class="card bg-light mb-3">
                <div class="card-body">
                    <h6 class="text-primary font-weight-bold mb-3"><i class="fas fa-truck-pickup"></i> Datos de la Unidad</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <label>Buscar Vehículo (Placa / Modelo)</label>
                            <select id="cbx_Activo" class="form-control select2" onchange="fct_CargarDatosVehiculo()"></select>
                        </div>
                        <div class="col-md-3">
                            <label>Kilometraje Actual (Sistema)</label>
                            <input type="text" id="txt_KmActual" class="form-control" readonly>
                        </div>
                        <div class="col-md-3">
                            <label>Nuevo Kilometraje <span class="text-danger">*</span></label>
                            <input type="number" id="txt_KmNuevo" class="form-control font-weight-bold text-success">
                            <small class="text-muted">Lectura del odómetro hoy.</small>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label>Estado Físico (Condición)</label>
                            <select id="cbx_Condicion" class="form-control">
                                <option value="OPERATIVO">OPERATIVO (OK)</option>
                                <option value="CON OBSERVACIONES">CON OBSERVACIONES (Raspones, etc)</option>
                                <option value="MALOGRADO">MALOGRADO / FALLA MECÁNICA</option>
                                <option value="SINIESTRADO">SINIESTRADO</option>
                            </select>
                        </div>
                        <div class="col-md-6" id="div_Situacion">
                            <label class="text-danger font-weight-bold">Destino Post-Devolución</label>
                            <select id="cbx_Destino" class="form-control">
                                <option value="EN STOCK">EN STOCK (Disponible)</option>
                                <option value="EN TALLER">EN TALLER (Mantenimiento)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6" id="div_Personal">
                    <label>Asignar a (Responsable / Chofer) <span class="text-danger">*</span></label>
                    <select id="cbx_Personal" class="form-control select2"></select>
                </div>
                <div class="col-md-6">
                    <label>Ubicación / Sede</label>
                    <input type="text" id="txt_Ubicacion" class="form-control" placeholder="Ej: MINA, OFICINA LIMA, TALLER EXTERNO">
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-12">
                    <label>Observaciones Generales</label>
                    <textarea id="txt_Obs" class="form-control" rows="2" placeholder="Detalles de la entrega, estado de accesorios, combustible..."></textarea>
                </div>
            </div>

            <div class="text-right mt-4">
                <button class="btn btn-success btn-lg px-5 shadow" onclick="fct_GuardarMovimiento()">
                    <i class="fas fa-save"></i> PROCESAR MOVIMIENTO
                </button>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        var LISTA_ACTIVOS = [];

        $(document).ready(function () {
            $('.select2').select2({ theme: 'bootstrap4', width: '100%' });
            fct_CargarDataInicial();
            fct_CambioTipo('ENTREGA'); // Default
        });

        function fct_CambioTipo(tipo) {
            if(tipo === 'ENTREGA') {
                $('#div_Personal').show(); // Se elige a quien se da
                $('#div_Situacion').hide(); // El destino implícito es "EN USO"
            } else {
                $('#div_Personal').hide(); // El sistema detecta quien lo tenía
                $('#div_Situacion').show(); // Hay que decir si va a Stock o Taller
            }
            // Limpiar campos para evitar errores
            $('#txt_KmActual').val('');
            $('#txt_KmNuevo').val('');
            $('#cbx_Activo').val('').trigger('change');
        }

        function fct_CargarDataInicial() {
            // 1. Cargar Vehículos
            $.get('/Activo/GetActivos?tipoModulo=VEHICULOS', function (res) {
                if(res.status) {
                    LISTA_ACTIVOS = res.data;
                    let html = '<option value="">-- Seleccione Vehículo --</option>';
                    res.data.forEach(x => {
                        // Solo mostramos los disponibles según la operación?
                        // Mejor mostramos todos y validamos en el change
                        html += `<option value="${x.id}">${x.codigo} - ${x.descripcion}</option>`;
                    });
                    $('#cbx_Activo').html(html);
                }
            });

            // 2. Cargar Personal
            $.get('/Activo/GetPersonalCombo', function (res) {
                if(res.status) {
                    let html = '<option value="">-- Seleccione Responsable --</option>';
                    res.data.forEach(x => html += `<option value="${x.id}">${x.nombresCompletos}</option>`);
                    $('#cbx_Personal').html(html);
                }
            });
        }

        function fct_CargarDatosVehiculo() {
            let id = $('#cbx_Activo').val();
            if(!id) return;

            let vehiculo = LISTA_ACTIVOS.find(x => x.id == id);
            if(vehiculo) {
                $('#txt_KmActual').val(vehiculo.kilometraje);
                $('#txt_KmNuevo').val(vehiculo.kilometraje); // Sugerencia inicial

                // Validación Lógica Visual
                let tipoOp = $('input[name=optTipo]:checked').val();
                if(tipoOp === 'ENTREGA' && vehiculo.situacion === 'EN USO') {
                    toastr.warning('Cuidado: Este vehículo figura EN USO actualmente.');
                }
                if(tipoOp === 'DEVOLUCION' && vehiculo.situacion === 'EN STOCK') {
                    toastr.warning('Cuidado: Este vehículo figura EN STOCK (no asignado).');
                }
            }
        }

        function fct_GuardarMovimiento() {
            let tipoOp = $('input[name=optTipo]:checked').val();
            let activoId = $('#cbx_Activo').val();
            let kmNuevo = $('#txt_KmNuevo').val();
            let kmActual = parseFloat($('#txt_KmActual').val() || 0);

            if(!activoId) { toastr.error("Seleccione un vehículo"); return; }
            if(!kmNuevo || parseFloat(kmNuevo) < kmActual) {
                toastr.error("El Nuevo Kilometraje no puede ser menor al actual."); return;
            }

            let personalId = null;
            let condicion = $('#cbx_Condicion').val(); // Condición física

            // Lógica de "Situacion" (Destino)
            // Si es Entrega -> Siempre EN USO (y en Condicion lo que diga el combo)
            // Si es Devolución -> La Situación depende del combo Destino (Stock/Taller)
            // Pero mi API de GuardarMovimiento espera "Condicion" para el item.
            // Para manejar el estado "EN TALLER", usaremos la "Condicion" del item como truco
            // OJO: El controlador ya pone "EN STOCK" al devolver.
            // Si queremos que quede "EN TALLER", debemos asegurarnos que la condicion refleje eso
            // o modificar el controlador. Por simplicidad, mandaremos la condición elegida.

            if(tipoOp === 'ENTREGA') {
                personalId = $('#cbx_Personal').val();
                if(!personalId) { toastr.error("Seleccione al personal receptor"); return; }
            }

            // Armar DTO
            let data = {
                TipoMovimiento: tipoOp,
                PersonalId: personalId,
                Ubicacion: $('#txt_Ubicacion').val(),
                Observacion: $('#txt_Obs').val(),
                Items: [
                    {
                        ActivoId: activoId,
                        Condicion: condicion, // 'OPERATIVO', 'MALOGRADO'
                        NuevaMedida: kmNuevo,
                        Observacion: (tipoOp === 'DEVOLUCION' && $('#cbx_Destino').val() === 'EN TALLER') ? 'INGRESO A TALLER' : ''
                    }
                ]
            };

            // Enviar
            $.ajax({
                url: '/Activo/GuardarMovimiento',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(res) {
                    if(res.status) {
                        toastr.success(res.message);
                        setTimeout(() => { window.location.href = '/Activo/Index?tipo=VEHICULOS'; }, 1500);
                    } else {
                        toastr.error(res.message);
                    }
                }
            });
        }
    </script>
}