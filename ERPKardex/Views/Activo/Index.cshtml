@{
    ViewData["Title"] = "Inventario General";
    bool esAdmin = ViewBag.EsAdmin ?? false;
    // Necesitamos saber si es admin para mostrar el combo
}

<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6"><h1>Inventario de Activos</h1></div>
        </div>
    </div>
</section>

<section class="content">
    <div class="container-fluid">
        <div class="card card-primary card-outline">
            <div class="card-header">
                <h3 class="card-title">Listado de Equipos</h3>
                <div class="card-tools">
                    @if (@esAdmin)
                    {
                        <div class="input-group input-group-sm" style="width: 250px;">
                            <select id="cbxFiltroEmpresa" class="form-control">
                                <option value="0">-- TODAS LAS EMPRESAS --</option>
                            </select>
                        </div>
                    }
                </div>
            </div>
            <div class="card-body">
                <table id="tbl_Activos" class="table table-bordered table-hover" style="width:100%">
                    <thead>
                        <tr>
                            <th>ASIGNADO A</th>
                            <th>CÓDIGO</th>
                            <th>EQUIPO (Marca/Modelo)</th>
                            <th>SERIE</th>
                            <th>CONDICIÓN</th>
                            <th>UBICACIÓN</th>
                            <th>ACCIONES</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        var dtActivos;
        var esAdmin = '@ViewBag.EsAdmin' === 'True';

        $(document).ready(function () {
            // $('body').addClass('sidebar-collapse');
            var windowHeight = $('body > div.wrapper > div.content-wrapper').height() / 2;
            //CONFIGURACION POR DEFECTO DATATABLES
            $.extend($.fn.dataTable.defaults, {
                dom: "<'row align-items-center'<'col-sm-8 justify-content-start'f><'col-sm-4 c1 d-flex justify-content-end'>>" + "<'row align-items-center'<'col-sm-6'l><'col-sm-6 my-3 justify-content-start d-flex'B>" + "<'col-sm-6'i><'col-sm-6 mb-3 d-flex justify-content-end'p>" + "rt" + "<'col-sm-6'i><'col-sm-6 mt-1 d-flex justify-content-end'p>",
                // dom: "<'row pb-1'<'col-sm-9 d-flex'B><'col-sm-3 c1 d-flex justify-content-end'>>" + "<'row'<'col-sm-4'l><'col-sm-8 justify-content-start'f>>" + "<'row'<'col-sm-6'i><'col-sm-6 d-flex justify-content-end'p>>" + "rt" + "<'row'<'col-sm-6'i><'col-sm-6 mt-1 d-flex justify-content-end'p>>",
                // dom: "<'row pb-1'<'col-sm-9'B><'col-sm-3 c1 d-flex justify-content-end'>>" + "<'row'<'col-sm-10'l><'col-sm-2'f>>" + "<'row'<'col-sm-6'i><'col-sm-6'p>>" + "rt" + "<'row'<'col-sm-6'i><'col-sm-6'p>>",
                // dom: "<'row pb-1'<'col-sm-10'B><'col-sm-2 c1 d-flex justify-content-end'>>" + "<'row'<'col-sm-11'l><'col-sm-1'f>>" + "<'row'<'col-sm-10'i><'col-sm-2'p>>" + "rt" + "<'row'<'col-sm-10'i><'col-sm-2'p>>",
                paging: true,
                select: true,
                scroller: false,
                deferRender: true,
                scrollY: windowHeight,
                scrollX: true,
                fixedHeader: true,
                ordering: true,
                destroy: true,
                responsive: true,
                autoWidth: false,
                processing: true,
                filter: true,
                orderMulti: true,
                stateSave: false,
                serverSide: false,
                language: {
                    processing: "Procesando...",
                    sSearch: "Buscar:",
                    lengthMenu: "Mostrar _MENU_ registros",
                    info: "Mostrando del _START_ al _END_ de un total de _TOTAL_ registros",
                    infoEmpty: "Sin registros encontrados.",
                    infoFiltered: "(Total de _MAX_ registros filtrados)",
                    loadingRecords: "Cargando...",
                    zeroRecords: "No se encontraron registros",
                    emptyTable: "No hay datos disponibles en la tabla",
                    paginate: {
                        previous: "Anterior",
                        next: "Siguiente",
                        first: "Primero",
                        last: "Último",
                    },
                    aria: {
                        sortAscending: ": Activar para ordenar la columna de manera ascendente",
                        sortDescending: ": Activar para ordenar la columna de manera descendente"
                    },
                    select: {
                        rows: {
                            _: "%d filas seleccionadas",
                            0: "Haz clic en una fila para seleccionarla",
                            1: "1 fila seleccionada"
                        }
                    },
                    buttons: {
                        copyTitle: 'Copiado en el portapapeles',
                        copyKeys: 'Presiona <i>ctrl</i> o <i>\u2318</i> + <i>C</i> para copiar los datos de la tabla a tu portapapeles. <br><br>Para cancelar, haga clic en este mensaje o presione Esc.',
                        copySuccess: {
                            _: '%d registros copiados correctamente',
                            1: '1 registro copiado correctamente'
                        }
                    }
                },
                lengthMenu: [[100, 200, 500, -1], [100, 200, 500, 'Todos']],
            });

            if(esAdmin) cargarEmpresas();

            dtActivos = $('#tbl_Activos').DataTable({
                buttons: [
                    {
                        extend: 'copy',
                        text: '<i class="bi bi-back"></i>',
                        titleAttr: 'Copiar en portapapeles',
                        className: 'btn btn-primary',
                    },
                    {
                        extend: 'excel',
                        text: '<i class="bi bi-file-earmark-excel"></i>',
                        titleAttr: 'Exportar a Excel',
                        className: 'btn btn-success',
                        filename: 'Activos cómputo ' + moment().format('DD-MM-YYYY HH_mm'),
                        footer: true,
                        exportOptions:
                        {
                            stripHtml: true,
                            columns: ':not(:last-child)'
                        },
                    },
                    {
                        extend: 'pdf',
                        text: '<i class="bi bi-file-earmark-pdf"></i>',
                        titleAttr: 'Exportar a PDF',
                        className: 'btn btn-danger',
                        filename: 'Activos cómputo ' + moment().format('DD-MM-YYYY HH_mm'),
                        exportOptions:
                        {
                            stripHtml: true,
                            columns: ':not(:last-child)'
                        },
                        orientation: 'landscape',
                        pageSize: 'LEGAL',
                    },
                    {
                        extend: 'print',
                        text: '<i class="bi bi-printer-fill"></i>',
                        titleAttr: 'Imprimir',
                        className: 'btn btn-info',
                        exportOptions:
                        {
                            stripHtml: true,
                            columns: ':not(:last-child)'
                        },
                    },
                    {
                        extend: 'colvis',
                        text: '<i class="bi bi-ui-checks"></i>',
                        titleAttr: 'Seleccionar',
                        className: 'btn btn-warning',
                        columns: ':not(.noVis)',
                    },
                    {
                        text: '<i class="fas fa-plus"></i> Nuevo Activo',
                        className: 'btn btn-success',
                        titleAttr: 'Nuevo',
                        action: function () { window.location.href = '/Activo/Registro'; }
                    },
                ],
                ajax: {
                    url: "/Activo/GetActivos",
                    type: "GET",
                    data: function(d) {
                        d.empresaIdFiltro = $('#cbxFiltroEmpresa').val();
                    },
                    dataSrc: function (json) {
                        return json.status ? json.data : [];
                    }
                },
                order: [[0, 'asc']], // Ordenar por Persona para agrupar visualmente
                columns: [
                    { data: "asignadoA", className: "font-weight-bold text-primary" },
                    { data: "codigo" },
                    { data: "descripcion" },
                    { data: "serie" },
                    {
                        data: "condicion",
                        render: function(d) {
                            let color = d === 'OPERATIVO' ? 'success' : (d === 'NUEVO' ? 'primary' : 'danger');
                            return `<span class="badge badge-${color}">${d}</span>`;
                        }
                    },
                    { data: "ubicacion" },
                    {
                        data: "id",
                        className: "text-center",
                        render: function (data) {
                            return `
                                <div class="btn-group btn-group-sm">
                                    <a href="/Activo/Asignacion?id=${data}" class="btn btn-info" title="Mover"><i class="fas fa-exchange-alt"></i></a>
                                    <a href="/Activo/Historial?id=${data}" class="btn btn-secondary" title="Historial"><i class="fas fa-history"></i></a>
                                </div>`;
                        }
                    }
                ],
                lengthMenu: [[100, 200, 500, -1], [100, 200, 500, 'Todos']],
                initComplete: function (data, row, cell, start, end, display) {
                    $('.dt-buttons button').addClass('m-1');
                    $('.dt-button-collection').appendTo('.dt-buttons');
                    $('.btn.btn-success').removeClass('dt-button btn-secondary buttons-excel buttons-html5');
                    $('.btn.btn-danger').removeClass('dt-button btn-secondary buttons-pdf buttons-html5');
                    $('.btn.btn-primary').removeClass('dt-button btn-secondary buttons-copy buttons-html5');
                    $('.btn.btn-info').removeClass('dt-button btn-secondary buttons-print');
                    $('.btn.btn-warning').removeClass('dt-button btn-secondary buttons-collection buttons-colvis');
                    //Botón Nuevo
                    $('button[title="Nuevo"]').attr('id', 'btn_Nuevo');
                    $('#btn_Nuevo').removeClass('dt-button');
                    $('#btn_Nuevo').appendTo('div.col-sm-4.c1.d-flex.justify-content-end');
                },
                // Callback para "limpiar" visualmente el nombre repetido (Efecto Agrupación)
                drawCallback: function (settings) {
                    var api = this.api();
                    var rows = api.rows({ page: 'current' }).nodes();
                    var last = null;

                    // Si prefieres usar el plugin RowGroup de Datatables, úsalo.
                    // Si no, este truco visual oculta el nombre si es igual al anterior
                    /* api.column(0, { page: 'current' }).data().each(function (group, i) {
                        if (last !== group) {
                            // Aquí podrías insertar una fila de cabecera si quisieras
                            last = group;
                        } else {
                            // Ocultar texto repetido para efecto visual limpio
                            $(rows).eq(i).find('td:eq(0)').css('color', 'transparent');
                        }
                    });
                    */
                }
            });

            $('#cbxFiltroEmpresa').change(function() {
                dtActivos.ajax.reload();
            });
        });

        function cargarEmpresas() {
            $.get('/Activo/GetEmpresasCombo', function(res) {
                if(res.status) {
                    let h = '<option value="0">-- TODAS --</option>';
                    res.data.forEach(e => h += `<option value="${e.id}">${e.razonSocial}</option>`);
                    $('#cbxFiltroEmpresa').html(h);
                }
            });
        }
    </script>
}