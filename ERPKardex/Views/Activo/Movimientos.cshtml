@{
    ViewData["Title"] = "Movimientos de Activos";
}

<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h4 class="m-0 text-dark">
                    <i class="fas fa-exchange-alt mr-2"></i>Movimientos (Entregas / Devoluciones)
                </h4>
            </div>
            <div class="col-sm-6 text-right">
                <button class="btn btn-primary" onclick="abrirModalMovimiento()">
                    <i class="fas fa-plus mr-1"></i> Nuevo Movimiento
                </button>
            </div>
        </div>
    </div>
</div>

<div class="content">
    <div class="container-fluid">
        <div class="card card-outline card-secondary mb-3">
            <div class="card-body py-2">
                <div class="row align-items-end">
                    <div class="col-md-3">
                        <div class="form-group mb-2">
                            <label class="small mb-1">Tipo de Activo</label>
                            <select id="filtroTipo" class="form-control form-control-sm" onchange="cargarMovimientos()">
                                <option value="">-- Todos --</option>
                                <option value="COMPUTO">Cómputo</option>
                                <option value="VEHICULO">Vehículos</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group mb-2">
                            <label class="small mb-1">Empresa</label>
                            <select id="filtroEmpresa" class="form-control form-control-sm" onchange="cargarMovimientos()">
                                <option value="">-- Todas --</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group mb-2">
                            <label class="small mb-1">Buscar</label>
                            <input type="text" id="filtroBuscar" class="form-control form-control-sm"
                                   placeholder="Código movimiento, personal, activo..."
                                   onkeyup="if(event.key==='Enter') cargarMovimientos()">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group mb-2">
                            <button class="btn btn-sm btn-outline-secondary btn-block" onclick="cargarMovimientos()">
                                <i class="fas fa-search mr-1"></i>Filtrar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card card-outline card-primary">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0" id="tblMovimientos">
                        <thead class="thead-dark">
                            <tr>
                                <th>Código</th>
                                <th>Tipo</th>
                                <th>Fecha</th>
                                <th>Empresa</th>
                                <th>Personal</th>
                                <th>Activos</th>
                                <th>Estado</th>
                                <th class="text-center" style="width:160px;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="bodyMovimientos">
                            <tr><td colspan="8" class="text-center text-muted py-4">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalMovimiento" tabindex="-1" role="dialog" data-backdrop="static">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Nuevo Movimiento</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="card mb-3">
                    <div class="card-body py-2 bg-light">
                        <div class="row">
                            <div class="col-md-2">
                                <div class="form-group mb-0">
                                    <label class="mb-1">Tipo Movimiento</label>
                                    <select id="movTipo" class="form-control form-control-sm">
                                        <option value="ENTREGA">ENTREGA</option>
                                        <option value="DEVOLUCION">DEVOLUCIÓN</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group mb-0">
                                    <label class="mb-1">Fecha</label>
                                    <input type="date" id="movFecha" class="form-control form-control-sm">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group mb-0">
                                    <label class="mb-1">Empresa</label>
                                    <select id="movEmpresa" class="form-control form-control-sm" onchange="cargarPersonal()"></select>
                                </div>
                            </div>
                            <div class="col-md-5">
                                <div class="form-group mb-0">
                                    <label class="mb-1">Personal</label>
                                    <select id="movPersonal" class="form-control form-control-sm"></select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-5">
                        <div class="card card-outline card-secondary h-100">
                            <div class="card-header py-1">
                                <h6 class="card-title font-weight-bold" style="font-size: 1rem;">Buscar Activos Disponibles</h6>
                            </div>
                            <div class="card-body p-2">
                                <div class="input-group input-group-sm mb-2">
                                    <input type="text" id="busquedaActivo" class="form-control" placeholder="Buscar por serie, código o modelo..." onkeyup="if(event.key==='Enter') buscarActivosParaAgregar()">
                                    <div class="input-group-append">
                                        <button class="btn btn-secondary" onclick="buscarActivosParaAgregar()"><i class="fas fa-search"></i></button>
                                    </div>
                                </div>
                                <div class="table-responsive" style="height: 250px; overflow-y: auto;">
                                    <table class="table table-sm table-bordered table-hover head-fixed">
                                        <thead class="thead-light">
                                            <tr>
                                                <th>Activo</th>
                                                <th width="40"></th>
                                            </tr>
                                        </thead>
                                        <tbody id="listaActivosBusqueda">
                                            <tr><td colspan="2" class="text-center text-muted small">Use el buscador...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-7">
                        <div class="card card-outline card-success h-100">
                            <div class="card-header py-1">
                                <h6 class="card-title font-weight-bold" style="font-size: 1rem;">Activos Seleccionados</h6>
                            </div>
                            <div class="card-body p-2">
                                <div class="table-responsive" style="height: 290px; overflow-y: auto;">
                                    <table class="table table-sm table-bordered">
                                        <thead class="thead-light">
                                            <tr>
                                                <th>Código</th>
                                                <th>Descripción</th>
                                                <th>Ubicación</th>
                                                <th width="40"></th>
                                            </tr>
                                        </thead>
                                        <tbody id="listaActivosSeleccionados">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group mt-3">
                    <label>Observación General</label>
                    <textarea id="movObservacion" class="form-control" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer py-2">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarMovimiento()">
                    <i class="fas fa-save mr-1"></i>Generar Movimiento
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalDetalleMov" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="modalDetalleMovTitulo">Detalle Movimiento</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="contenidoDetalleMov">
                <p class="text-center">Cargando...</p>
            </div>
            <div class="modal-footer py-2">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalSubirActa" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Subir Acta Firmada</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="uploadMovId">
                <div class="form-group">
                    <label>Seleccione el archivo (PDF o Imagen)</label>
                    <div class="custom-file">
                        <input type="file" class="custom-file-input" id="fileActa" accept=".pdf,.jpg,.png,.jpeg">
                        <label class="custom-file-label" for="fileActa">Elegir archivo...</label>
                    </div>
                    <small class="text-muted mt-2 d-block">Asegúrese de que el acta esté firmada.</small>
                </div>
            </div>
            <div class="modal-footer py-2">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="guardarActaFile()">
                    <i class="fas fa-upload mr-1"></i>Subir
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Variables globales
        let activosSeleccionados = [];

        document.addEventListener('DOMContentLoaded', () => {
            cargarCombos();
            cargarMovimientos();

            // Listener para input file BS4 (opcional para cambiar el texto)
            $('#fileActa').on('change',function(){
                var fileName = $(this).val().replace('C:\\fakepath\\', " ");
                $(this).next('.custom-file-label').html(fileName);
            });
        });

        // ======================== COMBOS ========================
        async function cargarCombos() {
            // Empresas
            let res = await fetch('/Activo/GetEmpresas');
            let json = await res.json();
            if (json.status) {
                let selFiltro = document.getElementById('filtroEmpresa');
                let selModal = document.getElementById('movEmpresa');

                selModal.innerHTML = '<option value="">-- Seleccione --</option>';
                json.data.forEach(e => {
                    selFiltro.innerHTML += `<option value="${e.id}">${e.nombre}</option>`;
                    selModal.innerHTML += `<option value="${e.id}">${e.nombre}</option>`;
                });
            }
        }

        async function cargarPersonal() {
            let empresaId = document.getElementById('movEmpresa').value;
            let sel = document.getElementById('movPersonal');
            sel.innerHTML = '<option value="">Cargando...</option>';

            if(!empresaId) { sel.innerHTML = ''; return; }

            let res = await fetch(`/Activo/GetPersonal?empresaId=${empresaId}`);
            let json = await res.json();

            sel.innerHTML = '<option value="">-- Seleccione --</option>';
            if(json.status) {
                json.data.forEach(p => {
                    sel.innerHTML += `<option value="${p.id}">${p.nombresCompletos} (${p.dni || '-'})</option>`;
                });
            }
        }

        // ======================== LISTADO ========================
        async function cargarMovimientos() {
            let tipo = document.getElementById('filtroTipo').value; // COMPUTO / VEHICULO
            let empresa = document.getElementById('filtroEmpresa').value;
            let buscar = document.getElementById('filtroBuscar').value;

            let url = `/Activo/GetMovimientos?x=1`; // Param dummy
            if(tipo) url += `&tipoActivo=${tipo}`;
            if(empresa) url += `&empresaId=${empresa}`;
            if(buscar) url += `&buscar=${encodeURIComponent(buscar)}`;

            let res = await fetch(url);
            let json = await res.json();
            let tbody = document.getElementById('bodyMovimientos');

            if(!json.status || json.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">No se encontraron movimientos.</td></tr>';
                return;
            }

            let html = '';
            json.data.forEach(m => {
                let colorTipo = m.tipoMovimiento === 'ENTREGA' ? 'text-success' : 'text-danger';
                let iconTipo = m.tipoMovimiento === 'ENTREGA' ? 'fa-arrow-right' : 'fa-arrow-left';

                // Botón Acta: Si tiene rutaActa muestra PDF, sino muestra Subir
                let btnActa = '';
                if(m.rutaActa) {
                    btnActa = `<a href="${m.rutaActa}" target="_blank" class="btn btn-sm btn-outline-success mr-1" title="Ver Acta Firmada"><i class="fas fa-file-pdf"></i></a>`;
                } else {
                    btnActa = `<button class="btn btn-sm btn-outline-secondary mr-1" onclick="abrirModalSubir(${m.id})" title="Subir Acta Firmada"><i class="fas fa-upload"></i></button>`;
                }

                html += `<tr>
                    <td><strong>${m.codigo}</strong></td>
                    <td><span class="${colorTipo} font-weight-bold"><i class="fas ${iconTipo} mr-1"></i>${m.tipoMovimiento}</span></td>
                    <td>${m.fechaMovimiento}</td>
                    <td>${m.empresa}</td>
                    <td>${m.personal}</td>
                    <td><span class="badge badge-info">${m.cantidadActivos} items</span></td>
                    <td><span class="badge badge-light border">${m.estado ? 'REGISTRADO' : 'ANULADO'}</span></td>
                    <td class="text-center">
                        <a href="/Activo/ActaImpresion?id=${m.id}" target="_blank" class="btn btn-sm btn-outline-primary mr-1" title="Imprimir Acta">
                            <i class="fas fa-print"></i>
                        </a>
                        ${btnActa}
                        <button class="btn btn-sm btn-outline-info mr-1" onclick="verDetalleMov(${m.id})"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="eliminarMovimiento(${m.id}, '${m.codigo}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            });
            tbody.innerHTML = html;
        }

        // ======================== NUEVO MOVIMIENTO ========================
        function abrirModalMovimiento() {
            // Resetear form
            document.getElementById('movTipo').value = 'ENTREGA';
            document.getElementById('movFecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('movEmpresa').value = '';
            document.getElementById('movPersonal').innerHTML = '';
            document.getElementById('movObservacion').value = '';
            document.getElementById('busquedaActivo').value = '';
            document.getElementById('listaActivosBusqueda').innerHTML = '<tr><td colspan="2" class="text-center text-muted small">Use el buscador...</td></tr>';

            activosSeleccionados = [];
            renderizarSeleccionados();

            $('#modalMovimiento').modal('show');
        }

        async function buscarActivosParaAgregar() {
            let texto = document.getElementById('busquedaActivo').value.trim();
            if(texto.length < 2) { alert("Ingrese al menos 2 caracteres"); return; }

            let empresaId = document.getElementById('movEmpresa').value;
            if(!empresaId) { alert("Seleccione primero la empresa"); return; }

            let res = await fetch(`/Activo/BuscarActivosParaMovimiento?empresaId=${empresaId}&buscar=${encodeURIComponent(texto)}`);
            let json = await res.json();

            let tbody = document.getElementById('listaActivosBusqueda');
            if(!json.status || json.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" class="text-center text-muted">No se encontraron activos.</td></tr>';
                return;
            }

            let html = '';
            json.data.forEach(a => {
                // Validar si ya está seleccionado
                if(activosSeleccionados.some(s => s.id === a.id)) return;

                let desc = `<strong>${a.codigo}</strong> - ${a.tipo} ${a.marca} ${a.modelo} <br> <small class="text-muted">S/N: ${a.serie || a.placa || '-'}</small>`;

                html += `<tr>
                    <td>${desc}</td>
                    <td class="text-center">
                        <button class="btn btn-xs btn-success" onclick="seleccionarActivo(${a.id}, '${a.codigo}', '${a.tipo} ${a.marca} ${a.modelo}')">
                            <i class="fas fa-plus"></i>
                        </button>
                    </td>
                </tr>`;
            });
            tbody.innerHTML = html || '<tr><td colspan="2" class="text-center text-muted">Todos los resultados ya están seleccionados.</td></tr>';
        }

        function seleccionarActivo(id, codigo, descripcion) {
            activosSeleccionados.push({ id, codigo, descripcion, ubicacion: '' });
            renderizarSeleccionados();
            // Remover de la lista de búsqueda visualmente
            buscarActivosParaAgregar();
        }

        function renderizarSeleccionados() {
            let tbody = document.getElementById('listaActivosSeleccionados');
            if(activosSeleccionados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted small">Ningún activo seleccionado.</td></tr>';
                return;
            }

            let html = '';
            activosSeleccionados.forEach((item, index) => {
                html += `<tr>
                    <td><small><strong>${item.codigo}</strong></small></td>
                    <td><small>${item.descripcion}</small></td>
                    <td class="p-0"><input type="text" class="form-control form-control-sm border-0" placeholder="Ubicación..."
                        value="${item.ubicacion}" onchange="actualizarUbicacion(${index}, this.value)"></td>
                    <td class="text-center">
                        <button class="btn btn-xs btn-outline-danger" onclick="removerSeleccion(${index})"><i class="fas fa-times"></i></button>
                    </td>
                </tr>`;
            });
            tbody.innerHTML = html;
        }

        function actualizarUbicacion(index, val) {
            activosSeleccionados[index].ubicacion = val;
        }

        function removerSeleccion(index) {
            activosSeleccionados.splice(index, 1);
            renderizarSeleccionados();
        }

        async function guardarMovimiento() {
            let empresaId = document.getElementById('movEmpresa').value;
            let personalId = document.getElementById('movPersonal').value;
            let fecha = document.getElementById('movFecha').value;
            let tipo = document.getElementById('movTipo').value;

            if(!empresaId || !personalId || !fecha) { alert("Complete los datos obligatorios (Empresa, Personal, Fecha)"); return; }
            if(activosSeleccionados.length === 0) { alert("Debe seleccionar al menos un activo."); return; }

            let detalle = activosSeleccionados.map(a => ({
                activoId: a.id,
                ubicacion: a.ubicacion,
                observacion: document.getElementById('movObservacion').value
            }));

            let payload = {
                empresaId: parseInt(empresaId),
                personalId: parseInt(personalId),
                tipoMovimiento: tipo,
                fechaMovimiento: fecha,
                observacion: document.getElementById('movObservacion').value,
                items: detalle
            };

            let res = await fetch('/Activo/GuardarMovimiento', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            let json = await res.json();
            if(json.status) {
                alert(json.message);
                $('#modalMovimiento').modal('hide');
                cargarMovimientos();
            } else {
                alert(json.message);
            }
        }

        // ======================== SUBIR ACTA ========================
        function abrirModalSubir(id){
            document.getElementById('uploadMovId').value = id;
            document.getElementById('fileActa').value = null;
            $('.custom-file-label').html('Elegir archivo...');
            $('#modalSubirActa').modal('show');
        }

        async function guardarActaFile(){
            let id = document.getElementById('uploadMovId').value;
            let fileInput = document.getElementById('fileActa');

            if(fileInput.files.length === 0){ alert('Seleccione un archivo'); return; }

            let formData = new FormData();
            formData.append('id', id);
            formData.append('archivo', fileInput.files[0]);

            try {
                let res = await fetch('/Activo/SubirActa', { method: 'POST', body: formData });
                let json = await res.json();

                if(json.status){
                    alert(json.message);
                    $('#modalSubirActa').modal('hide');
                    cargarMovimientos();
                } else {
                    alert(json.message);
                }
            } catch (e) {
                alert("Error al subir archivo");
            }
        }

        // ======================== DETALLE / ELIMINAR ========================
        async function verDetalleMov(id) {
            let res = await fetch(`/Activo/GetMovimientoDetalle?id=${id}`);
            let json = await res.json();

            if(!json.status) { alert(json.message); return; }

            let m = json.cabecera;
            let html = `
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Código:</strong> ${m.codigo}<br>
                        <strong>Tipo:</strong> ${m.tipoMovimiento}<br>
                        <strong>Fecha:</strong> ${m.fecha}<br>
                    </div>
                    <div class="col-md-6">
                        <strong>Empresa:</strong> ${m.empresa}<br>
                        <strong>Personal:</strong> ${m.personal}<br>
                    </div>
                </div>
                <h6><i class="fas fa-boxes mr-1"></i>Activos (${json.detalle.length})</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="thead-light"><tr>
                            <th>Código</th><th>Marca</th><th>Modelo</th><th>Serie/Placa</th><th>Tipo</th><th>Ubicación</th><th>Obs.</th>
                        </tr></thead><tbody>`;

            json.detalle.forEach(d => {
                html += `<tr>
                    <td><strong>${d.codigo}</strong></td><td>${d.marca || ''}</td><td>${d.modelo || ''}</td>
                    <td>${d.numeroSerie || d.placa || ''}</td><td>${d.subtipo || ''}</td>
                    <td>${d.ubicacion || '-'}</td><td>${d.observacion || '-'}</td>
                </tr>`;
            });
            html += '</tbody></table></div>';

            document.getElementById('modalDetalleMovTitulo').textContent = `Movimiento: ${m.codigo}`;
            document.getElementById('contenidoDetalleMov').innerHTML = html;
            $('#modalDetalleMov').modal('show');
        }

        async function eliminarMovimiento(id, codigo) {
            if (!confirm(`¿Eliminar el movimiento ${codigo}? Se liberarán los activos.`)) return;

            let params = new URLSearchParams();
            params.append('id', id);

            let res = await fetch('/Activo/EliminarMovimiento', { method: 'POST', body: params });
            let json = await res.json();
            alert(json.message);
            if (json.status) cargarMovimientos();
        }
    </script>
}