@{
    ViewData["Title"] = "Nuevo Anticipo a Proveedor";
}

<div class="card d-none" id="efec-cargando">
    <div class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center overlay dark" style="z-index: 9999; background: rgba(0,0,0,0.5);">
        <i class="fas fa-3x fa-sync-alt fa-spin text-white"></i>
    </div>
</div>

<div class="container-fluid py-3">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow mb-4 border-left-warning">
                <div class="card-header bg-warning text-dark d-flex justify-content-between">
                    <h5 class="m-0 font-weight-bold"><i class="fas fa-hand-holding-usd"></i> Registrar Anticipo a Proveedor</h5>
                    <span class="badge badge-dark align-self-center px-3">REQ. ORDEN DE COMPRA</span>
                </div>

                <div class="card-body">
                    <div class="row mb-3 p-3 bg-light rounded border mx-1">
                        <div class="col-12 mb-2">
                            <label class="font-weight-bold text-dark">1. Seleccionar Orden Aprobada</label>
                        </div>
                        <div class="col-md-3">
                            <div class="btn-group btn-group-toggle w-100" data-toggle="buttons">
                                <label class="btn btn-outline-dark active" onclick="limpiar()">
                                    <input type="radio" name="optOrigen" value="OC" checked> Orden Compra
                                </label>
                                <label class="btn btn-outline-dark" onclick="limpiar()">
                                    <input type="radio" name="optOrigen" value="OS"> Orden Servicio
                                </label>
                            </div>
                        </div>
                        <div class="col-md-9">
                            <div class="input-group">
                                <input type="text" id="txt_Orden" class="form-control font-weight-bold bg-white" readonly placeholder="Haga clic para buscar..." onclick="abrirModal()">
                                <div class="input-group-append">
                                    <button class="btn btn-dark" type="button" onclick="abrirModal()">
                                        <i class="fas fa-search"></i> BUSCAR
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-2">
                        <div class="col-md-6">
                            <label class="small font-weight-bold text-muted">Proveedor</label>
                            <input type="text" id="txt_Proveedor" class="form-control bg-light" readonly>
                            <input type="hidden" id="hdn_ProveedorId">
                            <input type="hidden" id="hdn_OrdenId">
                        </div>
                        <div class="col-md-2">
                            <label class="small font-weight-bold text-muted">Moneda</label>
                            <input type="text" id="txt_Moneda" class="form-control bg-light text-center font-weight-bold" readonly>
                            <input type="hidden" id="hdn_MonedaId">
                        </div>
                        <div class="col-md-4">
                            <label class="small font-weight-bold text-muted">Total Orden (Ref)</label>
                            <div class="input-group input-group-sm">
                                <div class="input-group-prepend"><span class="input-group-text">S.Total</span></div>
                                <input type="text" id="txt_RefSubTotal" class="form-control bg-light text-right" readonly>
                                <div class="input-group-prepend"><span class="input-group-text">IGV</span></div>
                                <input type="text" id="txt_RefIgv" class="form-control bg-light text-right" readonly>
                                <div class="input-group-prepend"><span class="input-group-text font-weight-bold">Total</span></div>
                                <input type="text" id="txt_RefTotal" class="form-control bg-light text-right font-weight-bold text-dark" readonly>
                            </div>
                        </div>
                    </div>

                    <hr />

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="font-weight-bold text-success">Fecha Emisión</label>
                            <input type="date" id="txt_Fecha" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")" onchange="buscarTC()">
                        </div>
                        <div class="col-md-4">
                            <label class="small font-weight-bold">Tipo de Cambio</label>
                            <input type="number" id="txt_TC" class="form-control bg-light text-center" readonly>
                        </div>
                        <div class="col-md-4">
                            <label class="font-weight-bold text-danger" style="font-size: 1.1em;">Monto del Anticipo</label>
                            <input type="number" id="txt_Monto" class="form-control font-weight-bold text-center border-danger text-danger" style="font-size: 1.2em;" step="0.01" min="0">
                            <small class="text-muted">Este monto generará un saldo a favor.</small>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <label>Observación / Nro Operación</label>
                            <textarea id="txt_Obs" class="form-control" rows="2" placeholder="Ej: Transferencia BCP Nro 998877..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="card-footer text-right">
                    <a href="/CuentasPorPagar/Index" class="btn btn-secondary mr-2">Cancelar</a>
                    <button class="btn btn-warning px-5 font-weight-bold text-dark" onclick="guardar()">
                        <i class="fas fa-save"></i> REGISTRAR ANTICIPO
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalOrden" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content border-warning">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title font-weight-bold">Buscar Orden Aprobada</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th>Acción</th>
                                <th>Número</th>
                                <th>Proveedor</th>
                                <th>Fecha</th>
                                <th class="text-right">Total</th>
                            </tr>
                        </thead>
                        <tbody id="tbl_Ordenes"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        $(document).ready(function() {
            buscarTC();
        });

        // 1. ABRIR MODAL
        function abrirModal() {
            $('#modalOrden').modal('show');
            let tipo = $('input[name="optOrigen"]:checked').val();
            $('#tbl_Ordenes').html('<tr><td colspan="5" class="text-center py-3"><i class="fas fa-spinner fa-spin"></i> Buscando...</td></tr>');

            $.get(`/CuentasPorPagar/BuscarOrdenesPendientes?tipoOrigen=${tipo}`, function(res) {
                let html = '';
                if(res.status && res.data.length > 0) {
                    res.data.forEach(x => {
                        // CORRECCIÓN: Pasamos los valores EXACTOS de BD a la función
                        html += `<tr>
                            <td class="text-center">
                                <button class="btn btn-sm btn-dark font-weight-bold"
                                    onclick="seleccionarOrden(${x.id}, '${x.numero}', '${x.proveedor}', ${x.proveedorId}, ${x.monedaId}, '${x.monedaNombre}', ${x.subTotal}, ${x.igv}, ${x.totalOrden})">
                                    SELECCIONAR
                                </button>
                            </td>
                            <td class="font-weight-bold">${x.numero}</td>
                            <td><small>${x.ruc}</small><br>${x.proveedor}</td>
                            <td>${x.fecha}</td>
                            <td class="text-right font-weight-bold">${x.totalOrden.toFixed(2)} ${x.monedaNombre}</td>
                        </tr>`;
                    });
                    $('#tbl_Ordenes').html(html);
                } else {
                    $('#tbl_Ordenes').html('<tr><td colspan="5" class="text-center text-muted">No se encontraron órdenes aprobadas.</td></tr>');
                }
            });
        }

        // CORRECCIÓN: Recibe parámetros individuales para exactitud
        function seleccionarOrden(id, numero, proveedor, provId, monId, monNombre, subtotal, igv, total) {
            $('#hdn_OrdenId').val(id);
            $('#txt_Orden').val(numero);
            $('#hdn_ProveedorId').val(provId);
            $('#txt_Proveedor').val(proveedor);
            $('#hdn_MonedaId').val(monId);
            $('#txt_Moneda').val(monNombre);

            // ASIGNACIÓN DIRECTA (Sin cálculos)
            $('#txt_RefTotal').val(total.toFixed(2));
            $('#txt_RefSubTotal').val(subtotal.toFixed(2));
            $('#txt_RefIgv').val(igv.toFixed(2));

            $('#modalOrden').modal('hide');
            $('#txt_Monto').focus();
        }

        function limpiar() {
            $('#hdn_OrdenId, #txt_Orden, #hdn_ProveedorId, #txt_Proveedor, #txt_RefTotal').val('');
            $('#txt_RefSubTotal, #txt_RefIgv').val('');
        }

        // 3. TIPO DE CAMBIO
        function buscarTC() {
            let f = $('#txt_Fecha').val();
            if(f) $.get('/TipoCambio/GetTcPorFecha?fecha='+f, function(res) {
                if(res.status) $('#txt_TC').val(res.valor.toFixed(3));
                else $('#txt_TC').val((res.ultimoConocido || 0).toFixed(3));
            });
        }

        // 4. GUARDAR
        function guardar() {
            let ordenId = $('#hdn_OrdenId').val();
            if(!ordenId) return Swal.fire("Falta Información", "Debe seleccionar una Orden de Compra/Servicio obligatoriamente.", "warning");

            let monto = parseFloat($('#txt_Monto').val());
            if(!monto || monto <= 0) return toastr.warning("Ingrese un monto válido mayor a 0.");

            let totalOrden = parseFloat($('#txt_RefTotal').val());
            if(monto > totalOrden) toastr.warning("Advertencia: El anticipo es mayor al total de la orden. (Permitido, pero inusual)");

            let doc = {
                ProveedorId: parseInt($('#hdn_ProveedorId').val()),
                MonedaId: parseInt($('#hdn_MonedaId').val()),
                OrdenCompraId: ($('input[name="optOrigen"]:checked').val() === 'OC') ? parseInt(ordenId) : null,
                OrdenServicioId: ($('input[name="optOrigen"]:checked').val() === 'OS') ? parseInt(ordenId) : null,

                FechaEmision: $('#txt_Fecha').val(),
                TipoCambio: parseFloat($('#txt_TC').val()),
                Total: monto,

                // Anticipo siempre nace con la deuda en el Saldo (como Saldo a Favor)
                // Serie y Numero internos
                Serie: 'ANT',
                Numero: 'AUTO',
                Observacion: $('#txt_Obs').val()
            };

            Swal.fire({
                title: "¿Registrar Anticipo?",
                text: `Se generará un saldo a favor de ${monto.toFixed(2)} vinculado a la orden ${$('#txt_Orden').val()}`,
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#ffc107",
                confirmButtonText: "Sí, Registrar",
                cancelButtonText: "Cancelar"
            }).then((result) => {
                if (result.isConfirmed) {
                    $('#efec-cargando').removeClass('d-none');
                    $.post('/CuentasPorPagar/GuardarAnticipo', {
                        doc: doc,
                        tipoOrigenOrden: $('input[name="optOrigen"]:checked').val()
                    }, function(res) {
                        $('#efec-cargando').addClass('d-none');
                        if(res.status) {
                            Swal.fire("Éxito", res.message, "success").then(() => location.href = '/CuentasPorPagar/Index');
                        } else {
                            Swal.fire("Error", res.message, "error");
                        }
                    }).fail(function() {
                        $('#efec-cargando').addClass('d-none');
                        toastr.error("Error crítico en el servidor.");
                    });
                }
            });
        }
    </script>
}