@{
    ViewData["Title"] = "Registro de Comprobantes";
}

<div class="card d-none" id="efec-cargando">
    <div class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center overlay dark" style="z-index: 9999; background: rgba(0,0,0,0.5);">
        <i class="fas fa-3x fa-sync-alt fa-spin text-white"></i>
    </div>
</div>

<div class="container-fluid py-3">
    <div class="row justify-content-center">
        <div class="col-lg-12">
            <div class="card shadow mb-4 border-left-dark">
                <div class="card-header bg-dark text-white d-flex justify-content-between">
                    <h5 class="m-0 font-weight-bold"><i class="fas fa-file-invoice-dollar"></i> Registro de Comprobante de Pago</h5>
                </div>

                <div class="card-body">
                    <div class="row mb-3 p-3 bg-light rounded border mx-1">
                        <div class="col-12 mb-2"><label class="font-weight-bold text-dark">1. Seleccionar Orden de Origen</label></div>
                        <div class="col-md-3">
                            <div class="btn-group btn-group-toggle w-100" data-toggle="buttons">
                                <label class="btn btn-outline-dark active" onclick="limpiar()"><input type="radio" name="optOrigen" value="OC" checked> Orden Compra</label>
                                <label class="btn btn-outline-dark" onclick="limpiar()"><input type="radio" name="optOrigen" value="OS"> Orden Servicio</label>
                            </div>
                        </div>
                        <div class="col-md-9">
                            <div class="input-group">
                                <input type="text" id="txt_OrdenSeleccionada" class="form-control font-weight-bold bg-white" readonly placeholder="Clic para buscar orden..." onclick="abrirModalBusqueda()" style="cursor: pointer;">
                                <div class="input-group-append"><button class="btn btn-dark" type="button" onclick="abrirModalBusqueda()">BUSCAR</button></div>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-2">
                        <div class="col-md-2">
                            <label class="font-weight-bold">Tipo Comprobante</label>
                            <select id="cbx_TipoDocumento" class="form-control font-weight-bold">
                                <option value="FAC">FACTURA</option>
                                <option value="BOL">BOLETA DE VENTA</option>
                                <option value="RH">RECIBO X HONORARIOS</option>
                            </select>
                        </div>
                        <div class="col-md-3"><label class="font-weight-bold">Serie</label><input type="text" id="txt_Serie" class="form-control text-uppercase" maxlength="10"></div>
                        <div class="col-md-3"><label class="font-weight-bold">Número</label><input type="text" id="txt_Numero" class="form-control" maxlength="20"></div>
                        <div class="col-md-2">
                            <label class="font-weight-bold">Moneda</label>
                            <select id="cbx_Moneda" class="form-control bg-light font-weight-bold" disabled>
                                <option value="1">SOLES (S/.)</option>
                                <option value="2">DÓLARES ($)</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label>IGV</label>
                            <input type="number" id="txt_TASA_IGV" class="form-control" value="0.18" step="0.01" min="0">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="small text-muted">Proveedor</label>
                            <input type="text" id="txt_ProveedorDisplay" class="form-control bg-light" readonly>
                            <input type="hidden" id="hdn_ProveedorId"><input type="hidden" id="hdn_OrdenId">
                        </div>

                        <div class="col-md-2">
                            <label class="small text-muted font-weight-bold">Condición (Orden)</label>
                            <input type="text" id="txt_CondicionPago" class="form-control bg-warning text-dark font-weight-bold text-center" readonly placeholder="---">
                        </div>

                        <div class="col-md-2">
                            <label class="small font-weight-bold">Fecha Emisión</label>
                            <input type="date" id="txt_FechaEmision" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")" onchange="buscarTipoCambio(); calcularVencimiento();">
                        </div>

                        <div class="col-md-2">
                            <label class="small font-weight-bold text-danger">Fecha Vencimiento</label>
                            <input type="date" id="txt_FechaVencimiento" class="form-control border-danger" value="@DateTime.Now.ToString("yyyy-MM-dd")">
                        </div>

                        <div class="col-md-2">
                            <label class="small font-weight-bold">Tipo de Cambio (Ref)</label>
                            <input type="text" id="txtTCRef" class="form-control bg-warning text-dark font-weight-bold text-center border-0" readonly placeholder="---">
                            <small class="text-muted d-block mt-1" id="msgTC">Del día seleccionado</small>
                        </div>

                    </div>

                    <div class="row mt-4">
                        <div class="col-12 mb-2"><h6 class="font-weight-bold text-dark border-bottom pb-2">Detalle</h6></div>
                        <div class="col-12">
                            <div class="table-responsive border rounded" style="max-height: 350px;">
                                <table class="table table-sm table-bordered mb-0 text-center table-hover">
                                    <thead class="bg-secondary text-white small sticky-top">
                                        <tr><th width="5%">Opción</th><th width="45%">Descripción</th><th width="10%">U.M.</th><th width="15%">Cantidad</th><th width="15%">P. Unitario</th><th width="10%">Subtotal</th></tr>
                                    </thead>
                                    <tbody id="tbl_DetalleBody"><tr><td colspan="6" class="text-muted py-5 small">Seleccione una orden...</td></tr></tbody>
                                </table>
                            </div>
                        </div>

                        <div class="col-12 mt-3">
                            <div class="row justify-content-end">
                                <div class="col-md-3">
                                    <div class="input-group input-group-sm mb-1">
                                        <div class="input-group-prepend"><span class="input-group-text font-weight-bold" style="width: 100px;">Subtotal</span></div>
                                        <input type="text" id="txt_SubTotal" class="form-control text-right" readonly value="0.00">
                                    </div>
                                    <div class="input-group input-group-sm mb-1">
                                        <div class="input-group-prepend"><span class="input-group-text font-weight-bold" style="width: 100px;">IGV</span></div>
                                        <input type="text" id="txt_Igv" class="form-control text-right" readonly value="0.00">
                                    </div>
                                    <div class="input-group">
                                        <div class="input-group-prepend"><span class="input-group-text font-weight-bold bg-dark text-white" style="width: 100px;">TOTAL</span></div>
                                        <input type="text" id="txt_TotalPagar" class="form-control font-weight-bold text-right text-dark border-dark" readonly value="0.00">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12"><label>Glosa</label><input type="text" id="txt_Observacion" class="form-control"></div>
                        </div>
                    </div>
                </div>
                <div class="card-footer text-right">
                    <button class="btn btn-dark px-5 font-weight-bold" onclick="guardarProvision()"><i class="fas fa-save"></i> GUARDAR COMPROBANTE</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalBusquedaOrden" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content border-dark">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title font-weight-bold">Buscar Orden Pendiente</h5>
                <button type="button" class="close text-white" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0">
                        <thead class="bg-light"><tr><th>Acción</th><th>Número</th><th>Proveedor</th><th>Fecha</th><th class="text-right">Total Orig.</th></tr></thead>
                        <tbody id="tbl_BodyOrdenes"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        let TASA_IGV = 0.18;

        $(document).ready(function() { 
            buscarTipoCambio();

            $('#txt_TASA_IGV').on('change', function (){
                TASA_IGV = Number($(this).val());
                recalcularTotal();
            });
        });
        
        function buscarTipoCambio() {
            $.get('/TipoCambio/GetTcPorFecha?fecha=' + $('#txt_FechaEmision').val(), function(res) {
                if (res.status) {
                    $('#txtTCRef').val(res.valor.toFixed(3));
                    $('#msgTC').html('<i class="fas fa-check text-success"></i> T.C. encontrado').removeClass('text-danger').addClass('text-success');
                } else {
                    $('#txtTCRef').val('0.000');
                    $('#msgTC').html('<i class="fas fa-exclamation-triangle"></i> ' + res.message).removeClass('text-muted').addClass('text-danger font-weight-bold');
                }
            });
        }

        // --- LÓGICA DE CÁLCULO DE VENCIMIENTO ---
        function calcularVencimiento() {
            let fechaEmision = $('#txt_FechaEmision').val();
            let condicion = $('#txt_CondicionPago').val();

            if (!fechaEmision || !condicion) return;

            let dias = 0;
            // Buscamos números en la cadena (Ej: "CREDITO 30 DIAS" -> 30)
            let match = condicion.match(/\d+/);
            if (match) {
                dias = parseInt(match[0]);
            }

            // Si es contado o no hay número, dias sigue siendo 0
            let fecha = new Date(fechaEmision + 'T00:00:00'); // Forzar zona horaria
            fecha.setDate(fecha.getDate() + dias);

            // Formatear YYYY-MM-DD
            let dia = ("0" + fecha.getDate()).slice(-2);
            let mes = ("0" + (fecha.getMonth() + 1)).slice(-2);
            let anio = fecha.getFullYear();

            $('#txt_FechaVencimiento').val(`${anio}-${mes}-${dia}`);
        }

        // --- SELECCIONAR ORDEN (MODIFICADO) ---
        function seleccionarOrden(id, numero, proveedor, provId, monId) {
            $('#hdn_OrdenId').val(id);
            $('#txt_OrdenSeleccionada').val(numero);
            $('#hdn_ProveedorId').val(provId); $('#txt_ProveedorDisplay').val(proveedor);
            $('#cbx_Moneda').val(monId);

            let tipo = $('input[name="optOrigen"]:checked').val();
            $('#tbl_DetalleBody').html('<tr><td colspan="6" class="text-center">Trayendo ítems...</td></tr>');

            // AHORA TRAEMOS CABECERA
            $.get(`/CuentasPorPagar/GetDetallesOrden?ordenId=${id}&tipoOrigen=${tipo}`, function(res) {

                // 1. LLENAR DATOS DE CABECERA (CONDICIÓN PAGO)
                if(res.status && res.cabecera) {
                    let cond = res.cabecera.condicionPago || "CONTADO";
                    $('#txt_CondicionPago').val(cond);
                    calcularVencimiento(); // Calcular fecha automáticamente
                }

                // 2. LLENAR DETALLES
                let html = '';
                if(res.status && res.data.length > 0) {
                    res.data.forEach(d => {
                        html += `<tr data-ref="${d.id}" class="fila-detalle">
                            <td><button class="btn btn-sm btn-outline-danger" onclick="$(this).closest('tr').remove(); recalcularTotal();"><i class="fas fa-trash"></i></button></td>
                            <td class="text-left"><small>${d.producto}</small></td>
                            <td>${d.unidadMedida}</td>
                            <td><input type="number" class="form-control form-control-sm text-center font-weight-bold txt-cant border-warning" value="${d.saldo}" max="${d.saldo}" min="0" step="0.01" oninput="calcularFila(this)"></td>
                            <td><input type="number" class="form-control form-control-sm text-right txt-precio bg-light" value="${d.precioUnitario}" readonly></td>
                            <td class="font-weight-bold txt-subtotal text-right">${(d.saldo * d.precioUnitario).toFixed(2)}</td>
                        </tr>`;
                    });
                    $('#tbl_DetalleBody').html(html);
                    recalcularTotal();
                }
                $('#modalBusquedaOrden').modal('hide');
            });
        }

        // Resto de funciones (abrirModal, calcularFila, recalcularTotal) igual que antes...
        function abrirModalBusqueda() {
            let tipo = $('input[name="optOrigen"]:checked').val();
            $('#modalBusquedaOrden').modal('show');
            $.get(`/CuentasPorPagar/BuscarOrdenesPendientes?tipoOrigen=${tipo}`, function(res) {
                if (res.status && res.data.length > 0) {
                    let html = '';
                    res.data.forEach(x => {
                        html += `<tr><td class="text-center"><button class="btn btn-sm btn-dark" onclick="seleccionarOrden(${x.id},'${x.numero}','${x.proveedor}',${x.proveedorId},${x.monedaId})"><i class="fas fa-check"></i></button></td><td class="font-weight-bold">${x.numero}</td><td>${x.proveedor}</td><td>${x.fecha}</td><td class="text-right font-weight-bold">${x.totalOrden.toFixed(2)}</td></tr>`;
                    });
                    $('#tbl_BodyOrdenes').html(html);
                } else { $('#tbl_BodyOrdenes').html('<tr><td colspan="5" class="text-center">No hay órdenes pendientes.</td></tr>'); }
            });
        }

        function calcularFila(input) {
            let row = $(input).closest('tr');
            let cant = parseFloat($(input).val()) || 0;
            let precio = parseFloat(row.find('.txt-precio').val()) || 0;
            row.find('.txt-subtotal').text((cant * precio).toFixed(2));
            recalcularTotal();
        }

        function recalcularTotal() {
            let subtotal = 0;
            $('.txt-subtotal').each(function() { subtotal += parseFloat($(this).text()); });
            let tipo = $('#cbx_TipoDocumento').val();
            let tasaIGV = (tipo === 'RH') ? 0 : TASA_IGV;
            let igv = subtotal * tasaIGV;
            let total = subtotal + igv;
            $('#txt_SubTotal').val(subtotal.toFixed(2));
            $('#txt_Igv').val(igv.toFixed(2));
            $('#txt_TotalPagar').val(total.toFixed(2));
        }
        $('#cbx_TipoDocumento').change(function() { recalcularTotal(); });

        function guardarProvision() {
            let ordenId = $('#hdn_OrdenId').val();
            if (!ordenId) return Swal.fire("Atención", "Debe seleccionar una Orden.", "warning");
            if (!$('#txt_Serie').val() || !$('#txt_Numero').val()) return toastr.warning("Ingrese Serie y Número.");

            let total = parseFloat($('#txt_TotalPagar').val());
            if (total <= 0) return toastr.error("El total debe ser mayor a 0.");

            let detalles = [];
            $('#tbl_DetalleBody tr.fila-detalle').each(function() {
                let row = $(this);
                let cant = parseFloat(row.find('.txt-cant').val()) || 0;
                if (cant > 0) {
                    detalles.push({
                        IdReferencia: row.data('ref'),
                        Cantidad: cant,
                        PrecioUnitario: parseFloat(row.find('.txt-precio').val()),
                        Total: parseFloat(row.find('.txt-subtotal').text())
                    });
                }
            });

            let documento = {
                ProveedorId: parseInt($('#hdn_ProveedorId').val()),
                MonedaId: parseInt($('#cbx_Moneda').val()),
                OrdenCompraId: ($('input[name="optOrigen"]:checked').val() === 'OC') ? parseInt(ordenId) : null,
                OrdenServicioId: ($('input[name="optOrigen"]:checked').val() === 'OS') ? parseInt(ordenId) : null,
                Serie: $('#txt_Serie').val(),
                Numero: $('#txt_Numero').val(),
                SubTotal: parseFloat($('#txt_SubTotal').val()),
                MontoIgv: parseFloat($('#txt_Igv').val()),
                Total: total,
                FechaEmision: $('#txt_FechaEmision').val(),
                FechaVencimiento: $('#txt_FechaVencimiento').val(), // <--- ENVIAMOS FECHA VENC
                TipoCambio: parseFloat($('#txtTCRef').val()),
                Observacion: $('#txt_Observacion').val()
            };

            Swal.fire({
                title: "¿Registrar Comprobante?",
                text: `Vence el: ${documento.FechaVencimiento}`,
                icon: "question",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                reverseButtons: true,
                cancelButtonText: "Cancelar",
                confirmButtonText: "Sí, Registrar"
            }).then((result) => {
                if (result.isConfirmed) {
                    $('#efec-cargando').removeClass('d-none');
                    $.ajax({
                        url: '/CuentasPorPagar/GuardarProvision', type: 'POST',
                        data: {
                            doc: documento,
                            codigoTipoDoc: $('#cbx_TipoDocumento').val(),
                            tipoOrigenOrden: $('input[name="optOrigen"]:checked').val(),
                            detallesJson: JSON.stringify(detalles)
                        },
                        success: function(res) {
                            $('#efec-cargando').addClass('d-none');
                            if(res.status) Swal.fire("Registrado", res.message, "success").then(() => location.href = '/CuentasPorPagar/IndexProvisiones');
                            else Swal.fire("Error", res.message, "error");
                        },
                        error: function() { $('#efec-cargando').addClass('d-none'); toastr.error("Error servidor."); }
                    });
                }
            });
        }

        function limpiar() {
            $('#txt_OrdenSeleccionada, #txt_ProveedorDisplay, #txt_CondicionPago').val('');
            $('#hdn_OrdenId, #hdn_ProveedorId').val('');
            $('#tbl_DetalleBody').html('<tr><td colspan="6" class="text-muted py-5 small">Seleccione una orden...</td></tr>');
            recalcularTotal();
        }
    </script>
}