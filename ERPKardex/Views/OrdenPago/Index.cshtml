@{
    ViewData["Title"] = "Tesorería - Gestión de Pagos";
}

<style>
    .border-dashed {
        border: 2px dashed #d1d3e2 !important;
        transition: all 0.3s ease;
    }

        .border-dashed:hover {
            border-color: #4e73df !important;
            background-color: #f8f9fc !important;
        }

    .upload-success {
        border-color: #1cc88a !important;
        background-color: #f0fdf4 !important;
    }

    .cursor-pointer {
        cursor: pointer;
    }

    /* Efecto para el botón de cámara */
    .btn-camera {
        background: #eaecf4;
        border: 1px solid #d1d3e2;
        color: #5a5c69;
        transition: all 0.2s;
    }

        .btn-camera:hover {
            background: #36b9cc;
            color: white;
            border-color: #36b9cc;
        }

        .btn-camera:active {
            transform: scale(0.95);
        }
</style>

<div class="container-fluid py-4">
    <div class="card shadow mb-4 border-top-primary">
        <div class="card-header bg-white border-bottom-0 pt-3 pl-3">
            <ul class="nav nav-tabs card-header-tabs" id="tabPagos" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active font-weight-bold text-primary" id="pendientes-tab" data-toggle="tab" href="#pendientes" role="tab">
                        <i class="fas fa-file-invoice-dollar mr-2"></i> Deudas por Pagar
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link font-weight-bold text-secondary" id="historial-tab" data-toggle="tab" href="#historial" role="tab" onclick="fct_CargarHistorial()">
                        <i class="fas fa-history mr-2"></i> Historial de Pagos
                    </a>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content">
                <div class="tab-pane fade show active" id="pendientes">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <input type="text" id="txtBuscarPendientes" class="form-control bg-light" placeholder="Buscar proveedor, documento...">
                        </div>
                        <div class="col-md-8 text-right">
                            <button class="btn btn-primary btn-sm" onclick="fct_CargarPendientes()"><i class="fas fa-sync-alt"></i> Actualizar</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="tblPendientes" width="100%">
                            <thead class="thead-light text-center font-weight-bold text-dark">
                                <tr>
                                    <th>VENCIMIENTO</th>
                                    <th>DOCUMENTO</th>
                                    <th>EMISIÓN</th>
                                    <th>PROVEEDOR</th>
                                    <th>TOTAL</th>
                                    <th>SALDO PENDIENTE</th>
                                    <th>ACCIÓN</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-pane fade" id="historial">
                    <div class="row mb-3">
                        <div class="col-md-4"><input type="text" id="txtBuscarHistorial" class="form-control bg-light" placeholder="Buscar operación..."></div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="tblHistorial" width="100%">
                            <thead class="thead-light text-center font-weight-bold text-dark">
                                <tr>
                                    <th>FECHA PAGO</th>
                                    <th>N° OP</th>
                                    <th>DOC. CANCELADO</th>
                                    <th>PROVEEDOR</th>
                                    <th>MONTO PAGADO</th>
                                    <th>BANCO / REF</th>
                                    <th>VOUCHER</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalPago" tabindex="-1" data-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title font-weight-bold"><i class="fas fa-hand-holding-usd mr-2"></i> Registrar Salida de Dinero</h5>
                <button type="button" class="close text-white" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body bg-light">
                <form id="frmPago">
                    <input type="hidden" id="hdnIdDocumento">
                    <input type="hidden" id="hdnMonedaId">
                    <input type="hidden" id="hdnSaldoOriginal">

                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-body py-2">
                            <div class="row text-center">
                                <div class="col-md-3 border-right">
                                    <small class="text-muted d-block font-weight-bold">DOCUMENTO</small>
                                    <span id="lblDocumento" class="h6 font-weight-bold text-dark">---</span>
                                </div>
                                <div class="col-md-3 border-right">
                                    <small class="text-muted d-block font-weight-bold">VENCIMIENTO</small>
                                    <span id="lblVencimiento" class="text-danger font-weight-bold">---</span>
                                </div>
                                <div class="col-md-3 border-right">
                                    <small class="text-muted d-block font-weight-bold">TOTAL DOC.</small>
                                    <span id="lblTotal" class="text-dark">---</span>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted d-block font-weight-bold">SALDO ACTUAL</small>
                                    <span id="lblSaldo" class="h5 font-weight-bold text-danger">---</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <h6 class="text-success font-weight-bold mb-3 border-bottom pb-2">Detalle de la Transacción</h6>

                            <div class="form-row">
                                <div class="form-group col-md-4">
                                    <label class="small font-weight-bold">Fecha Pago</label>
                                    <input type="date" id="txtFechaPago" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")">
                                </div>
                                <div class="form-group col-md-4">
                                    <label class="small font-weight-bold">Banco Origen</label>
                                    <select id="cbxBanco" class="form-control"></select>
                                </div>
                                <div class="form-group col-md-4">
                                    <label class="small font-weight-bold text-success">Monto a Pagar</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend"><span class="input-group-text font-weight-bold" id="lblMonedaInput">S/.</span></div>
                                        <input type="number" step="0.01" id="txtMontoPagar" class="form-control font-weight-bold text-success form-control-lg">
                                    </div>
                                </div>
                            </div>

                            <div class="form-row align-items-center">
                                <div class="form-group col-md-12">
                                    <label class="small font-weight-bold">N° Operación / Cheque</label>
                                    <input type="text" id="txtOperacion" class="form-control" placeholder="Ej: 005481">
                                </div>

                                <div class="form-group col-md-12">
                                    <label class="small font-weight-bold">Adjuntar Voucher</label>
                                    <div class="d-flex align-items-stretch" style="height: 85px;">

                                        <div id="dropZone" class="border rounded d-flex flex-column align-items-center justify-content-center border-dashed cursor-pointer bg-white flex-grow-1" style="position: relative;">
                                            <input type="file" id="fileVoucher" class="d-none" accept="image/*,.pdf">

                                            <div class="text-center p-1 w-100 h-100 d-flex flex-column justify-content-center" onclick="$('#fileVoucher').click()">
                                                <i class="fas fa-cloud-upload-alt fa-2x text-secondary mb-1"></i>
                                                <span class="d-block small text-muted lh-1" id="lblVoucher" style="font-size: 0.85em;">
                                                    Arrastre o <span class="text-primary font-weight-bold">Clic aquí</span>
                                                </span>
                                            </div>
                                        </div>

                                        <div class="ml-2">
                                            <button type="button" class="btn btn-camera h-100 d-flex flex-column align-items-center justify-content-center shadow-sm rounded" style="width: 70px;" onclick="$('#fileCamera').click()" title="Tomar Foto">
                                                <i class="fas fa-camera fa-lg mb-1"></i>
                                                <span style="font-size: 0.7em; font-weight: bold;">FOTO</span>
                                            </button>
                                            <input type="file" id="fileCamera" class="d-none" accept="image/*" capture="environment">
                                        </div>

                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="small font-weight-bold">Observación</label>
                                <textarea id="txtObs" class="form-control" rows="2" placeholder="Opcional"></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-white">
                <button type="button" class="btn btn-light border" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success px-4 font-weight-bold shadow-sm" onclick="fct_GuardarPago()">
                    <i class="fas fa-check-circle mr-1"></i> PROCESAR PAGO
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // VARIABLE GLOBAL PARA EL ARCHIVO
        var VOUCHER_ACTUAL = null;

        $(document).ready(function () {
            fct_CargarPendientes();

            $("#txtBuscarPendientes").on("keyup", function() {
                var value = $(this).val().toLowerCase();
                $("#tblPendientes tbody tr").filter(function() { $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1) });
            });

            // --- 2. BUSCADOR DE HISTORIAL (PAGOS) [AGREGADO] ---
            $("#txtBuscarHistorial").on("keyup", function() {
                var value = $(this).val().toLowerCase();
                $("#tblHistorial tbody tr").filter(function() { $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1) });
            });


            // --- LÓGICA DE ARCHIVOS (UNIFICADA) ---

            // 1. Entrada por Archivo (Click/Drag)
            $('#fileVoucher').change(function() { procesarArchivo(this.files[0]); });

            // 2. Entrada por Cámara (Móvil)
            $('#fileCamera').change(function() { procesarArchivo(this.files[0]); });

            // 3. Eventos Drag & Drop
            let dropZone = document.getElementById('dropZone');
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('bg-light'); });
            dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('bg-light'); });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('bg-light');
                if (e.dataTransfer.files.length > 0) procesarArchivo(e.dataTransfer.files[0]);
            });
        });

        // FUNCIÓN ÚNICA PARA PROCESAR EL ARCHIVO (Sea foto o PDF)
        function procesarArchivo(file) {
            if(file) {
                VOUCHER_ACTUAL = file;
                let icono = file.type.includes('pdf') ? '<i class="fas fa-file-pdf text-danger"></i>' : '<i class="fas fa-image text-success"></i>';

                $('#lblVoucher').html(`${icono} <span class="text-dark font-weight-bold">${file.name}</span>`);
                $('#dropZone').addClass('upload-success');
            }
        }

        // 1. CARGAR DEUDAS
        function fct_CargarPendientes() {
            $('#tblPendientes tbody').html('<tr><td colspan="7" class="text-center">Cargando deudas...</td></tr>');
            $.get('/OrdenPago/GetDeudasPendientes', function (res) {
                if (res.status) {
                    let html = '';
                    if(res.data.length === 0) html = '<tr><td colspan="7" class="text-center text-muted py-4">No hay deudas pendientes.</td></tr>';

                    res.data.forEach(x => {
                        let badgeVenc = `<span class="badge ${x.colorSem} w-100 py-2" style="font-size: 0.9em;">${x.estadoVencimiento}<br><small>${x.dias} DÍAS</small></span>`;
                        if(x.tipo === 'ANT') badgeVenc = '<span class="badge badge-info w-100 py-2">ANTICIPO</span>';

                        html += `<tr>
                            <td class="align-middle text-center" style="width: 120px;">${badgeVenc}<br><small class="text-muted">Vence: ${x.vencimiento}</small></td>
                            <td class="align-middle font-weight-bold text-dark">${x.tipo} ${x.numero}</td>
                            <td class="align-middle text-center">${x.emision}</td>
                            <td class="align-middle">${x.proveedor}</td>
                            <td class="align-middle text-right">${x.moneda} ${x.total.toFixed(2)}</td>
                            <td class="align-middle text-right text-danger font-weight-bold" style="font-size: 1.1em;">${x.moneda} ${x.saldo.toFixed(2)}</td>
                            <td class="align-middle text-center">
                                <button class="btn btn-sm btn-success font-weight-bold shadow-sm" onclick="fct_AbrirModal(${x.id})">
                                    <i class="fas fa-hand-holding-usd"></i> PAGAR
                                </button>
                            </td>
                        </tr>`;
                    });
                    $('#tblPendientes tbody').html(html);
                }
            });
        }

        // 2. ABRIR MODAL
        function fct_AbrirModal(id) {
            $('#frmPago')[0].reset();
            $('#hdnIdDocumento').val(id);

            // Resetear lógica de archivos
            VOUCHER_ACTUAL = null;
            $('#lblVoucher').html('Arrastre o <span class="text-primary font-weight-bold">Clic aquí</span>');
            $('#dropZone').removeClass('upload-success');
            $('#fileVoucher, #fileCamera').val(''); // Limpiar inputs reales

            $.get('/OrdenPago/GetDatosDeuda?id=' + id, function(res) {
                if(res.status) {
                    let d = res.data;
                    $('#lblDocumento').text(d.documento);
                    $('#lblVencimiento').text(d.fechaVencimiento);
                    $('#lblTotal').text(d.monedaSimbolo + ' ' + d.total.toFixed(2));
                    $('#lblSaldo').text(d.monedaSimbolo + ' ' + d.saldo.toFixed(2));

                    $('#hdnSaldoOriginal').val(d.saldo);
                    $('#lblMonedaInput').text(d.monedaSimbolo);
                    $('#txtMontoPagar').val(d.saldo.toFixed(2));
                    $('#hdnMonedaId').val(d.monedaId);

                    let htmlB = '<option value="">-- Caja / Efectivo --</option>';
                    res.bancos.forEach(b => htmlB += `<option value="${b.id}">${b.nombre}</option>`);
                    $('#cbxBanco').html(htmlB);

                    $('#modalPago').modal('show');
                }
            });
        }

        // 3. GUARDAR PAGO
        function fct_GuardarPago() {
            let monto = parseFloat($('#txtMontoPagar').val());
            let saldoReal = parseFloat($('#hdnSaldoOriginal').val());

            if(!monto || monto <= 0) return Swal.fire("Error", "Ingrese un monto válido", "warning");
            if(monto > saldoReal + 0.1) return Swal.fire("Error", "El monto supera el saldo pendiente", "error");

            let pago = {
                DocumentoPagarId: $('#hdnIdDocumento').val(),
                MonedaId: $('#hdnMonedaId').val(),
                BancoId: $('#cbxBanco').val() || null,
                NumeroOperacion: $('#txtOperacion').val(),
                Observacion: $('#txtObs').val(),
                MontoPagado: monto
            };

            let formData = new FormData();
            formData.append('pagoJson', JSON.stringify(pago));
            formData.append('fechaPagoReal', $('#txtFechaPago').val());

            // USAMOS LA VARIABLE GLOBAL UNIFICADA
            if(VOUCHER_ACTUAL) formData.append('archivoVoucher', VOUCHER_ACTUAL);

            Swal.fire({
                title: "¿Procesar Pago?",
                text: "Se amortizará la deuda seleccionada.",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: '#1cc88a',
                confirmButtonText: 'Sí, Pagar'
            }).then((r) => {
                if(r.isConfirmed) {
                    $.ajax({
                        url: '/OrdenPago/RegistrarPago', type: 'POST', data: formData, contentType: false, processData: false,
                        success: function(res) {
                            if(res.status) {
                                Swal.fire("¡Pago Exitoso!", res.message, "success");
                                $('#modalPago').modal('hide');
                                fct_CargarPendientes();
                            } else {
                                Swal.fire("Error", res.message, "error");
                            }
                        }
                    });
                }
            });
        }

        function fct_CargarHistorial() {
            $.get('/OrdenPago/GetHistorialPagos', function(res) {
                if(res.status) {
                    let html = '';
                    res.data.forEach(x => {
                        let btnVoucher = x.rutaVoucher ? `<a href="/${x.rutaVoucher}" target="_blank" class="btn btn-sm btn-info"><i class="fas fa-file-image"></i></a>` : '-';
                        html += `<tr>
                            <td>${x.fecha}</td>
                            <td class="font-weight-bold">${x.numeroOP}</td>
                            <td>${x.docRef}</td>
                            <td>${x.proveedor}</td>
                            <td class="text-right font-weight-bold text-success">${x.moneda} ${x.monto.toFixed(2)}</td>
                            <td>${x.banco}<br><small>${x.operacion || ''}</small></td>
                            <td class="text-center">${btnVoucher}</td>
                        </tr>`;
                    });
                    $('#tblHistorial tbody').html(html);
                }
            });
        }
    </script>
}