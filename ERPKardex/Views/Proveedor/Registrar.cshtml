@{
    ViewData["Title"] = ViewBag.Id == 0 ? "Nuevo Proveedor" : "Editar Proveedor";
    int idProveedor = ViewBag.Id;
}

<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="m-0 font-weight-bold"><i class="fas fa-user-tie mr-2"></i> @ViewData["Title"]</h5>
                </div>
                <div class="card-body">
                    <input type="hidden" id="hdn_Id" value="@idProveedor" />

                    <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
                        <li class="nav-item"><a class="nav-link active font-weight-bold" data-toggle="tab" href="#general">1. Datos Generales</a></li>
                        <li class="nav-item"><a class="nav-link font-weight-bold" data-toggle="tab" href="#bancos">2. Información Bancaria</a></li>
                        <li class="nav-item"><a class="nav-link font-weight-bold" data-toggle="tab" href="#contacto">3. Contacto</a></li>
                    </ul>

                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="general">
                            <div class="form-row">
                                <div class="form-group col-md-3"><label class="font-weight-bold">Origen (*)</label><select id="cbx_Origen" class="form-control"></select></div>
                                <div class="form-group col-md-3"><label class="font-weight-bold">Tipo Persona</label><select id="cbx_TipoPersona" class="form-control"></select></div>
                                <div class="form-group col-md-6"><label class="font-weight-bold">Razón Social (*)</label><input type="text" id="txt_RazonSocial" class="form-control text-uppercase"></div>
                            </div>

                            <div class="form-row bg-light p-3 rounded mb-3 border">
                                <div class="form-group col-md-4">
                                    <label class="font-weight-bold text-primary">Tipo Documento (*)</label>
                                    <select id="cbx_TipoDoc" class="form-control font-weight-bold" onchange="configurarInputDoc()"></select>
                                </div>
                                <div class="form-group col-md-4">
                                    <label class="font-weight-bold text-primary">Número Documento (*)</label>
                                    <input type="text" id="txt_NumDoc" class="form-control font-weight-bold border-primary">
                                    <small id="lbl_HelpDoc" class="text-muted"></small>
                                </div>
                                <div class="form-group col-md-4">
                                    <label class="font-weight-bold">Estado</label>
                                    <select id="cbx_Estado" class="form-control"><option value="1">ACTIVO</option><option value="0">INACTIVO</option></select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group col-md-3"><label>País</label><select id="cbx_Pais" class="form-control select2" onchange="filtrarCiudades()"></select></div>
                                <div class="form-group col-md-3"><label>Ciudad</label><select id="cbx_Ciudad" class="form-control select2"></select></div>
                                <div class="form-group col-md-6"><label>Dirección Fiscal</label><input type="text" id="txt_Direccion" class="form-control"></div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="bancos">
                            <div class="form-row mb-3">
                                <div class="form-group col-md-4">
                                    <label class="font-weight-bold">Banco Principal</label>
                                    <select id="cbx_Banco" class="form-control select2"></select>
                                </div>
                                <div class="form-group col-md-4">
                                    <label class="font-weight-bold">Código SWIFT</label>
                                    <input type="text" id="txt_Swift" class="form-control text-uppercase">
                                </div>
                                <div class="form-group col-md-4">
                                    <label class="font-weight-bold text-info">Cuenta Detracciones (BN)</label>
                                    <input type="text" id="txt_Detraccion" class="form-control border-info" placeholder="Banco de la Nación">
                                </div>
                            </div>

                            <h6 class="text-primary font-weight-bold mb-3 border-bottom">Cuentas Comerciales</h6>

                            <div class="card mb-2 border-left-primary">
                                <div class="card-body p-2">
                                    <div class="form-row align-items-center">
                                        <div class="col-md-1 text-center font-weight-bold text-primary">CTA 1</div>
                                        <div class="col-md-3"><select id="cbx_Moneda1" class="form-control form-control-sm cbx-moneda"></select></div>
                                        <div class="col-md-4"><input type="text" id="txt_Cuenta1" class="form-control form-control-sm" placeholder="N° Cuenta"></div>
                                        <div class="col-md-4"><input type="text" id="txt_Cci1" class="form-control form-control-sm" placeholder="CCI"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="card mb-2 border-left-success">
                                <div class="card-body p-2">
                                    <div class="form-row align-items-center">
                                        <div class="col-md-1 text-center font-weight-bold text-success">CTA 2</div>
                                        <div class="col-md-3"><select id="cbx_Moneda2" class="form-control form-control-sm cbx-moneda"></select></div>
                                        <div class="col-md-4"><input type="text" id="txt_Cuenta2" class="form-control form-control-sm" placeholder="N° Cuenta"></div>
                                        <div class="col-md-4"><input type="text" id="txt_Cci2" class="form-control form-control-sm" placeholder="CCI"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="card mb-2 border-left-warning">
                                <div class="card-body p-2">
                                    <div class="form-row align-items-center">
                                        <div class="col-md-1 text-center font-weight-bold text-warning">CTA 3</div>
                                        <div class="col-md-3"><select id="cbx_Moneda3" class="form-control form-control-sm cbx-moneda"></select></div>
                                        <div class="col-md-4"><input type="text" id="txt_Cuenta3" class="form-control form-control-sm" placeholder="N° Cuenta"></div>
                                        <div class="col-md-4"><input type="text" id="txt_Cci3" class="form-control form-control-sm" placeholder="CCI"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="contacto">
                            <div class="form-row">
                                <div class="form-group col-md-6"><label>Nombre Completo</label><input type="text" id="txt_ContactoNombre" class="form-control"></div>
                                <div class="form-group col-md-6"><label>Cargo</label><input type="text" id="txt_ContactoCargo" class="form-control"></div>
                                <div class="form-group col-md-6"><label>Correo</label><input type="email" id="txt_Email" class="form-control"></div>
                                <div class="form-group col-md-6"><label>Teléfono</label><input type="text" id="txt_Telefono" class="form-control"></div>
                            </div>
                        </div>
                    </div>

                    <div class="text-right mt-4 pt-3 border-top">
                        <a href="/Proveedor/Index" class="btn btn-secondary mr-2">Cancelar</a>
                        <button class="btn btn-success px-4 font-weight-bold" onclick="guardar()"><i class="fas fa-save mr-1"></i> GUARDAR</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var CIUDADES_FULL = [];

        $(document).ready(function() {
            $('.select2').select2({ theme: 'bootstrap4' });
            cargarCombosIniciales();
        });

        function cargarCombosIniciales() {
            $.get('/Proveedor/GetCombosMaestros', function(res) {
                if(res.status) {
                    res.tiposDoc.forEach(x => $('#cbx_TipoDoc').append(`<option value="${x.id}" data-len="${x.longitud || 0}" data-alfa="${x.esAlfanumerico}">${x.descripcion}</option>`));
                    res.origenes.forEach(x => $('#cbx_Origen').append(`<option value="${x.id}">${x.nombre}</option>`));
                    res.tiposPersona.forEach(x => $('#cbx_TipoPersona').append(`<option value="${x.id}">${x.nombre}</option>`));
                    res.paises.forEach(x => $('#cbx_Pais').append(`<option value="${x.id}">${x.nombre}</option>`));
                    res.bancos.forEach(x => $('#cbx_Banco').append(`<option value="${x.id}">${x.nombre}</option>`));
                    CIUDADES_FULL = res.ciudades;

                    let optMon = '<option value="">-- Moneda --</option>';
                    res.monedas.forEach(x => optMon += `<option value="${x.id}">${x.nombre} (${x.simbolo})</option>`);
                    $('.cbx-moneda').html(optMon);

                    let id = $('#hdn_Id').val();
                    if(id > 0) cargarDatos(id);
                    else { configurarInputDoc(); filtrarCiudades(); }
                }
            });
        }

        function filtrarCiudades() {
            let paisId = $('#cbx_Pais').val();
            let ciudades = CIUDADES_FULL.filter(x => x.paisId == paisId);
            let html = '<option value="">-- Seleccione --</option>';
            ciudades.forEach(c => html += `<option value="${c.id}">${c.nombre}</option>`);
            $('#cbx_Ciudad').html(html);
        }

        function configurarInputDoc() {
            let opt = $('#cbx_TipoDoc option:selected');

            let len = opt.data('len');
            let esAlfa = opt.data('alfa');

            let input = $('#txt_NumDoc');
            input.val('');

            input.attr('maxlength', len > 0 ? len : 50);

            let msg = len > 0 ? `Debe tener exactamente ${len} dígitos.` : 'Longitud variable (Máx. 50 caracteres).';
            if(!esAlfa) msg += " Solo números.";
            else msg += " Acepta letras y números.";

            $('#lbl_HelpDoc').text(msg);

            input.off('keypress');

            if(!esAlfa) {
                input.on('keypress', function(e) { return /[0-9]/.test(e.key); });
            }
        }

        function cargarDatos(id) {
            $.get('/Proveedor/Obtener?id=' + id, function(res) {
                if(res.status) {
                    let d = res.data;
                    $('#cbx_Origen').val(d.origenId); $('#cbx_TipoPersona').val(d.tipoPersonaId);
                    $('#cbx_TipoDoc').val(d.tipoDocumentoIdentidadId); configurarInputDoc(); $('#txt_NumDoc').val(d.numeroDocumento);

                    $('#txt_RazonSocial').val(d.razonSocial); $('#txt_Direccion').val(d.direccion);
                    $('#cbx_Pais').val(d.paisId).trigger('change'); filtrarCiudades(); $('#cbx_Ciudad').val(d.ciudadId).trigger('change');
                    $('#cbx_Estado').val(d.estado ? "1" : "0");

                    $('#txt_ContactoNombre').val(d.nombreContacto); $('#txt_ContactoCargo').val(d.cargoContacto);
                    $('#txt_Email').val(d.correoElectronico); $('#txt_Telefono').val(d.telefono);

                    $('#cbx_Banco').val(d.bancoId).trigger('change');
                    $('#txt_Swift').val(d.codigoSwift);
                    $('#txt_Detraccion').val(d.numeroCuentaDetracciones); // <--- CARGAMOS EL VALOR

                    $('#cbx_Moneda1').val(d.monedaIdUno); $('#txt_Cuenta1').val(d.numeroCuentaUno); $('#txt_Cci1').val(d.numeroCciUno);
                    $('#cbx_Moneda2').val(d.monedaIdDos); $('#txt_Cuenta2').val(d.numeroCuentaDos); $('#txt_Cci2').val(d.numeroCciDos);
                    $('#cbx_Moneda3').val(d.monedaIdTres); $('#txt_Cuenta3').val(d.numeroCuentaTres); $('#txt_Cci3').val(d.numeroCciTres);
                }
            });
        }

        function guardar() {
            if(!$('#txt_RazonSocial').val()) return Swal.fire("Aviso", "Ingrese Razón Social", "warning");
            if(!$('#txt_NumDoc').val()) return Swal.fire("Aviso", "Ingrese Documento", "warning");

            let opt = $('#cbx_TipoDoc option:selected');
            let len = opt.data('len');

            if(len > 0 && $('#txt_NumDoc').val().length !== len) {
                return Swal.fire("Atención", `El ${opt.text()} debe tener exactamente ${len} dígitos.`, "warning");
            }

            let modelo = {
                Id: $('#hdn_Id').val(),
                OrigenId: $('#cbx_Origen').val(), TipoPersonaId: $('#cbx_TipoPersona').val(),
                TipoDocumentoIdentidadId: $('#cbx_TipoDoc').val(), NumeroDocumento: $('#txt_NumDoc').val(),
                RazonSocial: $('#txt_RazonSocial').val(), Direccion: $('#txt_Direccion').val(),
                PaisId: $('#cbx_Pais').val(), CiudadId: $('#cbx_Ciudad').val(),
                NombreContacto: $('#txt_ContactoNombre').val(), CargoContacto: $('#txt_ContactoCargo').val(),
                CorreoElectronico: $('#txt_Email').val(), Telefono: $('#txt_Telefono').val(),

                // Bancos
                BancoId: $('#cbx_Banco').val(),
                CodigoSwift: $('#txt_Swift').val(),
                NumeroCuentaDetracciones: $('#txt_Detraccion').val(), // <--- ENVIAMOS EL VALOR

                MonedaIdUno: $('#cbx_Moneda1').val(), NumeroCuentaUno: $('#txt_Cuenta1').val(), NumeroCciUno: $('#txt_Cci1').val(),
                MonedaIdDos: $('#cbx_Moneda2').val(), NumeroCuentaDos: $('#txt_Cuenta2').val(), NumeroCciDos: $('#txt_Cci2').val(),
                MonedaIdTres: $('#cbx_Moneda3').val(), NumeroCuentaTres: $('#txt_Cuenta3').val(), NumeroCciTres: $('#txt_Cci3').val(),
                Estado: $('#cbx_Estado').val() === "1"
            };

            $.post('/Proveedor/Guardar', { modelo: modelo }, function(res) {
                if(res.status) Swal.fire("Éxito", res.message, "success").then(() => window.location.href = '/Proveedor/Index');
                else Swal.fire("Error", res.message, "error");
            });
        }
    </script>
}