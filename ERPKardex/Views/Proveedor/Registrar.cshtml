@{
    ViewData["Title"] = ViewBag.Id == 0 ? "Nuevo Proveedor" : "Editar Proveedor";
    int idProveedor = ViewBag.Id;
}

<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="m-0 font-weight-bold">
                        <i class="fas fa-user-tag"></i> @(idProveedor == 0 ? "Registro de Proveedor" : "Edición de Proveedor")
                    </h5>
                </div>
                <div class="card-body">
                    <input type="hidden" id="hdn_Id" value="@idProveedor" />

                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label class="font-weight-bold">RUC (*)</label>
                            <input type="text" id="txt_Ruc" class="form-control" placeholder="Ingrese 11 dígitos" maxlength="11" onkeypress="return /[0-9]/i.test(event.key)">
                        </div>
                        <div class="form-group col-md-6">
                            <label class="font-weight-bold">Teléfono</label>
                            <input type="text" id="txt_Telefono" class="form-control" placeholder="Celular o Fijo">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="font-weight-bold">Razón Social (*)</label>
                        <input type="text" id="txt_RazonSocial" class="form-control" placeholder="Nombre de la empresa o persona">
                    </div>

                    <div class="form-group">
                        <label class="font-weight-bold">Nombre de Contacto (*)</label>
                        <input type="text" id="txt_NombreContacto" class="form-control" placeholder="Nombre de la persona de contacto">
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label class="font-weight-bold">Correo Electrónico</label>
                            <input type="email" id="txt_Email" class="form-control" placeholder="contacto@empresa.com">
                        </div>

                        <div class="form-group col-md-6">
                            <label class="font-weight-bold">Estado</label>
                            <select id="cbo_Estado" class="form-control">
                                <option value="1">ACTIVO</option>
                                <option value="0">INACTIVO (DE BAJA)</option>
                            </select>
                            <small class="text-muted">Utilice "INACTIVO" para dar de baja si ya tiene historial.</small>
                        </div>
                    </div>

                    <h6 class="text-success font-weight-bold mt-3 mb-3 border-bottom pb-2">Información Financiera</h6>
                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label>Banco</label>
                            <select id="cbxBanco" class="form-control">
                                <option value="">-- Seleccione --</option>
                            </select>
                        </div>
                        <div class="form-group col-md-4">
                            <label>N° Cuenta</label>
                            <input type="text" class="form-control" id="txtCuenta" placeholder="Cta. Corriente / Ahorros">
                        </div>
                        <div class="form-group col-md-4">
                            <label>CCI</label>
                            <input type="text" class="form-control" id="txtCci" placeholder="Código Interbancario">
                        </div>
                        <div class="form-group col-md-12">
                            <label>Cta. Detracciones (Banco Nación)</label>
                            <input type="text" class="form-control bg-light" id="txtDetraccion" placeholder="00-000-00000">
                        </div>
                    </div>
                    <hr />
                    <div class="text-right">
                        <a href="/Proveedor/Index" class="btn btn-secondary mr-2">
                            <i class="fas fa-arrow-left"></i> Volver
                        </a>
                        <button class="btn btn-success px-4" onclick="guardar()">
                            <i class="fas fa-save"></i> GUARDAR
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Cargar bancos y luego verificar si hay datos para editar
            fct_CargarBancos();
        });

        // 1. CARGAR BANCOS
        function fct_CargarBancos() {
            $.get('/Proveedor/GetBancosCombo', function (res) {
                if (res.status) {
                    let html = '<option value="">-- Sin Banco --</option>';
                    res.data.forEach(b => {
                        html += `<option value="${b.id}">${b.nombre}</option>`;
                    });
                    $('#cbxBanco').html(html);

                    // Una vez cargado el combo, cargamos la data si es edición
                    let id = $('#hdn_Id').val();
                    if(id > 0) {
                        cargarDatos(id);
                    } else {
                        $('#cbo_Estado').val("1");
                    }
                }
            });
        }

        function cargarDatos(id) {
            $.get('/Proveedor/Obtener?id=' + id, function(res) {
                if(res.status) {
                    // Datos Generales
                    $('#txt_Ruc').val(res.data.ruc);
                    $('#txt_RazonSocial').val(res.data.razonSocial);
                    $('#txt_NombreContacto').val(res.data.nombreContacto);
                    $('#txt_Telefono').val(res.data.telefono);
                    $('#txt_Email').val(res.data.email);
                    $('#cbo_Estado').val(res.data.estado ? "1" : "0");

                    // Datos Financieros (AQUÍ ESTÁ LA MAGIA)
                    $('#cbxBanco').val(res.data.bancoId);
                    $('#txtCuenta').val(res.data.numeroCuenta);
                    $('#txtCci').val(res.data.numeroCci);
                    $('#txtDetraccion').val(res.data.numeroDetraccion);

                } else {
                    Swal.fire("Error", "No se pudo cargar la información.", "error");
                }
            });
        }

        function guardar() {
            // Validaciones
            let ruc = $('#txt_Ruc').val().trim();
            let razon = $('#txt_RazonSocial').val().trim();
            let nombreContacto = $('#txt_NombreContacto').val().trim();

            if(!ruc || ruc.length < 11) return Swal.fire("Aviso", "El RUC debe tener 11 dígitos.", "warning");
            if(!razon) return Swal.fire("Aviso", "Ingrese la Razón Social.", "warning");
            if(!nombreContacto) return Swal.fire("Aviso", "Ingrese el nombre de contacto.", "warning");

            let modelo = {
                Id: $('#hdn_Id').val(),
                Ruc: ruc,
                RazonSocial: razon,
                NombreContacto: nombreContacto,
                Telefono: $('#txt_Telefono').val(),
                Email: $('#txt_Email').val(),

                // Nuevos Campos Financieros
                BancoId: $('#cbxBanco').val() || null, // Enviamos null si está vacío
                NumeroCuenta: $('#txtCuenta').val(),
                NumeroCci: $('#txtCci').val(),
                NumeroDetraccion: $('#txtDetraccion').val(),

                Estado: $('#cbo_Estado').val() === "1"
            };

            $.post('/Proveedor/Guardar', { modelo: modelo }, function(res) {
                if(res.status) {
                    Swal.fire("Éxito", res.message, "success").then(() => {
                        window.location.href = '/Proveedor/Index';
                    });
                } else {
                    Swal.fire("Error", res.message, "error");
                }
            });
        }
    </script>
}