@{
    ViewData["Title"] = "Gestión de Centros de Costo";
    var empresaId = User.FindFirst("EmpresaId")?.Value;
    bool esAdmin = ViewBag.EsAdmin ?? false;
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />

<div class="row">
    <div class="col-md-4">
        <div class="card shadow">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fa fa-sitemap"></i> Estructura Jerárquica</h5>
            </div>
            <div class="card-body">
                <input type="text" id="txtBuscarArbol" class="form-control mb-3" placeholder="🔍 Buscar nodo..." />
                <div id="arbolCC" style="overflow-x:auto; min-height:400px;"></div>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fa fa-list"></i> Listado General</h5>
                @if (esAdmin)
                {
                    <button class="btn btn-success btn-sm" onclick="fct_Nuevo()">
                        <i class="fa fa-plus"></i> Nuevo Centro Costo
                    </button>
                }
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="tablaCC" class="table table-striped table-bordered w-100 text-sm">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Tipo cuenta</th>
                                <th>F. Inicio</th>
                                <th>F. Fin</th>
                                <th>Nombre</th>
                                <th>Padre</th>
                                <th>Imputable</th>
                                <th>C. Abono</th>
                                <th>C. Cargo</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modal-container">
    @await Html.PartialAsync("_ModalCentroCosto")
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>
    <script>
        var esAdmin = @(esAdmin ? "true" : "false");
        var tabla;
        $(document).ready(function () {
            var windowHeight = $('body > div.wrapper > div.content-wrapper').height() / 2;
            //CONFIGURACION POR DEFECTO DATATABLES
            $.extend($.fn.dataTable.defaults, {
                dom: "<'row align-items-center'<'col-sm-8 justify-content-start'f><'col-sm-4 c1 d-flex justify-content-end'>>" + "<'row align-items-center'<'col-sm-6'l><'col-sm-6 my-3 justify-content-start d-flex'B>" + "<'col-sm-6'i><'col-sm-6 mb-3 d-flex justify-content-end'p>" + "rt" + "<'col-sm-6'i><'col-sm-6 mt-1 d-flex justify-content-end'p>",
                // dom: "<'row pb-1'<'col-sm-9 d-flex'B><'col-sm-3 c1 d-flex justify-content-end'>>" + "<'row'<'col-sm-4'l><'col-sm-8 justify-content-start'f>>" + "<'row'<'col-sm-6'i><'col-sm-6 d-flex justify-content-end'p>>" + "rt" + "<'row'<'col-sm-6'i><'col-sm-6 mt-1 d-flex justify-content-end'p>>",
                // dom: "<'row pb-1'<'col-sm-9'B><'col-sm-3 c1 d-flex justify-content-end'>>" + "<'row'<'col-sm-10'l><'col-sm-2'f>>" + "<'row'<'col-sm-6'i><'col-sm-6'p>>" + "rt" + "<'row'<'col-sm-6'i><'col-sm-6'p>>",
                // dom: "<'row pb-1'<'col-sm-10'B><'col-sm-2 c1 d-flex justify-content-end'>>" + "<'row'<'col-sm-11'l><'col-sm-1'f>>" + "<'row'<'col-sm-10'i><'col-sm-2'p>>" + "rt" + "<'row'<'col-sm-10'i><'col-sm-2'p>>",
                paging: true,
                select: true,
                scroller: false,
                deferRender: true,
                scrollY: windowHeight,
                scrollX: true,
                fixedHeader: true,
                ordering: true,
                destroy: true,
                responsive: true,
                autoWidth: false,
                processing: true,
                filter: true,
                orderMulti: true,
                stateSave: false,
                serverSide: false,
                language: {
                    processing: "Procesando...",
                    sSearch: "Buscar:",
                    lengthMenu: "Mostrar _MENU_ registros",
                    info: "Mostrando del _START_ al _END_ de un total de _TOTAL_ registros",
                    infoEmpty: "Sin registros encontrados.",
                    infoFiltered: "(Total de _MAX_ registros filtrados)",
                    loadingRecords: "Cargando...",
                    zeroRecords: "No se encontraron registros",
                    emptyTable: "No hay datos disponibles en la tabla",
                    paginate: {
                        previous: "Anterior",
                        next: "Siguiente",
                        first: "Primero",
                        last: "Último",
                    },
                    aria: {
                        sortAscending: ": Activar para ordenar la columna de manera ascendente",
                        sortDescending: ": Activar para ordenar la columna de manera descendente"
                    },
                    select: {
                        rows: {
                            _: "%d filas seleccionadas",
                            0: "Haz clic en una fila para seleccionarla",
                            1: "1 fila seleccionada"
                        }
                    },
                    buttons: {
                        copyTitle: 'Copiado en el portapapeles',
                        copyKeys: 'Presiona <i>ctrl</i> o <i>\u2318</i> + <i>C</i> para copiar los datos de la tabla a tu portapapeles. <br><br>Para cancelar, haga clic en este mensaje o presione Esc.',
                        copySuccess: {
                            _: '%d registros copiados correctamente',
                            1: '1 registro copiado correctamente'
                        }
                    }
                },
                lengthMenu: [[100, 200, 500, -1], [100, 200, 500, 'Todos']],
            });

            CargarArbol();
            CargarTabla();
            CargarCombos(); // Llenar selects al inicio
        });

        // --- ÁRBOL JSTREE ---
        function CargarArbol() {
            $('#arbolCC').jstree({
                'core': {
                    'data': {
                        'url': '/CentroCosto/GetArbolCentrosCosto',
                        'dataType': 'json'
                    },
                    'themes': { 'responsive': true }
                },
                'plugins': ['search', 'types']
            });

            // Buscador del árbol
            var to = false;
            $('#txtBuscarArbol').keyup(function () {
                if (to) { clearTimeout(to); }
                to = setTimeout(function () {
                    var v = $('#txtBuscarArbol').val();
                    $('#arbolCC').jstree(true).search(v);
                }, 250);
            });
        }

        // --- TABLA CRUD ---
        function CargarTabla() {
            tabla = $('#tablaCC').DataTable({
                language: {
                    processing: "Procesando...",
                    sSearch: "Buscar:",
                    lengthMenu: "Mostrar _MENU_ registros",
                    info: "Mostrando del _START_ al _END_ de un total de _TOTAL_ registros",
                    infoEmpty: "Sin registros encontrados.",
                    infoFiltered: "(Total de _MAX_ registros filtrados)",
                    loadingRecords: "Cargando...",
                    zeroRecords: "No se encontraron registros",
                    emptyTable: "No hay datos disponibles en la tabla",
                    paginate: {
                        previous: "Anterior",
                        next: "Siguiente",
                        first: "Primero",
                        last: "Último",
                    },
                    aria: {
                        sortAscending: ": Activar para ordenar la columna de manera ascendente",
                        sortDescending: ": Activar para ordenar la columna de manera descendente"
                    },
                    select: {
                        rows: {
                            _: "%d filas seleccionadas",
                            0: "Haz clic en una fila para seleccionarla",
                            1: "1 fila seleccionada"
                        }
                    },
                    buttons: {
                        copyTitle: 'Copiado en el portapapeles',
                        copyKeys: 'Presiona <i>ctrl</i> o <i>\u2318</i> + <i>C</i> para copiar los datos de la tabla a tu portapapeles. <br><br>Para cancelar, haga clic en este mensaje o presione Esc.',
                        copySuccess: {
                            _: '%d registros copiados correctamente',
                            1: '1 registro copiado correctamente'
                        }
                    }
                },
                buttons: [
                    {
                        extend: 'copy',
                        text: '<i class="bi bi-back"></i>',
                        titleAttr: 'Copiar en portapapeles',
                        className: 'btn btn-primary',
                    },
                    {
                        extend: 'excel',
                        text: '<i class="bi bi-file-earmark-excel"></i>',
                        titleAttr: 'Exportar a Excel',
                        className: 'btn btn-success',
                        filename: 'Centros de costo ' + moment().format('DD-MM-YYYY HH_mm'),
                        footer: true,
                        exportOptions:
                        {
                            stripHtml: true,
                            columns: ':not(:last-child)'
                        },
                    },
                    {
                        extend: 'pdf',
                        text: '<i class="bi bi-file-earmark-pdf"></i>',
                        titleAttr: 'Exportar a PDF',
                        className: 'btn btn-danger',
                        filename: 'Centros de costo ' + moment().format('DD-MM-YYYY HH_mm'),
                        exportOptions:
                        {
                            stripHtml: true,
                            columns: ':not(:last-child)'
                        },
                        orientation: 'landscape',
                        pageSize: 'LEGAL',
                    },
                    {
                        extend: 'print',
                        text: '<i class="bi bi-printer-fill"></i>',
                        titleAttr: 'Imprimir',
                        className: 'btn btn-info',
                        exportOptions:
                        {
                            stripHtml: true,
                            columns: ':not(:last-child)'
                        },
                    },
                    {
                        extend: 'colvis',
                        text: '<i class="bi bi-ui-checks"></i>',
                        titleAttr: 'Seleccionar',
                        className: 'btn btn-warning',
                        columns: ':not(.noVis)',
                    },
                ],
                "ajax": {
                    "url": "/CentroCosto/ListarTodo",
                    "type": "GET",
                    "datatype": "json"
                },
                "columns": [
                    { "data": "codigo" },
                    { 
                        "data": null, 
                        render: function(data, type, row) {
                            return `${data.numeroCuenta} - ${data.tipoCuenta}`
                        },
                    },
                    { "data": "fechaInicio" },
                    { "data": "fechaFin" },
                    { "data": "nombre" },
                    { "data": "padre" },
                    {
                        "data": "esImputable",
                        "render": function(data) {
                            return data ? '<span class="badge badge-success">Sí</span>' : '<span class="badge badge-warning">No</span>';
                        }
                    },
                    { "data": "cuentaAbono" },
                    { "data": "cuentaCargo" },
                    {
                        "data": "id",
                        "className": "text-center align-middle",
                        "render": function (data) {
                            if (esAdmin) {
                                return `<button class="btn btn-primary btn-sm" onclick="fct_Editar(${data})"><i class="fa fa-edit"></i></button>
                                        <button class="btn btn-danger btn-sm" onclick="fct_Eliminar(${data})"><i class="fa fa-trash"></i></button>`;
                            } else {
                                return `<span class="text-muted small"><i class="fas fa-lock"></i></span>`;
                            }
                        }
                    }
                ],
                lengthMenu: [[100, 200, 500, -1], [100, 200, 500, 'Todos']],
                initComplete: function (data, row, cell, start, end, display) {
                    $('.dt-buttons button').addClass('m-1');
                    $('.dt-button-collection').appendTo('.dt-buttons');
                    $('.btn.btn-success').removeClass('dt-button btn-secondary buttons-excel buttons-html5');
                    $('.btn.btn-danger').removeClass('dt-button btn-secondary buttons-pdf buttons-html5');
                    $('.btn.btn-primary').removeClass('dt-button btn-secondary buttons-copy buttons-html5');
                    $('.btn.btn-info').removeClass('dt-button btn-secondary buttons-print');
                    $('.btn.btn-warning').removeClass('dt-button btn-secondary buttons-collection buttons-colvis');
                },
            });
        }

        // --- COMBOS ---
        function CargarCombos() {
            // Select2 para Tipos de Cuenta
            $.get('/CentroCosto/GetComboTipoCuenta', function (res) {
                var options = '<option value="">-- Seleccione --</option>';
                res.forEach(e => options += `<option value="${e.id}">${e.text}</option>`);
                $('#cboTipoCuenta').html(options);
            });

            // Select2 para Empresas
            $.get('/CentroCosto/GetComboEmpresas', function (res) {
                var options = '<option value="">-- Seleccione Empresa --</option>';
                res.forEach(e => options += `<option value="${e.id}">${e.text}</option>`);
                $('#cboEmpresa').html(options);
            });

            // Evento: Al cambiar empresa, recargar padres
            $('#cboEmpresa').change(function() {
                var empId = $(this).val();
                CargarComboPadres(empId);
            });
        }

        function CargarComboPadres(empresaId, padreSeleccionado = null) {
            $.get('/CentroCosto/GetComboPadres?empresaId=' + empresaId, function (res) {
                var options = '<option value="">[RAÍZ - SIN PADRE]</option>';
                res.forEach(e => options += `<option value="${e.id}">${e.text}</option>`);
                $('#cboPadre').html(options);
                if(padreSeleccionado) $('#cboPadre').val(padreSeleccionado);
            });
        }

        // --- ACCIONES ---
        function fct_Nuevo() {
            $('#hdId').val(0);
            $('#frmCentroCosto')[0].reset();
            $('#tituloModal').text('Nuevo Centro de Costo');
            // Setear defaults si quieres
            $('#modalCentroCosto').modal('show');
        }

        function fct_Editar(id) {
            $.get('/CentroCosto/Obtener?id=' + id, function (res) {
                if (res.status) {
                    var d = res.data;
                    $('#hdId').val(d.id);
                    $('#cboEmpresa').val(d.empresaId).trigger('change'); // Dispara carga de padres

                    // Esperar un poco para que cargue el combo padres o usar promesa
                    setTimeout(() => { $('#cboPadre').val(d.padreId); }, 500);

                    $('#txtCodigo').val(d.codigo);
                    $('#txtNombre').val(d.nombre);
                    $('#cboImputable').val(d.esImputable.toString());

                    // Fechas (Formatear a yyyy-MM-dd para input date)
                    if(d.fechaInicio) $('#txtFechaInicio').val(d.fechaInicio.split('T')[0]);
                    if(d.fechaFin) $('#txtFechaFin').val(d.fechaFin.split('T')[0]);

                    $('#cboTipoCuenta').val(d.tipoCuentaId);
                    $('#txtCuentaCargo').val(d.cuentaCargo);
                    $('#txtCuentaAbono').val(d.cuentaAbono);

                    $('#tituloModal').text('Editar Centro de Costo');
                    $('#modalCentroCosto').modal('show');
                }
            });
        }

        function fct_Guardar() {
            // Validaciones básicas manuales o usar jquery validate
            if ($('#txtCodigo').val() == '' || $('#txtNombre').val() == '') {
                alert('Complete los campos obligatorios');
                return;
            }

            var data = $('#frmCentroCosto').serialize();

            $.post('/CentroCosto/Guardar', data, function (res) {
                if (res.status) {
                    $('#modalCentroCosto').modal('hide');
                    tabla.ajax.reload(); // Recargar tabla
                    $('#arbolCC').jstree(true).refresh(); // Recargar árbol
                    alert(res.message);
                } else {
                    alert(res.message);
                }
            });
        }

        function fct_Eliminar(id) {
            if (confirm('¿Está seguro de eliminar este registro?')) {
                $.post('/CentroCosto/Eliminar', { id: id }, function (res) {
                    if (res.status) {
                        tabla.ajax.reload();
                        $('#arbolCC').jstree(true).refresh();
                        alert(res.message);
                    } else {
                        alert(res.message);
                    }
                });
            }
        }
    </script>
}