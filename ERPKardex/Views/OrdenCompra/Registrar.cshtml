@{
    ViewData["Title"] = "Nueva Orden de Compra";
}

<div class="card d-none" id="efec-cargando">
    <div class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center overlay dark" style="z-index: 9999; background: rgba(0,0,0,0.5);">
        <i class="fas fa-3x fa-sync-alt fa-spin text-white"></i>
    </div>
</div>

<div class="container-fluid py-3">
    <div class="row justify-content-center">
        <div class="col-lg-12">
            <div class="card shadow mb-4 border-left-success">
                <div class="card-header bg-success text-white d-flex justify-content-between">
                    <h5 class="m-0 font-weight-bold"><i class="fas fa-file-invoice-dollar"></i> Generar Orden de Compra</h5>
                    <span class="badge badge-light text-dark align-self-center">Estado: GENERADO</span>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="font-weight-bold text-primary">1. Empresa (Comprador)</label>
                            <select id="cbx_Empresa" class="form-control select2-basic"></select>
                        </div>
                        <div class="col-md-5">
                            <label class="font-weight-bold text-success">2. Proveedor (*)</label>
                            <select id="cbx_Proveedor" class="form-control select2-basic">
                                <option value="">-- Seleccione --</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button class="btn btn-warning btn-block font-weight-bold" onclick="abrirModalPedidos()">
                                <i class="fas fa-search"></i> 3. JALAR PEDIDO
                            </button>
                        </div>
                    </div>

                    <div class="row mb-3 bg-light p-2 rounded">
                        <div class="col-md-3">
                            <label>Fecha Emisión</label>
                            <input type="date" id="txt_FechaEmision" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")" readonly>
                        </div>
                        <div class="col-md-3">
                            <label>Fecha Entrega</label>
                            <input type="date" id="txt_FechaEntrega" class="form-control" value="@DateTime.Now.AddDays(7).ToString("yyyy-MM-dd")">
                        </div>
                        <div class="col-md-3">
                            <label>Moneda</label>
                            <select id="cbx_Moneda" class="form-control form-control"></select>
                        </div>
                        <div class="col-md-3">
                            <label class="small font-weight-bold">Tipo de Cambio (Ref)</label>
                            <input type="text" id="txtTCRef" class="form-control bg-warning text-dark font-weight-bold text-center border-0" readonly placeholder="---">
                            <small class="text-muted d-block mt-1" id="msgTC">Del día seleccionado</small>
                        </div>

                        <div class="col-md-4 mt-2">
                            <label class="d-block mb-1 font-weight-bold text-primary">Condición de Pago</label>
                            <div class="d-flex align-items-center">
                                <div class="custom-control custom-switch mr-3">
                                    <input type="checkbox" class="custom-control-input" id="chk_EsCredito" onchange="toggleCondicionPago()">
                                    <label class="custom-control-label" for="chk_EsCredito">Crédito</label>
                                </div>
                                <div class="input-group input-group-sm" id="div_DiasCredito" style="display: none;">
                                    <input type="number" id="txt_DiasCredito" class="form-control text-center" placeholder="Días" min="1">
                                    <div class="input-group-append">
                                        <span class="input-group-text">días</span>
                                    </div>
                                </div>
                                <span id="lbl_Contado" class="badge badge-success p-2 ml-2">CONTADO</span>
                            </div>
                        </div>

                        <div class="col-md-3 mt-2">
                            <label class="d-block mb-1 font-weight-bold text-dark">Impuesto (IGV)</label>
                            <select id="cbx_TieneIgv" class="form-control font-weight-bold border-dark" onchange="recalcularGlobales()">
                                <option value="1">SI - Más IGV (Nacional)</option>
                                <option value="0">NO - Sin IGV (Importación/Inafecto)</option>
                            </select>
                        </div>
                        <div class="col-md-5"></div>
                    </div>

                    <div class="row mb-2">
                        <div class="col-md-4">
                            <label class="small text-muted">Lugar de Destino</label>
                            <input type="text" id="txt_LugarDestino" class="form-control bg-light" readonly>
                        </div>
                        <div class="col-md-4">
                            <label class="small text-muted">Sucursal Entrega</label>
                            <input type="hidden" id="hdn_SucursalId">
                            <input type="text" id="txt_SucursalNombre" class="form-control bg-light" readonly>
                        </div>
                        <div class="col-md-4">
                            <label class="small text-muted">Almacén Recepción</label>
                            <input type="hidden" id="hdn_AlmacenId">
                            <input type="text" id="txt_AlmacenNombre" class="form-control bg-light" readonly>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <input type="text" id="txt_Observacion" class="form-control" placeholder="Observaciones de la orden...">
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow mb-5">
                <div class="card-header py-2 bg-secondary text-white">
                    <h6 class="m-0 font-weight-bold">Detalle de Productos (Jalados del Pedido)</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped mb-0 text-center" id="tbl_Detalle">
                            <thead class="thead-dark small">
                                <tr>
                                    <th width="3%">#</th>
                                    <th width="30%">Descripción</th>
                                    <th width="5%">U.M.</th>
                                    <th width="10%">C. Costo</th>
                                    <th width="7%">Lugar</th>
                                    <th width="10%">Saldo Ped.</th>
                                    <th width="10%" class="bg-warning text-dark">Cantidad</th>
                                    <th width="10%" class="bg-warning text-dark">V. Unit (Base)</th>
                                    <th width="10%">Subtotal</th>
                                    <th width="5%"></th>
                                </tr>
                            </thead>
                            <tbody id="tbl_Body">
                                <tr><td colspan="10" class="text-muted py-4">Utilice el botón "Jalar Pedido" para cargar ítems.</td></tr>
                            </tbody>
                            <tfoot class="bg-light font-weight-bold">
                                <tr>
                                    <td colspan="6"></td>
                                    <td class="text-right">Subtotal (Base):</td>
                                    <td class="text-right" id="lbl_Subtotal">0.00</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td colspan="6"></td>
                                    <td class="text-right">IGV (18%):</td>
                                    <td class="text-right" id="lbl_Igv">0.00</td>
                                    <td></td>
                                </tr>
                                <tr class="h5 text-success">
                                    <td colspan="6"></td>
                                    <td class="text-right">TOTAL:</td>
                                    <td class="text-right" id="lbl_Total">0.00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <div class="fixed-bottom bg-white border-top p-3 text-right shadow" style="opacity: 0.95;">
                <a href="/OrdenCompra/Index" class="btn btn-danger mr-2">Cancelar</a>
                <button class="btn btn-success px-5" onclick="guardarOrden()">
                    <i class="fas fa-save"></i> GUARDAR ORDEN
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalPedidos" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title font-weight-bold">Pedidos Pendientes</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="tbl_BusquedaPedidos">
                        <thead class="bg-light">
                            <tr>
                                <th>Ver</th>
                                <th>Número</th>
                                <th>Fecha</th>
                                <th>Fecha Necesaria</th>
                                <th>Observación</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modalVistaPrevia" tabindex="-1" role="dialog" style="z-index: 1060;">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content border-primary">
            <div class="modal-header bg-primary text-white py-2">
                <h6 class="modal-title font-weight-bold">
                    <i class="fas fa-list-alt"></i> Contenido del Pedido
                </h6>
                <button type="button" class="close text-white" onclick="$('#modalVistaPrevia').modal('hide')">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0 text-center">
                        <thead class="bg-light text-primary">
                            <tr>
                                <th>Item</th>
                                <th>Producto / Descripción</th>
                                <th>U.M.</th>
                                <th>C. Costo</th>
                                <th>Lugar</th>
                                <th class="text-dark bg-warning" style="width: 120px;">Saldo Pendiente</th>
                            </tr>
                        </thead>
                        <tbody id="tbl_BodyVistaPrevia"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer py-1">
                <button type="button" class="btn btn-sm btn-secondary" onclick="$('#modalVistaPrevia').modal('hide')">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script>
    let LISTA_PRODUCTOS = [];
    let IGV_TASA = 0.18;

    $(document).ready(function() {
        $('.select2-basic').select2({ theme: 'bootstrap4', width: '100%' });
        initCombos();

        $('#cbx_Empresa').on('select2:select', function(){
            LISTA_PRODUCTOS = [];
            renderTabla();
            limpiarInputsHeredados();
        });

        $.get('/TipoCambio/GetTcPorFecha?fecha=' + '@DateTime.Now.ToString("yyyy-MM-dd")', function(res) {
            if (res.status) {
                $('#txtTCRef').val(res.valor.toFixed(3));
                $('#msgTC').html('<i class="fas fa-check text-success"></i> T.C. encontrado').removeClass('text-danger').addClass('text-success');
            } else {
                $('#txtTCRef').val('0.000');
                $('#msgTC').html('<i class="fas fa-exclamation-triangle"></i> ' + res.message).removeClass('text-muted').addClass('text-danger font-weight-bold');
            }
        });
    });

    function toggleCondicionPago() {
        if($('#chk_EsCredito').is(':checked')) {
            $('#div_DiasCredito').show();
            $('#lbl_Contado').hide();
            $('#txt_DiasCredito').focus();
        } else {
            $('#div_DiasCredito').hide();
            $('#lbl_Contado').show();
            $('#txt_DiasCredito').val('');
        }
    }

    function initCombos() {
        $.get('/PedCompra/GetEmpresaData', function(res) {
            if(res.status) {
                let html = '<option value="">-- SELECCIONE --</option>';
                res.data.forEach(x => html += `<option value="${x.id}">${x.ruc} - ${x.razonSocial}</option>`);
                $('#cbx_Empresa').html(html);
            }
        });

        $.get('/OrdenCompra/GetCombosRegistro', function(res) {
            if(res.status) {
                let htmlProv = '<option value="">-- SELECCIONE --</option>';
                res.proveedores.forEach(x => htmlProv += `<option value="${x.id}">${x.tipoDocumentoIdentidad}: ${x.numeroDocumento} - ${x.razonSocial}</option>`);
                $('#cbx_Proveedor').html(htmlProv);

                let htmlMon = '';
                res.monedas.forEach(x => htmlMon += `<option value="${x.id}">${x.nombre}</option>`);
                $('#cbx_Moneda').html(htmlMon);
            }
        });
    }

    function abrirModalPedidos() {
        let empId = $('#cbx_Empresa').val();
        if(!empId) return Swal.fire("Aviso", "Seleccione la Empresa Compradora.", "warning");

        $('#efec-cargando').removeClass('d-none');

        $.get('/OrdenCompra/GetPedidosPendientes?empresaFiltroId=' + empId, function(res) {
            $('#efec-cargando').addClass('d-none');
            let html = '';
            if(res.status && res.data.length > 0) {
                res.data.forEach(p => {
                    html += `<tr>
                        <td class="text-nowrap">
                            <button class="btn btn-sm btn-success mr-1" title="Seleccionar y Jalar" onclick="seleccionarPedido(${p.id})">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-sm btn-info" title="Ver contenido" onclick="verDetallePrevia(${p.id}, '${p.numero}')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                        <td class="font-weight-bold align-middle">${p.numero}</td>
                        <td class="align-middle">${p.fecha}</td>
                        <td class="align-middle text-danger">${p.fechaNecesaria}</td>
                        <td class="align-middle small text-left">${p.observacion || '-'}</td>
                    </tr>`;
                });
            } else {
                html = '<tr><td colspan="5" class="text-center text-muted p-3">No hay pedidos pendientes para esta empresa.</td></tr>';
            }
            $('#tbl_BusquedaPedidos tbody').html(html);
            $('#modalPedidos').modal('show');
        });
    }

    function seleccionarPedido(pedId) {
        $('#modalPedidos').modal('hide');
        $('#efec-cargando').removeClass('d-none');

        $.get('/OrdenCompra/GetCabeceraPedido?pedidoId=' + pedId, function(res) {
            if(res.status && res.data) {
                let d = res.data;
                $('#hdn_SucursalId').val(d.sucursalId);
                $('#txt_SucursalNombre').val(d.sucursalNombre);
                $('#hdn_AlmacenId').val(d.almacenId);
                $('#txt_AlmacenNombre').val(d.almacenNombre);
                $('#txt_LugarDestino').val(d.lugarDestino);
            }
        });

        $.get('/OrdenCompra/GetDetallesPedidoParaOrden?pedidoId=' + pedId, function(res) {
            $('#efec-cargando').addClass('d-none');
            if(res.status) {
                LISTA_PRODUCTOS = res.data.map(d => ({
                    IdReferencia: d.id,
                    ProductoId: d.productoId,
                    Descripcion: d.descripcion,
                    UnidadMedida: d.unidadMedida,
                    CentroCostoId: d.centroCostoId,
                    CentroCostoNombre: d.centroCostoNombre,
                    Lugar: d.lugar,
                    SaldoMaximo: d.saldoDisponible,
                    Cantidad: d.saldoDisponible,
                    PrecioUnitario: 0
                }));
                renderTabla();
                toastr.success("Productos cargados. Ingrese precios.");
            }
        });
    }

    function verDetallePrevia(pedId, numeroPedido) {
        $('#tbl_BodyVistaPrevia').html('<tr><td colspan="6" class="text-center py-3">Cargando detalles...</td></tr>');
        $('#modalVistaPrevia').modal('show');

        $.get('/OrdenCompra/GetDetallesPedidoParaOrden?pedidoId=' + pedId, function(res) {
            if(res.status) {
                let html = '';
                if(res.data.length > 0) {
                    res.data.forEach(d => {
                        html += `<tr>
                            <td class="font-weight-bold">${d.item}</td>
                            <td class="text-left">${d.descripcion}</td>
                            <td>${d.unidadMedida}</td>
                            <td><small>${d.centroCostoNombre}</small></td>
                            <td><small>${d.lugar || '-'}</small></td>
                            <td class="font-weight-bold text-dark bg-warning" style="font-size: 1.1em;">
                                ${d.saldoDisponible.toFixed(2)}
                            </td>
                        </tr>`;
                    });
                } else {
                    html = '<tr><td colspan="6" class="text-center">Este pedido no tiene saldos pendientes.</td></tr>';
                }
                $('#tbl_BodyVistaPrevia').html(html);
            } else {
                toastr.error("No se pudo cargar el detalle.");
                $('#modalVistaPrevia').modal('hide');
            }
        });
    }

    function renderTabla() {
        let html = '';
        LISTA_PRODUCTOS.forEach((item, idx) => {
            html += `<tr>
                <td class="align-middle">${idx + 1}</td>
                <td class="text-left align-middle"><small>${item.Descripcion}</small></td>
                <td class="align-middle">${item.UnidadMedida}</td>
                <td class="align-middle small">${item.CentroCostoNombre}</td>
                <td class="align-middle small">${item.Lugar}</td>
                <td class="align-middle text-muted font-weight-bold">${item.SaldoMaximo.toFixed(2)}</td>
                <td>
                    <input type="number" class="form-control form-control-sm text-center font-weight-bold"
                           value="${item.Cantidad}" min="0.01" max="${item.SaldoMaximo}" step="0.01"
                           onchange="actualizarLinea(${idx}, 'cant', this.value)">
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm text-center"
                           value="${item.PrecioUnitario}" min="0" step="0.01"
                           onchange="actualizarLinea(${idx}, 'precio', this.value)">
                </td>
                <td class="align-middle font-weight-bold" id="td_total_${idx}">
                    ${(item.Cantidad * item.PrecioUnitario).toFixed(2)}
                </td>
                <td class="align-middle">
                    <button class="btn btn-xs btn-danger" onclick="eliminarLinea(${idx})">X</button>
                </td>
            </tr>`;
        });

        if(LISTA_PRODUCTOS.length === 0) html = '<tr><td colspan="10" class="text-muted py-4">Sin productos.</td></tr>';

        $('#tbl_Body').html(html);
        recalcularGlobales();
    }

    function actualizarLinea(idx, tipo, valor) {
        let val = parseFloat(valor) || 0;
        let item = LISTA_PRODUCTOS[idx];

        if(tipo === 'cant') {
            let input = $(`#tbl_Body tr:eq(${idx}) input[type='number']:first`);
            if(val > item.SaldoMaximo) {
                input.addClass('is-warning border-warning text-warning');
                input.attr('title', `Excede el saldo de ${item.SaldoMaximo}`);
                toastr.warning(`El ítem ${item.Descripcion} supera el saldo disponible.`);
            } else {
                input.removeClass('is-warning border-warning text-warning');
                input.removeAttr('title');
            }
            item.Cantidad = val;
        } else {
            item.PrecioUnitario = val;
        }

        $(`#td_total_${idx}`).text((item.Cantidad * item.PrecioUnitario).toFixed(2));
        recalcularGlobales();
    }

    function eliminarLinea(idx) {
        LISTA_PRODUCTOS.splice(idx, 1);
        renderTabla();
    }

    // --- NUEVA LÓGICA: SIEMPRE BASE + IGV ---
    function recalcularGlobales() {
        let tieneIgv = $('#cbx_TieneIgv').val() === "1"; // 1 = Nacional (Base), 0 = Inafecto
        let sumaTotal = 0; // Esta suma ahora es la SUMA DE LAS BASES IMPONIBLES

        LISTA_PRODUCTOS.forEach(x => {
            sumaTotal += (x.Cantidad * x.PrecioUnitario);
        });

        let subtotal = 0;
        let igv = 0;
        let total = 0;

        if (tieneIgv) {
            // CASO A: NACIONAL (Precios Unitarios son BASE)
            // Lógica de "MAS IGV"
            subtotal = sumaTotal;          // La suma de items es el Subtotal
            igv = subtotal * IGV_TASA;     // Calculamos el impuesto
            total = subtotal + igv;        // Sumamos
        } else {
            // CASO B: IMPORTACIÓN / INAFECTO
            // Todo es valor comercial sin impuestos
            subtotal = sumaTotal;
            igv = 0;
            total = subtotal;
        }

        $('#lbl_Subtotal').text(subtotal.toFixed(2));
        $('#lbl_Igv').text(igv.toFixed(2));
        $('#lbl_Total').text(total.toFixed(2));
    }

    function limpiarInputsHeredados() {
        $('#hdn_SucursalId, #txt_SucursalNombre, #hdn_AlmacenId, #txt_AlmacenNombre, #txt_LugarDestino').val('');
    }

    function guardarOrden() {
        if(LISTA_PRODUCTOS.length === 0) return Swal.fire("Error", "No hay productos.", "error");
        if(!$('#cbx_Empresa').val()) return toastr.warning("Seleccione Empresa");
        if(!$('#cbx_Proveedor').val()) return toastr.warning("Seleccione Proveedor");

        let condPagoFinal = "CONTADO";
        if($('#chk_EsCredito').is(':checked')) {
            let dias = $('#txt_DiasCredito').val();
            if(!dias || dias <= 0) return toastr.warning("Ingrese los días de crédito.");
            condPagoFinal = `CRÉDITO A ${dias} DÍAS`;
        }

        let hayExcesos = LISTA_PRODUCTOS.some(p => p.Cantidad > p.SaldoMaximo);
        let mensajeConfirmacion = "¿Registrar Orden de Compra?";
        if (hayExcesos) mensajeConfirmacion = "⚠️ ¡ATENCIÓN! Hay ítems con sobre-atención. ¿Continuar?";

        let cabecera = {
            EmpresaId: parseInt($('#cbx_Empresa').val()),
            ProveedorId: parseInt($('#cbx_Proveedor').val()),
            FechaEmision: $('#txt_FechaEmision').val(),
            FechaEntrega: $('#txt_FechaEntrega').val(),
            MonedaId: parseInt($('#cbx_Moneda').val()),
            TipoCambio: parseFloat($('#txtTCRef').val()),
            CondicionPago: condPagoFinal,
            Observacion: $('#txt_Observacion').val(),

            // Enviamos el flag. 1=True (Nacional), 0=False (Importación)
            IncluyeIgv: ($('#cbx_TieneIgv').val() === "1"),

            SucursalId: $('#hdn_SucursalId').val() ? parseInt($('#hdn_SucursalId').val()) : null,
            AlmacenId: $('#hdn_AlmacenId').val() ? parseInt($('#hdn_AlmacenId').val()) : null,
            LugarDestino: $('#txt_LugarDestino').val()
        };

        let detalles = LISTA_PRODUCTOS.map(x => ({
            TablaReferencia: 'DPEDCOMPRA',
            IdReferencia: x.IdReferencia,
            ProductoId: x.ProductoId,
            Descripcion: x.Descripcion,
            UnidadMedida: x.UnidadMedida,
            CentroCostoId: x.CentroCostoId,
            Lugar: x.Lugar,
            Cantidad: x.Cantidad,
            PrecioUnitario: x.PrecioUnitario
        }));

        Swal.fire({
            title: hayExcesos ? "Confirmar Sobre-atención" : "Confirmar Registro",
            text: mensajeConfirmacion,
            icon: hayExcesos ? "warning" : "question",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            reverseButtons: true,
            cancelButtonText: "Cancelar",
            confirmButtonText: "Sí, Registrar"
        }).then((result) => {
            if (result.isConfirmed) {
                enviarOrdenAlBackend(cabecera, detalles);
            }
        });
    }

    function enviarOrdenAlBackend(cabecera, detalles) {
        $('#efec-cargando').removeClass('d-none');
        $.ajax({
            url: '/OrdenCompra/Guardar',
            type: 'POST',
            data: {
                cabecera: cabecera,
                detallesJson: JSON.stringify(detalles)
            },
            success: function(res) {
                $('#efec-cargando').addClass('d-none');
                if(res.status) {
                    Swal.fire("Éxito", res.message, "success").then(() => {
                        window.location.href = '/OrdenCompra/Index';
                    });
                } else {
                    Swal.fire("Error", res.message, "error");
                }
            },
            error: function() {
                $('#efec-cargando').addClass('d-none');
                toastr.error("Error de conexión");
            }
        });
    }
</script>