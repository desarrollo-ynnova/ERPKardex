@{
    ViewData["Title"] = "Registro de Ingreso/Salida de Almacén";
}

<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-11">
            <div class="card shadow mb-4">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-box-seam"></i> Datos del Movimiento</h5>
                    <span id="lbl_TipoMovimiento" class="badge badge-secondary p-2">TIPO: PENDIENTE</span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3"><label>Empresa</label><select id="cbx_Empresa" class="form-control select2-busqueda"></select></div>
                        <div class="col-md-4 mb-3"><label>Sucursal</label><select id="cbx_Sucursal" class="form-control select2-busqueda"><option value="">-- SELECCIONE EMPRESA --</option></select></div>
                        <div class="col-md-4 mb-3"><label>Almacén</label><select id="cbx_Almacen" class="form-control select2-busqueda"><option value="">-- SELECCIONE SUCURSAL --</option></select></div>
                    </div>
                    <div class="row">
                        <div class="col-md-3 mb-3"><label>Fecha Movimiento</label><input type="date" id="dtp_FechaMov" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")"></div>
                        <div class="col-md-3 mb-3"><label>Número Movimiento</label><input disabled type="text" id="txt_NumeroMov" class="form-control" placeholder="Autogenerado"></div>
                        <div class="col-md-3 mb-3"><label>Motivo</label><select id="cbx_Motivo" class="form-control select2-busqueda"></select></div>
                        <div class="col-md-3 mb-3"><label>Moneda</label><select id="cbx_MonedaCab" class="form-control select2-busqueda"></select></div>
                    </div>
                </div>
            </div>

            <div class="card shadow mb-4 border-left-info">
                <div class="card-header bg-info text-white"><h5 class="mb-0">Documento de Referencia</h5></div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3"><label>Tipo Documento</label><select id="cbx_TipoDoc" class="form-control select2-busqueda"></select></div>
                        <div class="col-md-3 mb-3"><label>Serie</label><input type="text" id="txt_SerieDoc" class="form-control" placeholder="Ej: F001"></div>
                        <div class="col-md-3 mb-3"><label>Número</label><input type="text" id="txt_NumeroDoc" class="form-control" placeholder="Ej: 000123"></div>
                        <div class="col-md-3 mb-3"><label>Fecha Doc.</label><input type="date" id="dtp_FechaDoc" class="form-control"></div>
                    </div>
                </div>
            </div>

            <div class="card shadow mb-4">
                <div class="card-header bg-success text-white"><h5 class="mb-0">Búsqueda y Detalle de Productos</h5></div>
                <div class="card-body bg-light">
                    <div class="row">
                        <div class="col-md-4 mb-3"><label>Filtrar por Grupo</label><select id="cbx_GrupoFiltro" class="form-control select2-busqueda"></select></div>
                        <div class="col-md-4 mb-3"><label>Filtrar por Subgrupo</label><select id="cbx_SubgrupoFiltro" class="form-control select2-busqueda"><option value="">-- SELECCIONE GRUPO --</option></select></div>
                        <div class="col-md-4 mb-3"><label>Producto Final</label><select id="cbx_ProductoBusqueda" class="form-control select2-busqueda"><option value="">-- SELECCIONE SUBGRUPO --</option></select></div>
                    </div>
                    <div class="row align-items-end">
                        <div class="col-md-3 mb-3"><label>U.M.</label><input type="text" id="txt_DetUnidad" class="form-control" readonly></div>
                        <div class="col-md-3 mb-3"><label>Cantidad</label><input type="number" id="txt_DetCantidad" class="form-control" step="0.01" value="0.00"></div>
                        <div class="col-md-3 mb-3"><label>Precio Unit.</label><input type="number" id="txt_DetPrecio" class="form-control" step="0.000001" value="0.000000"></div>
                        <div class="col-md-3 mb-3"><button id="btn_AgregarDetalle" type="button" class="btn btn-primary btn-block"><i class="bi bi-plus-circle"></i> Añadir a Tabla</button></div>
                    </div>
                    <div class="table-responsive mt-4">
                        <table id="tbl_DetalleMovimiento" class="table table-bordered table-striped text-center">
                            <thead class="thead-dark">
                                <tr><th>Item</th><th>Código</th><th>Producto</th><th>Cant.</th><th>U.M.</th><th>Precio</th><th>Subtotal</th><th>Acción</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="text-right mb-5">
                <button id="btn_Cancelar" class="btn btn-danger btn-lg">Cancelar</button>
                <button id="btn_GuardarTodo" class="btn btn-success btn-lg">Guardar Movimiento</button>
            </div>
        </div>
    </div>
</div>

<script>
    var LISTA_DETALLE = [];
    var PRODUCTOS_TEMP = []; // Almacena productos filtrados para obtener U.M.
    var MOTIVOS_FULL = [];

    $(document).ready(function () {
        $('.select2-busqueda').select2({ theme: 'bootstrap4', width: '100%' });
        fct_InitCombos();

        // --- CASCADA CABECERA ---
        $('#cbx_Empresa').on('change', function () {
            let id = $(this).val();
            $('#cbx_Almacen').html('<option value="">-- SELECCIONE SUCURSAL --</option>').trigger('change');

            if (id) {
                // Value: codigo (porque así lo filtras luego), Texto: codigo - nombre
                fct_FillCombo('/IngresoSalidaAlm/GetSucursalesByEmpresa?empresaId=' + id, '#cbx_Sucursal', 'codigo', 'nombre', '-- SELECCIONAR --', 'codigo');
            } else {
                $('#cbx_Sucursal').html('<option value="">-- SELECCIONE EMPRESA --</option>').trigger('change');
            }
        });
        
        $('#cbx_Sucursal').on('change', function () {
            let codSuc = $(this).val();
            let empId = $('#cbx_Empresa').val();

            if (codSuc) {
                // Texto: codigo - nombre (Visualización para el usuario)
                fct_FillCombo(`/IngresoSalidaAlm/GetAlmacenesBySucursal?codSucursal=${codSuc}&empresaId=${empId}`, '#cbx_Almacen', 'id', 'nombre', '-- SELECCIONAR --', 'codigo');
            } else {
                $('#cbx_Almacen').html('<option value="">-- SELECCIONE SUCURSAL --</option>').trigger('change');
            }
        });

        // --- CASCADA PRODUCTOS ---
        $('#cbx_GrupoFiltro').on('change', function () {
            let id = $(this).val();
            if (id) fct_FillCombo('/IngresoSalidaAlm/GetSubgruposByGrupo?codGrupo=' + id, '#cbx_SubgrupoFiltro', 'codigo', 'descripcion', '-- SELECCIONAR --', 'codigo');
            else $('#cbx_SubgrupoFiltro, #cbx_ProductoBusqueda').html('<option value="">-- SELECCIONE GRUPO --</option>').trigger('change');
        });

        $('#cbx_SubgrupoFiltro').on('change', function () {
            let id = $(this).val();
            if (id) {
                $.getJSON('/IngresoSalidaAlm/GetProductosBySubgrupo?codSubgrupo=' + id, function(res){
                    if(res.status){
                        PRODUCTOS_TEMP = res.data;
                        let h = '<option value="">-- SELECCIONAR PRODUCTO --</option>';
                        res.data.forEach(p => h += `<option value="${p.codigo}">${p.codigo} - ${p.descripcionProducto}</option>`);
                        $('#cbx_ProductoBusqueda').html(h).trigger('change');
                    }
                });
            } else $('#cbx_ProductoBusqueda').html('<option value="">-- SELECCIONE SUBGRUPO --</option>').trigger('change');
        });

        $('#cbx_ProductoBusqueda').on('change', function () {
            let p = PRODUCTOS_TEMP.find(x => x.codigo == $(this).val());
            $("#txt_DetUnidad").val(p ? p.codUnidadMedida : "");
        });

        // --- LÓGICA MOTIVO ---
        $('#cbx_Motivo').on('change', function () {
            let m = MOTIVOS_FULL.find(x => x.codigo == $(this).val());
            let b = $("#lbl_TipoMovimiento");
            if (m) {
                if (m.tipoMovimiento) b.text("TIPO: INGRESO").removeClass("badge-secondary badge-danger").addClass("badge-success");
                else b.text("TIPO: SALIDA").removeClass("badge-secondary badge-success").addClass("badge-danger");
            } else b.text("TIPO: PENDIENTE").attr("class", "badge badge-secondary p-2");
        });

        // --- AGREGAR Y GUARDAR ---
        $("#btn_AgregarDetalle").click(function () {
            let cod = $("#cbx_ProductoBusqueda").val();
            let nom = $("#cbx_ProductoBusqueda option:selected").text();
            let can = parseFloat($("#txt_DetCantidad").val());
            let pre = parseFloat($("#txt_DetPrecio").val());
            if (!cod || can <= 0) return toastr.warning("Complete producto y cantidad");

            LISTA_DETALLE.push({
                Item: (LISTA_DETALLE.length + 1).toString().padStart(3, '0'),
                CodProducto: cod, DescripcionProducto: nom, CodUnidadMedida: $("#txt_DetUnidad").val(),
                Cantidad: can, Precio: pre, TipoCambio: 1.0, TipoDocumentoId: $("#cbx_TipoDoc").val(),
                SerieDocumento: $("#txt_SerieDoc").val(), NumeroDocumento: $("#txt_NumeroDoc").val(),
                MonedaId: $("#cbx_MonedaCab").val(), FechaDocumento: $("#dtp_FechaDoc").val()
            });
            fct_RenderDetalle();
            fct_LimpiarInputsDetalle();
        });

        $("#btn_GuardarTodo").click(function () {
            if (LISTA_DETALLE.length === 0) return toastr.error("Detalle vacío");
            let cab = {
                Fecha: $("#dtp_FechaMov").val(), Numero: $("#txt_NumeroMov").val(),
                SucursalId: parseInt($("#cbx_Sucursal").val()), AlmacenId: parseInt($("#cbx_Almacen").val()),
                CodMotivo: $("#cbx_Motivo").val(), FechaDocumento: $("#dtp_FechaDoc").val(),
                TipoDocumentoId: $("#cbx_TipoDoc").val(), SerieDocumento: $("#txt_SerieDoc").val(),
                NumeroDocumento: $("#txt_NumeroDoc").val(), MonedaId: parseInt($("#cbx_MonedaCab").val()),
                EstadoId: 1, EmpresaId: parseInt($("#cbx_Empresa").val())
            };
            $.post("/IngresoSalidaAlm/GuardarMovimiento", { cabecera: cab, detallesJson: JSON.stringify(LISTA_DETALLE) }, function (res) {
                if (res.status) { toastr.success(res.message); location.reload(); }
                else toastr.error(res.message);
            });
        });
    });

    function fct_InitCombos() {
        fct_FillCombo('/IngresoSalidaAlm/GetEmpresas', '#cbx_Empresa', 'id', 'razonSocial', '-- EMPRESA --', 'id');
        fct_FillCombo('/IngresoSalidaAlm/GetMonedaData', '#cbx_MonedaCab', 'id', 'nombre', '-- MONEDA --', 'id');
        fct_FillCombo('/IngresoSalidaAlm/GetTipoDocumentoData', '#cbx_TipoDoc', 'id', 'descripcion', '-- TIPO DOC --', 'codigo');
        fct_FillCombo('/IngresoSalidaAlm/GetGruposData', '#cbx_GrupoFiltro', 'codigo', 'descripcion', '-- GRUPO --', 'codigo');

        $.getJSON('/IngresoSalidaAlm/GetMotivosData', function(res){
            if(res.status){ MOTIVOS_FULL = res.data; let h = '<option value="">-- MOTIVO --</option>'; res.data.forEach(m => h += `<option value="${m.codigo}">${m.codigo} - ${m.descripcion}</option>`); $('#cbx_Motivo').html(h).trigger('change'); }
        });
    }
    
    function fct_FillCombo(url, id, valProp, txtProp, placeholder, extraTextProp = null) {
        $.getJSON(url, function (res) {
            let h = `<option value="">${placeholder}</option>`;
            if (res.status) {
                res.data.forEach(i => {
                    // Si enviamos extraTextProp, mostramos: CODIGO - NOMBRE
                    let display = extraTextProp
                        ? `${i[extraTextProp]} - ${i[txtProp]}`
                        : i[txtProp];

                    h += `<option value="${i[valProp]}">${display}</option>`;
                });
            }
            $(id).html(h).trigger('change');
        });
    }

    function fct_RenderDetalle() {
        let h = "";
        LISTA_DETALLE.forEach((d, i) => h += `<tr><td>${d.Item}</td><td>${d.CodProducto}</td><td>${d.DescripcionProducto}</td><td>${d.Cantidad}</td><td>${d.CodUnidadMedida}</td><td>${d.Precio.toFixed(6)}</td><td>${(d.Cantidad * d.Precio).toFixed(2)}</td><td><button class="btn btn-danger btn-sm" onclick="fct_QuitarDetalle(${i})">X</button></td></tr>`);
        $("#tbl_DetalleMovimiento tbody").html(h);
    }

    function fct_QuitarDetalle(i) { LISTA_DETALLE.splice(i, 1); LISTA_DETALLE.forEach((d, x) => d.Item = (x + 1).toString().padStart(3, '0')); fct_RenderDetalle(); }
    function fct_LimpiarInputsDetalle() { $("#txt_DetCantidad, #txt_DetPrecio").val("0.00"); }
</script>