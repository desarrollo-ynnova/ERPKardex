@{
    ViewData["Title"] = "Registro de Ingreso/Salida de Almacén";
    var empresaIdClaim = User.FindFirst("EmpresaId")?.Value;
    int empresaId = !string.IsNullOrEmpty(empresaIdClaim) ? int.Parse(empresaIdClaim) : 0;
}

<div class="card d-none" id="efec-cargando">
    <div class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center overlay dark" style="z-index: 9999; background: rgba(0,0,0,0.5);">
        <i class="fas fa-3x fa-sync-alt fa-spin text-white"></i>
    </div>
</div>

<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-11">

            <div class="card shadow mb-4">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-box-seam"></i> Datos del Movimiento</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="font-weight-bold">Tipo de movimiento</label>
                            <select id="cbx_TipoMovimiento" class="form-control font-weight-bold">
                                <option value="">-- SELECCIONAR --</option>
                                <option value="1">ENTRADA (Compra/Ingreso)</option>
                                <option value="0">SALIDA (Consumo/Gasto)</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3"><label>Sucursal</label><select id="cbx_Sucursal" class="form-control select2-busqueda"><option value="">-- SELECCIONE EMPRESA --</option></select></div>
                        <div class="col-md-4 mb-3"><label>Almacén</label><select id="cbx_Almacen" class="form-control select2-busqueda"><option value="">-- SELECCIONE SUCURSAL --</option></select></div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3"><label>Fecha Movimiento</label><input type="date" id="dtp_FechaMov" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")"></div>
                        <div class="col-md-8 mb-3"><label>Motivo</label><select id="cbx_Motivo" class="form-control select2-busqueda"></select></div>
                    </div>
                </div>
            </div>

            <div id="div_ContenedorDocumentos">
                <div class="card shadow mb-4 border-left-info" id="div_DocRef">
                    <div class="card-header bg-info text-white"><h5 class="mb-0">Documento de Referencia (Guía Remisión)</h5></div>
                    <div class="card-body">
                        <div class="row" id="div_ProveedorContainer">
                            <div class="col-md-12 mb-3">
                                <label class="font-weight-bold">Proveedor / Entidad</label>
                                <select id="cbx_Proveedor" class="form-control select2-busqueda"></select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-3 mb-3"><label>Fecha Doc.</label><input type="date" id="dtp_FechaDoc" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")"></div>
                            <div class="col-md-9 mb-3"><label>Tipo Documento</label><select id="cbx_TipoDoc" class="form-control select2-busqueda"></select></div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3"><label>Serie</label><input type="text" id="txt_SerieDoc" class="form-control"></div>
                            <div class="col-md-6 mb-3"><label>Número</label><input type="text" id="txt_NumeroDoc" class="form-control"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow mb-4">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Detalle de Productos</h5>
                </div>

                <div class="card-body bg-light">
                    <div id="div_IngresoManual" class="border p-3 rounded bg-white mb-3 shadow-sm">
                        <div class="row">
                            <div class="col-md-12 mb-2"><h6 class="text-muted font-weight-bold border-bottom pb-2">Agregar Item Manualmente</h6></div>
                            <div class="col-md-5 mb-3"><label>Producto</label><select id="cbx_ProductoBusqueda" class="form-control select2-busqueda"></select></div>
                            <div class="col-md-2 mb-3"><label>Stock</label><input type="number" id="txt_StockActual" class="form-control bg-light" readonly></div>
                            <div class="col-md-2 mb-3"><label>U.M.</label><input type="text" id="txt_DetUnidad" class="form-control bg-light" readonly></div>
                            <div class="col-md-3 mb-3"><label>Cantidad</label><input type="number" id="txt_DetCantidad" class="form-control font-weight-bold" value="0.00"></div>
                        </div>

                        <div class="row align-items-end">
                            <div class="col-md-4 mb-3" id="div_InputSalida_CC">
                                <label>Centro de Costo</label><select id="cbx_CentroCosto" class="form-control select2-busqueda"></select>
                            </div>
                            <div class="col-md-4 mb-3" id="div_InputSalida_Act">
                                <label>Actividad</label><select id="cbx_Actividad" class="form-control select2-busqueda"></select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <button id="btn_AgregarDetalle" type="button" class="btn btn-primary btn-block font-weight-bold">
                                    <i class="bi bi-plus-circle"></i> AÑADIR ITEM
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table id="tbl_DetalleMovimiento" class="table table-bordered table-striped text-center table-hover bg-white">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Item</th>
                                    <th>Código</th>
                                    <th>Producto</th>
                                    <th width="15%" class="bg-warning text-dark">Cantidad Real</th>
                                    <th>U.M.</th>
                                    <th class="col-salida">Centro Costo</th>
                                    <th class="col-salida">Actividad</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="text-right mb-5">
                <button id="btn_Cancelar" class="btn btn-secondary btn-lg mr-2">Cancelar</button>
                <button id="btn_GuardarTodo" class="btn btn-success btn-lg font-weight-bold"><i class="fas fa-save"></i> GUARDAR MOVIMIENTO</button>
            </div>
        </div>
    </div>
</div>

<script>
    var LISTA_DETALLE = [];
    var PRODUCTOS_TEMP = [];
    var MOTIVOS_FULL = [];

    $(document).ready(function () {
        $('.select2-busqueda').select2({ theme: 'bootstrap4', allowClear: true });
        fct_InitCombos();

        $('#btn_Cancelar').click(function() { window.location.href = '/IngresoSalidaAlm/Index'; });

        $('#cbx_TipoMovimiento').on('change', function () {
            let tipo = $(this).val();
            if(LISTA_DETALLE.length > 0){
                Swal.fire("Atención", "Al cambiar el tipo de movimiento se limpiará la lista actual.", "warning");
                LISTA_DETALLE = []; fct_RenderDetalle();
            }

            let h = '<option value="">-- MOTIVO --</option>';
            if (tipo !== "") {
                let esIngreso = (tipo === "1");
                let filtrados = MOTIVOS_FULL.filter(x => x.tipoMovimiento === esIngreso);
                filtrados.forEach(m => { h += `<option value="${m.id}">${m.codigo} - ${m.descripcion}</option>`; });
            }
            $('#cbx_Motivo').html(h).trigger('change');

            // CONFIGURACION VISUAL SEGUN TIPO
            if (tipo === "1") { // ENTRADA (Ingreso)
                $('#div_DocRef').removeClass('d-none'); // Muestra Guia y Proveedor
                $('#div_ProveedorContainer').removeClass('d-none'); // Muestra Proveedor

                // Ocultar columnas de costos (Entrada no lleva CC ni Actividad)
                $('.col-salida').addClass('d-none');
                $('#div_InputSalida_CC, #div_InputSalida_Act').addClass('d-none');

            } else if (tipo === "0") { // SALIDA
                $('#div_DocRef').addClass('d-none'); // Salida interna no suele llevar Guia de proveedor

                // Mostrar columnas de costos
                $('.col-salida').removeClass('d-none');
                $('#div_InputSalida_CC, #div_InputSalida_Act').removeClass('d-none');
            } else {
                 // Si no selecciona nada
                 $('.col-salida').removeClass('d-none');
            }
        });

        // Cascadas
        let empresaId = @empresaId;
        if (empresaId) fct_FillCombo('/IngresoSalidaAlm/GetSucursalesByEmpresa?empresaId=' + empresaId, '#cbx_Sucursal', 'id', 'nombre', '-- SELECCIONAR --', 'codigo');

        $('#cbx_Sucursal').on('change', function () {
            let sucId = $(this).val();
            if (sucId) fct_FillCombo(`/IngresoSalidaAlm/GetAlmacenesBySucursal?sucursalId=${sucId}&empresaId=${empresaId}`, '#cbx_Almacen', 'id', 'nombre', '-- SELECCIONAR --', 'codigo');
            else $('#cbx_Almacen').html('<option value="">-- SELECCIONE SUCURSAL --</option>').trigger('change');
        });

        $.getJSON('/IngresoSalidaAlm/GetProductos', function(res){
            if(res.status){ PRODUCTOS_TEMP = res.data; let h = '<option value="">-- PRODUCTO --</option>'; res.data.forEach(p => h += `<option value="${p.id}">${p.codigo} - ${p.descripcionComercial}</option>`); $('#cbx_ProductoBusqueda').html(h); }
        });

        $('#cbx_ProductoBusqueda').on('change', function () {
            let p = PRODUCTOS_TEMP.find(x => x.id == $(this).val());
            $("#txt_DetUnidad").val(p ? p.codUnidadMedida : "");
            if($('#cbx_Almacen').val() && $(this).val()){
                $.getJSON('/IngresoSalidaAlm/GetStockProductoAlmacen', { almacenId: $('#cbx_Almacen').val(), productoId: $(this).val() }, function (r) { if (r.status) $('#txt_StockActual').val(r.data); });
            }
        });

        $("#btn_AgregarDetalle").click(function () {
            let tipoMov = $('#cbx_TipoMovimiento').val();
            if(tipoMov === "") return toastr.warning("Seleccione primero el Tipo de Movimiento");

            let id = $("#cbx_ProductoBusqueda").val();
            let can = parseFloat($("#txt_DetCantidad").val());

            if (!id || isNaN(can) || can <= 0) return toastr.warning("Producto y cantidad obligatorios");

            let prod = PRODUCTOS_TEMP.find(x => x.id == id);
            let ccId = $("#cbx_CentroCosto").val();
            let actId = $("#cbx_Actividad").val();

            // VALIDACION: Solo pedimos CC y Actividad si es SALIDA (0)
            let nombreCC = "";
            let nombreAct = "";

            if(tipoMov === "0") { // Salida
                if(!ccId || !actId) return toastr.warning("Centro de Costo y Actividad son obligatorios para SALIDAS.");
                nombreCC = $("#cbx_CentroCosto option:selected").text();
                nombreAct = $("#cbx_Actividad option:selected").text();
            } else {
                // Entrada: Limpiamos por si acaso, no se guardan
                ccId = null; actId = null;
            }

            LISTA_DETALLE.push({
                Item: (LISTA_DETALLE.length + 1).toString().padStart(3, '0'),
                ProductoId: id, CodProducto: prod.codigo, DescripcionProducto: prod.descripcionComercial, CodUnidadMedida: $("#txt_DetUnidad").val(),
                Cantidad: can,
                CentroCostoId: ccId, NombreCentroCosto: nombreCC,
                ActividadId: actId, NombreActividad: nombreAct,
                IdReferencia: null, TablaReferencia: null
            });
            fct_RenderDetalle(); $("#txt_DetCantidad").val("0.00");
            // Opcional: Limpiar producto para agilizar siguiente carga
            // $("#cbx_ProductoBusqueda").val('').trigger('change');
        });

        $("#btn_GuardarTodo").click(function () {
            if (LISTA_DETALLE.length === 0) return toastr.error("Detalle vacío, agregue productos.");
            let tipoMov = $('#cbx_TipoMovimiento').val();
            if(!tipoMov) return toastr.error("Seleccione tipo de movimiento");

            let cab = {
                Fecha: $("#dtp_FechaMov").val(),
                TipoMovimiento: (tipoMov === "1"), // true = Entrada, false = Salida
                SucursalId: parseInt($("#cbx_Sucursal").val()),
                AlmacenId: parseInt($("#cbx_Almacen").val()),
                MotivoId: $("#cbx_Motivo").val(),

                // Proveedor ahora viene del combo en la sección de Guía
                ProveedorId: $("#cbx_Proveedor").val() ? parseInt($("#cbx_Proveedor").val()) : null,

                FechaDocumento: $("#dtp_FechaDoc").val(),
                TipoDocumentoId: $("#cbx_TipoDoc").val(),
                SerieDocumento: $("#txt_SerieDoc").val(),
                NumeroDocumento: $("#txt_NumeroDoc").val(),

                // CAMPOS DE VALORIZACIÓN EN NULL (Se hará en otro módulo)
                MonedaId: null, // Opcional, o puedes poner moneda base por defecto
                IdReferencia: null,
                TablaReferencia: null
            };

            // Validaciones básicas de cabecera
            if(!cab.SucursalId || !cab.AlmacenId || !cab.MotivoId) return toastr.warning("Complete los datos de almacén y motivo.");
            if(tipoMov === "1" && !cab.ProveedorId) return toastr.warning("Para ingresos, debe seleccionar el Proveedor.");

            Swal.fire({ title: "¿Guardar Movimiento?", text: "Se actualizará el stock inmediatamente.", icon: "question", showCancelButton: true, confirmButtonText: "Sí, Guardar" })
            .then((result) => {
                if (result.isConfirmed) {
                    $('#efec-cargando').removeClass('d-none');
                    $.ajax({
                        url: "/IngresoSalidaAlm/GuardarMovimiento", type: "POST",
                        data: { cabecera: cab, detallesJson: JSON.stringify(LISTA_DETALLE) },
                        success: function (res) {
                            $('#efec-cargando').addClass('d-none');
                            if (res.status) { Swal.fire("Éxito", res.message, "success").then(() => location.reload()); }
                            else { Swal.fire("Error", res.message, "error"); }
                        },
                        error: function () { $('#efec-cargando').addClass('d-none'); toastr.error("Error de servidor"); }
                    });
                }
            });
        });
    });

    function fct_RenderDetalle() {
        let h = "";
        let esEntrada = ($('#cbx_TipoMovimiento').val() === "1");
        LISTA_DETALLE.forEach((d, i) => {
            h += `<tr><td class="align-middle">${d.Item}</td><td class="align-middle">${d.CodProducto}</td><td class="align-middle text-left">${d.DescripcionProducto}</td>
                <td class="align-middle"><input type="number" class="form-control form-control-sm text-center font-weight-bold ${esEntrada ? 'border-success' : 'border-primary'}" value="${d.Cantidad}" min="0" step="0.01" onchange="actualizarCantidad(${i}, this.value)"></td>
                <td class="align-middle">${d.CodUnidadMedida}</td>`;

            // Renderizado condicional de columnas CC y Actividad
            if (!esEntrada) {
                h += `<td class="align-middle">${d.NombreCentroCosto}</td><td class="align-middle">${d.NombreActividad}</td>`;
            } else {
                // Mantenemos las celdas ocultas para no romper la estructura de la tabla si el CSS falla
                h += `<td class="d-none"></td><td class="d-none"></td>`;
            }

            h += `<td class="align-middle"><button class="btn btn-outline-danger btn-sm" onclick="fct_QuitarDetalle(${i})"><i class="fas fa-trash"></i></button></td></tr>`;
        });
        $("#tbl_DetalleMovimiento tbody").html(h);
    }

    function actualizarCantidad(index, valor) { let val = parseFloat(valor); if(val >= 0) LISTA_DETALLE[index].Cantidad = val; else { toastr.warning("Cantidad inválida"); fct_RenderDetalle(); } }
    function fct_QuitarDetalle(i) { LISTA_DETALLE.splice(i, 1); LISTA_DETALLE.forEach((d, x) => d.Item = (x + 1).toString().padStart(3, '0')); fct_RenderDetalle(); }

    function fct_InitCombos() {
        fct_FillCombo('/IngresoSalidaAlm/GetTipoDocumentoData', '#cbx_TipoDoc', 'id', 'descripcion', '-- TIPO DOC --', 'codigo');
        $.getJSON('/IngresoSalidaAlm/GetMotivosData', function(res){ if(res.status){ MOTIVOS_FULL = res.data; } });
        fct_FillCombo('/IngresoSalidaAlm/GetCentrosCosto', '#cbx_CentroCosto', 'id', 'nombre', '-- SELECCIONAR --', 'codigo');
        fct_FillCombo('/IngresoSalidaAlm/GetActividades', '#cbx_Actividad', 'id', 'nombre', '-- SELECCIONAR --', 'codigo');
        cargarComboEntidades();
    }
    function cargarComboEntidades() { $.get('/IngresoSalidaAlm/GetProveedores', function (res) { let ops = '<option value="">-- Seleccione --</option>'; if(res.status) res.data.forEach(i => ops += `<option value="${i.id}">${i.tipoDocumentoIdentidad}: ${i.numeroDocumento} - ${i.razonSocial}</option>`); $('#cbx_Proveedor').html(ops); }); }
    function fct_FillCombo(url, id, val, txt, ph, extra) { $.getJSON(url, function (res) { let h = `<option value="">${ph}</option>`; if (res.status) res.data.forEach(i => h += `<option value="${i[val]}">${extra ? i[extra] + ' - ' : ''}${i[txt]}</option>`); $(id).html(h); }); }
</script>